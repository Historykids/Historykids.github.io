<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- Google tag (gtag.js) → 1回だけ読み込み、2プロパティへ送信 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EZP12GC8W1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-EZP12GC8W1');  // プロパティ1
    gtag('config', 'G-6Z9WN4HFK5');  // プロパティ2
  </script>

  <!-- AdSense（1回だけ） -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4922140858632050" crossorigin="anonymous"></script>

  <!-- 構造化データ（WebSite） -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebSite",
    "name":"歴史キッズ",
    "url":"https://historykids.github.io/",
    "inLanguage":"ja"
  }
  </script>

  <!-- 構造化データ（FAQ） -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"FAQPage",
    "inLanguage":"ja",
    "mainEntity":[
      {"@type":"Question","name":"対象は小学生ですか？","acceptedAnswer":{"@type":"Answer","text":"はい。ですが、年少〜小学校低学年、中学生でも遊びながら歴史に親しめるように、ひらがなクイズや図鑑（年表）でやさしく学べます。"}},
      {"@type":"Question","name":"無料で使えますか？","acceptedAnswer":{"@type":"Answer","text":"無料で利用できます。サイト下部に広告が表示されます。"}},
      {"@type":"Question","name":"どんな学習内容がありますか？","acceptedAnswer":{"@type":"Answer","text":"江戸時代・戦国時代・室町時代・鎌倉時代の主要な出来事を、年と出来事を結びつけるクイズ、年表の拡張表示、カード収集と街づくり演出で学べます。"}},
      {"@type":"Question","name":"自由研究に使えますか？","acceptedAnswer":{"@type":"Answer","text":"はい。歴史人物や年表をまとめて自由研究や調べ学習に活用できます。"}},
      {"@type":"Question","name":"戦国時代や幕末も学べますか？","acceptedAnswer":{"@type":"Answer","text":"現在は江戸・戦国・室町・鎌倉に対応しています。幕末の追加も準備中です。"}},
      {"@type":"Question","name":"スマホやタブレットでも使えますか？","acceptedAnswer":{"@type":"Answer","text":"はい。縦画面・1画面で遊べるよう最適化しています。"}}
    ]
  }
  </script>

  <!-- Search Console 所有権 -->
  <meta name="google-site-verification" content="bgJFyYeBgPsces8Rz5ONG_d-nj8ZEH_fHddcwAXMX0U" />

  <meta charset="UTF-8" />
  <!-- アクセシビリティのためズーム制限を撤廃 -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- SEO -->
  <title>歴史キッズ｜小学生・中学生向け歴史学習サイト（江戸・戦国・室町・鎌倉）クイズ／年表／カードで町づくり！</title>
  <meta name="description" content="歴史キッズは小学生・中学生向けの歴史学習サイト。江戸・戦国・室町・鎌倉の出来事をクイズ／年表／カード集めの街づくりで楽しく学べます。スマホ対応・無料。">
  <link rel="canonical" href="https://historykids.github.io/">

  <!-- OGP -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://historykids.github.io/" />
  <meta property="og:title" content="楽しく学べる！小学生・中学生向け歴史学習サイト｜歴史キッズ" />
  <meta property="og:description" content="江戸・戦国・室町・鎌倉の出来事をカードを集めながら学べる、子供向けの歴史学習サイト。遊びながら歴史に親しもう！" />
  <meta property="og:image" content="https://historykids.github.io/thumbnail.png" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="楽しく学べる！小学生・中学生向け歴史学習サイト｜歴史キッズ" />
  <meta name="twitter:description" content="江戸・戦国・室町・鎌倉の出来事をカードを集めながら学べる、子供向けの歴史学習サイト。" />
  <meta name="twitter:image" content="https://historykids.github.io/thumbnail.png" />

  <style>
  :root{
    --edo-yellow:#FCD34D; --edo-info:#FFF8DC; --edo-border:#999;
    --bg:#FFF6E3; --shadow:rgba(0,0,0,.12); --ink:#222; --adbg:#f1f1f1;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
      "Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;
  }
  h2{ font-size:clamp(18px,3.5vw,22px); line-height:1.3; }

  .wrap{display:flex;flex-direction:column;min-height:100svh;}
  header{
    position:sticky;top:0;z-index:3;
    background:linear-gradient(180deg,var(--edo-yellow),#fde68a);
    padding:10px 12px;display:flex;gap:8px;align-items:center;justify-content:space-between;
    box-shadow:0 1px 4px var(--shadow);flex-wrap:wrap;
  }
  header h1.siteTitle{
    flex:1 1 100%;font-size:clamp(16px,2.6vw,22px);line-height:1.2;margin:0 0 6px 0;
    overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
  }
  header .controls{width:100%;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  header button, header select{
    border:0;border-radius:10px;background:#fff;padding:6px 12px;
    font-weight:700;box-shadow:0 1px 3px var(--shadow);cursor:pointer
  }
  #resetBtn{background:#ffeaea}

  #intro{padding:10px 12px;background:#fff;}
  #info{
    padding:10px;background:var(--edo-info);border-bottom:1px solid #ccc;
    font-size:15px;min-height:40px
  }
  #town{
    position:relative;width:100%;
    height:clamp(260px, 44vh, 520px); /* モバイル優先 */
    background:#fff;border-top:2px solid var(--edo-border);border-bottom:2px solid var(--edo-border);overflow:hidden
  }
  /* PCで少し広めに */
  @media (min-width: 1024px){
    #town{ height:clamp(320px, 50vh, 640px); }
  }

  /* カードエリア：モバイル優先のGrid、PCで列数UP */
  #cards{
    display:grid;gap:10px;padding:10px;
    grid-template-columns:repeat(auto-fill, minmax(92px, 1fr));
  }
  @media (min-width: 768px){
    #cards{ grid-template-columns:repeat(auto-fill, minmax(120px, 1fr)); }
  }
  .card{
    height:120px;border-radius:12px;background:#ddd;
    display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;
    cursor:pointer;box-shadow:0 2px 6px var(--shadow);user-select:none;text-align:center;padding:6px;
    transition:transform .2s, box-shadow .2s
  }
  .card:hover{transform:scale(1.03);box-shadow:0 4px 12px var(--shadow)}
  .card.done{background:#cdeccd;color:#1a5e1a} /* ← 重複は削除済み */

  .building{position:absolute;font-size:34px;opacity:0;transform:scale(.8);transition:opacity .7s, transform .7s}
  .show{opacity:1;transform:scale(1.2)}
  .villager{position:absolute;font-size:20px;animation:walk 8s linear infinite}
  @keyframes walk{0%{left:2%}50%{left:90%}100%{left:2%}}

  #zukanPanel{position:fixed;inset:0 0 auto 0;height:72%;top:-100%;background:#fff;
    border-bottom:3px solid #333;box-shadow:0 4px 16px var(--shadow);
    transition:top .45s ease;z-index:5;overflow:auto}
  #zukanPanel.active{top:0}
  #zukanHead{position:sticky;top:0;background:#fff;padding:10px;border-bottom:1px solid #eee;
    display:flex;align-items:center;gap:8px}
  #zukanHead h2{margin:0;font-size:18px}
  #closeZukan{margin-left:auto;border:0;background:#eee;border-radius:8px;padding:6px 12px;cursor:pointer}
  .zukanSec{padding:10px}
  .zukanSec h3{margin:8px 0}
  .zCard{display:inline-flex;align-items:center;justify-content:center;width:96px;height:116px;margin:4px;
    border:1px solid #ccc;border-radius:8px;box-shadow:0 1px 3px var(--shadow);white-space:pre-line;text-align:center;padding:6px}
  .locked{background:#eee;color:#999}
  #completeMsg{font-size:18px;font-weight:800;color:green;text-align:center;padding:10px}

  .petal{position:fixed;top:-10px;font-size:20px;animation:fall linear forwards;pointer-events:none}
  @keyframes fall{to{transform:translateY(110vh) rotate(360deg);opacity:0}}

  .adbar{position:sticky;bottom:0;background:var(--adbg);border-top:1px solid #ddd;
    padding:4px 8px;display:flex;justify-content:center;align-items:center;min-height:52px}
  .adslot{width:100%;max-width:728px;height:50px;background:
    repeating-linear-gradient(45deg,#eee,#eee 8px,#e2e2e2 8px,#e2e2e2 16px);
    border:1px dashed #bbb;border-radius:8px;display:flex;align-items:center;justify-content:center;
    font-size:12px;color:#666}
  footer{height:8px}

  .landscapeWarn{
    position:fixed;inset:0;background:rgba(0,0,0,.65);color:#fff;display:none;
    align-items:center;justify-content:center;z-index:20;text-align:center;padding:20px
  }
  /* 小画面の横向きだけ警告。PCは表示しない */
  @media (orientation:landscape) and (max-width: 768px){ .landscapeWarn{display:flex} }

  ruby rt{font-size:.7em;color:#444}
  .yr{font-weight:800;margin-right:2px}

  /* モーション弱め設定に配慮 */
  @media (prefers-reduced-motion: reduce){
    .card:hover{transform:none}
    .building,.petal{transition:none;animation:none}
  }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <h1 class="siteTitle">歴史キッズ｜楽しく学べる！小学生・中学生向け歴史学習サイト</h1>

    <div class="controls">
      <label for="eraSelect" style="font-size:12px">時代：</label>
      <select id="eraSelect" title="時代をえらぶ">
        <option value="edo">江戸時代</option>
        <option value="muromachi">室町時代</option>
        <option value="kamakura">鎌倉時代</option>
        <option value="sengoku">戦国時代</option>
      </select>

      <select id="chapterFilter" title="章をえらぶ">
        <option value="ALL">章：ぜんぶ</option>
      </select>

      <button id="zukanBtn" aria-controls="zukanPanel" aria-expanded="false">図鑑</button>
      <button id="resetBtn" title="進捗を全部消して最初から">リセット</button>
    </div>
  </header>

  <section id="intro">
    <p style="margin:0 0 8px;">
      小学生・中学生向けの<span style="font-weight:700;">歴史学習サイト</span>です。<br>
      <b>江戸・戦国・室町・鎌倉</b>の出来事を、<b>クイズ</b>と<b>年表</b>、<b>カード集め</b>で楽しく学べます（スマホ対応・無料）。
    </p>
    <h2>戦国時代の歴史を勉強できるクイズ</h2>
    <h2>江戸時代の歴史を勉強できるクイズ</h2>
    <h2>室町時代の歴史を勉強できるクイズ</h2>
    <h2>鎌倉時代の歴史を勉強できるクイズ</h2>
    <h2>年表・図鑑で歴史人物をチェック</h2>
    <h2>自由研究やテスト勉強にも役立つ</h2>

    <nav style="display:flex;gap:8px;flex-wrap:wrap;">
      <a href="#cards" id="playEdo" style="display:inline-block;background:#fcd34d;padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none;color:#222;">江戸時代で遊ぶ</a>
      <a href="#cards" id="playSengoku" style="display:inline-block;background:#f6d5a4;padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none;color:#222;">戦国時代で遊ぶ</a>
      <a href="#cards" id="playMuromachi" style="display:inline-block;background:#fde68a;padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none;color:#222;">室町時代で遊ぶ</a>
      <a href="#cards" id="playKamakura" style="display:inline-block;background:#f9e2af;padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none;color:#222;">鎌倉時代で遊ぶ</a>
      <a href="#zukanPanel" id="openZukan" style="display:inline-block;background:#e5e7eb;padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none;color:#111;">図鑑（年表）を見る</a>
    </nav>
  </section>

  <!-- PR：おすすめの本（ドラえもん） -->
  <div class="promoBar" role="note" aria-label="おすすめの本（PR）" style="background:#fffbe6;border-bottom:1px solid #e6d400;padding:8px 12px;display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap;box-shadow:0 1px 3px rgba(0,0,0,.08);">
    <b style="color:#b58900;">PR</b>
    <span class="title" style="font-weight:700;">歴史入門にぴったり！<strong>ドラえもんの社会科おもしろ攻略 日本の歴史</strong>（小学館）</span>
    <a id="promoLink" class="button"
       href="https://amzn.asia/d/bu7qdsv"
       target="_blank" rel="noopener sponsored nofollow"
       style="display:inline-block;background:#ffd814;color:#111;padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none;box-shadow:0 1px 3px rgba(0,0,0,.15);">
       Amazonで見る
    </a>
    <small style="color:#666;">※当サイトはアフィリエイト広告を利用しています</small>
  </div>

  <div id="info" role="status" aria-live="polite">時代をえらんでカードをめくろう！ 〇の部分だけを「ひらがな」で答えると開くよ。</div>
  <div id="town" role="img" aria-label="町エリア"></div>
  <div id="cards" aria-label="カードエリア"></div>

  <section id="zukanPanel" aria-hidden="true">
    <div id="zukanHead">
      <h2>カード図鑑（章ごと）</h2>
      <button id="closeZukan" aria-label="図鑑をとじる">とじる</button>
    </div>
    <div id="zukanList"></div>
    <div id="completeMsg"></div>
  </section>

  <!-- 下部の固定バナー枠（必要なら中身を ad ユニットに差し替え） -->
  <div class="adbar" aria-label="広告枠">
    <div class="adslot">広告スペース（<ins class="adsbygoogle">…</ins> を入れる場所）</div>
  </div>
  <footer aria-hidden="true"></footer>
</div>

<div class="landscapeWarn">縦向きで遊んでね🔄</div>

<!-- クイズ用モーダル（簡易スタイルはインラインで） -->
<div id="quizModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:30">
  <div class="modal-bg" id="quizBg" style="position:absolute;inset:0;background:rgba(0,0,0,.5)"></div>
  <div class="modal-box" style="position:relative;z-index:1;width:min(92vw,560px);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:14px">
    <div id="quizTitle" class="quiz-title" style="font-weight:800;font-size:16px;margin:0 0 6px 0"></div>
    <p class="quiz-instruction" style="font-size:14px;margin:6px 0 10px 0;color:#444">
      〇のところだけを <b>ひらがな</b> でこたえてね。<br>
      空欄がいくつかあるときは <b>スペース / ・ / 、 / ／</b> で区切ってOK。
      <span id="quizHint" style="color:#666"></span>
    </p>
    <input id="quizInput" type="text" inputmode="text" autocomplete="off"
           placeholder="ここに ひらがな を入力（例：てんぽう）"
           style="width:100%;padding:10px 12px;font-size:16px;border:1px solid #ccc;border-radius:10px" />
    <div class="quiz-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="quizCancel" style="border:0;border-radius:10px;padding:8px 14px;background:#eee;cursor:pointer;box-shadow:0 1px 3px var(--shadow);transition:background .2s, transform .2s">やめる</button>
      <button id="quizOk" style="border:0;border-radius:10px;padding:8px 14px;background:#cdeccd;color:#145f14;font-weight:700;cursor:pointer;box-shadow:0 1px 3px var(--shadow);transition:background .2s, transform .2s">決定</button>
    </div>
  </div>
</div>

<script>
/* =========================================================
   データセット（江戸／室町／鎌倉／戦国）
   - 1401 勘合貿易の〇は現状維持
   - 表示のルビは ruby マップ側で付与（キーはプレーンテキスト）
   ========================================================= */
const dataSets = {
  /* ---------- 江戸時代 ---------- */
  edo: {
    title: "江戸時代",
    LS_KEY: "cards_edo_complete_v1",
    chapters: {
      "初期": {
        "1603 〇〇幕府がはじまる": { text: "家康が将軍になり、江戸で国の中心が動き出す。", icon: "🏯", year: 1603 },
        "1615 〇〇〇〇の陣":       { text: "大きなたたかいが終わり、豊臣の時代に幕。", icon: "⚔️", year: 1615 },
        "1635 〇〇〇〇交代":          { text: "大名は国と江戸を行き来するきまりに。", icon: "🚶", year: 1635 },
        "1637 島〇〇・天〇〇の乱":  { text: "九州で大きな一揆が起きる。", icon: "🔥", year: 1637 },
        "1639 〇〇〇〇〇船の来航禁止": { text: "外国船の出入りをしめて、交流をせいげん。", icon: "⛵", year: 1639 },
        "1641 〇〇〇での貿易":      { text: "オランダ商館が長崎の出島へ。", icon: "🏝️", year: 1641 },
        "1657 〇〇〇〇の大火":      { text: "江戸の町が大火事。町づくりを立て直す。", icon: "🔥", year: 1657 },
        "1657 〇〇〇〇〇〇へ移転":  { text: "遊郭が浅草千束の新しい場所へ。", icon: "🏮", year: 1657 }
      },
      "中期": {
        "1688 〇〇〇〇文化がさかえる": { text: "町人の文化が花ひらく。歌舞伎や浮世絵が人気。", icon: "🎭", year: 1688 },
        "1716 〇〇〇〇の改革":         { text: "吉宗がくらしと財政を立て直す工夫をはじめる。", icon: "📜", year: 1716 },
        "1720 〇〇〇〇をとりいれる":   { text: "海外の学びが広がり、知識がふえる。", icon: "📚", year: 1720 },
        "1720 〇〇〇〇〇のしくみ":     { text: "火事にそなえる町人の組ができる。", icon: "🚒", year: 1720 },
        "1730 〇〇のながれを整える":   { text: "商いのきまりをととのえ、町を元気に。", icon: "🧺", year: 1730 },
        "1775 〇〇〇の時代":           { text: "商いを活かす政治でお金の流れをよくする試み。", icon: "💹", year: 1775 },
        "1783 〇〇〇〇のききん":       { text: "寒さや不作で食べ物がたりなくなる。", icon: "🌾", year: 1783 }
      },
      "幕末": {
        "1787 〇〇〇〇の改革":         { text: "くらしをひきしめ、教育も大切にする方針。", icon: "📝", year: 1787 },
        "1825 〇〇〇〇〇打払令":       { text: "近づく外国船を追いはらうきまり。", icon: "📣", year: 1825 },
        "1837 〇〇〇〇〇〇〇〇〇〇の乱": { text: "大阪で人びとの苦しさが爆発。", icon: "⚠️", year: 1837 },
        "1841 〇〇〇〇の改革":           { text: "町の決まりを見直し、ぜいたくをおさえる。", icon: "📏", year: 1841 },
        "1853 〇〇〇〇が来る":         { text: "アメリカの船が浦賀に来航。", icon: "⛴️", year: 1853 },
        "1854 〇〇〇条約":             { text: "日本は港を開き、交流をはじめる。", icon: "🤝", year: 1854 },
        "1858 〇〇〇〇の条約":         { text: "いくつかの国とむすび、貿易が広がる。", icon: "🌐", year: 1858 },
        "1858 〇〇〇〇の大獄":         { text: "意見のちがいで多くの人が処罰される。", icon: "⚖️", year: 1858 },
        "1860 〇〇〇〇〇〇〇〇の変":   { text: "政治の対立が事件に。", icon: "🗡️", year: 1860 },
        "1867 〇〇〇〇奉還":           { text: "政（まつりごと）を朝廷にお返し。", icon: "🗝️", year: 1867 },
        "1868 〇〇〇へ":               { text: "新しい時代のスタート！", icon: "🌸", year: 1868 }
      }
    },
    ruby: {
      "1603 〇〇幕府がはじまる": "〇〇<ruby>幕府<rt>ばくふ</rt></ruby>がはじまる",
      "1615 〇〇〇〇の陣": "〇〇〇〇の<ruby>陣<rt>じん</rt></ruby>",
      "1635 〇〇〇〇交代": "〇〇〇〇<ruby>交代<rt>こうたい</rt></ruby>",
      "1637 島〇〇・天〇〇の乱": "島〇〇・天〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1639 〇〇〇〇〇船の来航禁止": "〇〇〇〇〇<ruby>船<rt>せん</rt></ruby>の<ruby>来航<rt>らいこう</rt></ruby><ruby>禁止<rt>きんし</rt></ruby>",
      "1641 〇〇〇での貿易": "〇〇〇での<ruby>貿易<rt>ぼうえき</rt></ruby>",
      "1657 〇〇〇〇の大火": "〇〇〇〇の<ruby>大火<rt>たいか</rt></ruby>",
      "1657 〇〇〇〇〇〇へ移転": "〇〇〇〇〇〇へ<ruby>移転<rt>いてん</rt></ruby>",
      "1688 〇〇〇〇文化がさかえる": "〇〇〇〇<ruby>文化<rt>ぶんか</rt></ruby>がさかえる",
      "1716 〇〇〇〇の改革": "〇〇〇〇の<ruby>改革<rt>かいかく</rt></ruby>",
      "1720 〇〇〇〇をとりいれる": "〇〇〇〇をとりいれる",
      "1720 〇〇〇〇〇のしくみ": "〇〇〇〇〇のしくみ",
      "1730 〇〇のながれを整える": "〇〇のながれを<ruby>整える<rt>ととのえる</rt></ruby>",
      "1775 〇〇〇の時代": "〇〇〇の<ruby>時代<rt>じだい</rt></ruby>",
      "1783 〇〇〇〇のききん": "〇〇〇〇のききん",
      "1787 〇〇〇〇の改革": "〇〇〇〇の<ruby>改革<rt>かいかく</rt></ruby>",
      "1825 〇〇〇〇〇打払令": "〇〇〇〇〇<ruby>打払令<rt>うちはらいれい</rt></ruby>",
      "1837 〇〇〇〇〇〇〇〇〇〇の乱": "〇〇〇〇〇〇〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1841 〇〇〇〇の改革": "〇〇〇〇の<ruby>改革<rt>かいかく</rt></ruby>",
      "1853 〇〇〇〇が来る": "〇〇〇〇が<ruby>来<rt>く</rt></ruby>る",
      "1854 〇〇〇条約": "〇〇〇<ruby>条約<rt>じょうやく</rt></ruby>",
      "1858 〇〇〇〇の条約": "〇〇〇〇の<ruby>条約<rt>じょうやく</rt></ruby>",
      "1858 〇〇〇〇の大獄": "〇〇〇〇の<ruby>大獄<rt>たいごく</rt></ruby>",
      "1860 〇〇〇〇〇〇〇〇の変": "〇〇〇〇〇〇〇〇の<ruby>変<rt>へん</rt></ruby>",
      "1867 〇〇〇〇奉還": "〇〇〇〇<ruby>奉還<rt>ほうかん</rt></ruby>",
      "1868 〇〇〇へ": "〇〇〇へ"
    },
    blanks: {
      "1603 〇〇幕府がはじまる": ["えど"],
      "1615 〇〇〇〇の陣": ["おおさか"],
      "1635 〇〇〇〇交代": ["さんきん"],
      "1637 島〇〇・天〇〇の乱": ["ばら","くさ"],
      "1639 〇〇〇〇〇船の来航禁止": ["ぽるとがる"],
      "1641 〇〇〇での貿易": ["でじま"],
      "1657 〇〇〇〇の大火": ["めいれき"],
      "1657 〇〇〇〇〇〇へ移転": ["しんよしわら"],
      "1688 〇〇〇〇文化がさかえる": ["げんろく"],
      "1716 〇〇〇〇の改革": ["きょうほ"],
      "1720 〇〇〇〇をとりいれる": ["ようしょ"],
      "1720 〇〇〇〇〇のしくみ": ["まちびけし"],
      "1730 〇〇のながれを整える": ["もの"],
      "1775 〇〇〇の時代": ["たぬま"],
      "1783 〇〇〇〇のききん": ["てんめい"],
      "1787 〇〇〇〇の改革": ["かんせい"],
      "1825 〇〇〇〇〇打払令": ["いこくせん"],
      "1837 〇〇〇〇〇〇〇〇〇〇の乱": ["おおしおへいはちろう"],
      "1841 〇〇〇〇の改革": ["てんぽう"],
      "1853 〇〇〇〇が来る": ["くろふね"],
      "1854 〇〇〇条約": ["わしん"],
      "1858 〇〇〇〇の条約": ["あんせい"],
      "1858 〇〇〇〇の大獄": ["あんせい"],
      "1860 〇〇〇〇〇〇〇〇の変": ["さくらだもんがい"],
      "1867 〇〇〇〇奉還": ["たいせい"],
      "1868 〇〇〇へ": ["めいじ"]
    }
  },

  /* ---------- 室町時代（※ 1401 勘合貿易の〇は現状維持） ---------- */
  muromachi: {
    title: "室町時代",
    LS_KEY: "cards_muromachi_complete_v1",
    chapters: {
      "初期（南北朝〜）": {
        "1336 〇〇〇〇幕府がはじまる": { text: "足利氏の幕府が京都で始まる。", icon: "🏯", year: 1336 },
        "1392 〇〇〇〇〇〇〇統一":       { text: "南朝と北朝がひとつになる。", icon: "🤝", year: 1392 },
        "1397 〇〇〇〇が建てられる":   { text: "きらびやかな建物（鹿苑寺）。", icon: "🏯", year: 1397 },
        "1390 〇〇〇〇文化がさかえる": { text: "能や茶の湯など都の文化が発展。", icon: "🎭", year: 1390 },
        "1401 〇〇〇〇貿易がはじまる": { text: "明との勘合（証明）を用いた貿易。", icon: "🛶", year: 1401 }
      },
      "中期（文化と争い）": {
        "1439 〇〇〇〇〇の乱":         { text: "関東で大きな戦い（将軍側と対立）。", icon: "⚔️", year: 1439 },
        "1441 〇〇〇の乱":             { text: "将軍が討たれる事件（赤松氏ら）。", icon: "⚠️", year: 1441 },
        "1467 〇〇〇〇の乱":           { text: "京都が荒廃、のちの戦国時代へ。", icon: "🔥", year: 1467 },
        "1485 〇〇〇〇国一揆":         { text: "人びとが協力して自治（山城国）。", icon: "🛡️", year: 1485 },
        "1489 〇〇〇〇が建てられる":   { text: "静かな美（慈照寺・銀閣）。", icon: "🏯", year: 1489 },
        "1493 〇〇〇〇の政変":         { text: "細川氏の政変で権力が移る。", icon: "🌀", year: 1493 }
      },
      "後期（戦国の入口）": {
        "1543 〇〇〇〇伝来":           { text: "新しい道具が日本へ（鉄砲）。", icon: "🔫", year: 1543 },
        "1549 〇〇〇〇教伝来":         { text: "キリスト教が日本に広がる。", icon: "⛪", year: 1549 },
        "1555 〇〇〇〇〇の戦い":       { text: "厳島の戦い、武将が勢力拡大。", icon: "🗺️", year: 1555 },
        "1573 〇〇〇〇幕府がおわる":   { text: "将軍追放で幕府が終わりへ。", icon: "🌅", year: 1573 }
      }
    },
    ruby: {
      "1336 〇〇〇〇幕府がはじまる": "〇〇〇〇<ruby>幕府<rt>ばくふ</rt></ruby>がはじまる",
      "1392 〇〇〇〇〇〇〇統一":       "〇〇〇〇〇〇〇<ruby>統一<rt>とういつ</rt></ruby>",
      "1397 〇〇〇〇が建てられる":   "〇〇〇〇が<ruby>建<rt>た</rt></ruby>てられる",
      "1390 〇〇〇〇文化がさかえる": "〇〇〇〇<ruby>文化<rt>ぶんか</rt></ruby>がさかえる",
      "1401 〇〇〇〇貿易がはじまる": "〇〇〇〇<ruby>貿易<rt>ぼうえき</rt></ruby>がはじまる",

      "1439 〇〇〇〇〇の乱":         "〇〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1441 〇〇〇の乱":             "〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1467 〇〇〇〇の乱":           "〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1485 〇〇〇〇国一揆":         "〇〇〇〇<ruby>国<rt>くに</rt></ruby><ruby>一揆<rt>いっき</rt></ruby>",
      "1489 〇〇〇〇が建てられる":   "〇〇〇〇が<ruby>建<rt>た</rt></ruby>てられる",
      "1493 〇〇〇〇の政変":         "〇〇〇〇の<ruby>政変<rt>せいへん</rt></ruby>",

      "1543 〇〇〇〇伝来":           "〇〇〇〇<ruby>伝来<rt>でんらい</rt></ruby>",
      "1549 〇〇〇〇教伝来":         "〇〇〇〇<ruby>教<rt>きょう</rt></ruby><ruby>伝来<rt>でんらい</rt></ruby>",
      "1555 〇〇〇〇〇の戦い":       "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1573 〇〇〇〇幕府がおわる":   "〇〇〇〇<ruby>幕府<rt>ばくふ</rt></ruby>が<ruby>終<rt>お</rt></ruby>わる"
    },
    blanks: {
      "1336 〇〇〇〇幕府がはじまる": ["むろまち"],
      "1392 〇〇〇〇〇〇〇統一":       ["なんぼくちょう"],
      "1397 〇〇〇〇が建てられる":   ["きんかく"],
      "1390 〇〇〇〇文化がさかえる": ["きたやま"],
      "1401 〇〇〇〇貿易がはじまる": ["かんごう"],

      "1439 〇〇〇〇〇の乱":         ["えいきょう"],
      "1441 〇〇〇の乱":             ["かきつ"],
      "1467 〇〇〇〇の乱":           ["おうにん"],
      "1485 〇〇〇〇国一揆":         ["やましろ"],
      "1489 〇〇〇〇が建てられる":   ["ぎんかく"],
      "1493 〇〇〇〇の政変":         ["めいおう"],

      "1543 〇〇〇〇伝来":           ["てっぽう"],
      "1549 〇〇〇〇教伝来":         ["きりすと"],
      "1555 〇〇〇〇〇の戦い":       ["いつくしま"],
      "1573 〇〇〇〇幕府がおわる":   ["むろまち"]
    }
  },

  /* ---------- 鎌倉時代（たっぷり収録） ---------- */
  kamakura: {
    title: "鎌倉時代",
    LS_KEY: "cards_kamakura_complete_v1",
    chapters: {
      "初期（源平〜創設）": {
        "1180 〇〇〇〇合戦がはじまる": { text: "源氏と平氏の大きなたたかいが始まる。", icon: "⚔️", year: 1180 },
        "1185 〇〇〇〇〇の戦い":       { text: "壇ノ浦で勝敗が決まる。", icon: "🚩", year: 1185 },
        "1185 〇〇〇・〇〇〇の設置":   { text: "国ごとに守る人・土地をおさめる人が置かれる。", icon: "🛡️", year: 1185 },
        "1185 〇〇〇〇幕府がはじまる": { text: "武士の政治が本格スタート。", icon: "🏯", year: 1185 },
        "1192 〇〇〇〇が将軍に":       { text: "よりともが将軍になる。", icon: "👑", year: 1192 }
      },
      "中期（執権政治）": {
        "1203 〇〇〇〇政治がはじまる": { text: "北条氏がまとめる政治（執権政治）。", icon: "📜", year: 1203 },
        "1213 〇〇合戦":               { text: "和田氏とのたたかい。", icon: "⚔️", year: 1213 },
        "1221 〇〇〇〇の乱":           { text: "朝廷との大きな対立（承久の乱）。", icon: "⚠️", year: 1221 },
        "1232 〇〇〇〇〇〇〇〇〇が定まる": { text: "武士のルール（御成敗式目）ができる。", icon: "📖", year: 1232 },
        "1247 〇〇〇合戦":             { text: "有力武士のあらそい（宝治合戦）。", icon: "🛡️", year: 1247 },
        "1252 〇〇〇〇ができる":       { text: "鎌倉大仏がつくられる。", icon: "🗿", year: 1252 }
      },
      "後期（元寇〜滅亡）": {
        "1274 〇〇〇〇の役":           { text: "元が攻めてくる（文永の役）。", icon: "⛴️", year: 1274 },
        "1281 〇〇〇〇の役":           { text: "ふたたび元が攻める（弘安の役）。", icon: "⛴️", year: 1281 },
        "1297 〇〇〇〇〇〇が出る":     { text: "借金をゆるす命令（徳政令）。", icon: "📢", year: 1297 },
        "1305 〇〇〇〇騒動":           { text: "有力者どうしの対立（霜月騒動）。", icon: "🌪️", year: 1305 },
        "1331 〇〇〇〇の乱":           { text: "朝廷がたちあがる（元弘の乱）。", icon: "⚠️", year: 1331 },
        "1333 〇〇〇〇幕府がほろぶ":   { text: "鎌倉幕府が終わる。", icon: "🌅", year: 1333 }
      },
      "文化（新しい仏教）": {
        "1175 〇〇〇〇宗が広まる":     { text: "法然の教え（浄土宗）。", icon: "🙏", year: 1175 },
        "1191 〇〇〇〇宗が伝わる":     { text: "栄西の教え（臨済宗）。", icon: "🧘", year: 1191 },
        "1224 〇〇〇〇真宗が広まる":   { text: "親鸞の教え（浄土真宗）。", icon: "🙏", year: 1224 },
        "1227 〇〇〇宗が広まる":       { text: "一遍の教え（時宗）。", icon: "🙏", year: 1227 },
        "1247 〇〇〇〇宗が広まる":     { text: "道元の教え（曹洞宗）。", icon: "🧘", year: 1247 },
        "1253 〇〇〇〇宗が広まる":     { text: "日蓮の教え（日蓮宗）。", icon: "🕊️", year: 1253 }
      }
    },
    ruby: {
      "1180 〇〇〇〇合戦がはじまる": "〇〇〇〇<ruby>合戦<rt>かっせん</rt></ruby>がはじまる",
      "1185 〇〇〇〇〇の戦い":       "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1185 〇〇〇・〇〇〇の設置":   "〇〇〇・〇〇〇の<ruby>設置<rt>せっち</rt></ruby>",
      "1185 〇〇〇〇幕府がはじまる": "〇〇〇〇<ruby>幕府<rt>ばくふ</rt></ruby>がはじまる",
      "1192 〇〇〇〇が将軍に":       "〇〇〇〇が<ruby>将軍<rt>しょうぐん</rt></ruby>に",

      "1203 〇〇〇〇政治がはじまる": "〇〇〇〇<ruby>政治<rt>せいじ</rt></ruby>がはじまる",
      "1213 〇〇合戦":               "〇〇<ruby>合戦<rt>かっせん</rt></ruby>",
      "1221 〇〇〇〇の乱":           "〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1232 〇〇〇〇〇〇〇〇〇が定まる": "〇〇〇〇〇〇〇〇〇が<ruby>定<rt>さだ</rt></ruby>まる",
      "1247 〇〇〇合戦":             "〇〇〇<ruby>合戦<rt>かっせん</rt></ruby>",
      "1252 〇〇〇〇ができる":       "〇〇〇〇ができる",

      "1274 〇〇〇〇の役":           "〇〇〇〇の<ruby>役<rt>えき</rt></ruby>",
      "1281 〇〇〇〇の役":           "〇〇〇〇の<ruby>役<rt>えき</rt></ruby>",
      "1297 〇〇〇〇〇〇が出る":     "〇〇〇〇〇〇が<ruby>出<rt>で</rt></ruby>る",
      "1305 〇〇〇〇騒動":           "〇〇〇〇<ruby>騒動<rt>そうどう</rt></ruby>",
      "1331 〇〇〇〇の乱":           "〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1333 〇〇〇〇幕府がほろぶ":   "〇〇〇〇<ruby>幕府<rt>ばくふ</rt></ruby>がほろぶ",

      "1175 〇〇〇〇宗が広まる":     "〇〇〇〇<ruby>宗<rt>しゅう</rt></ruby>が広まる",
      "1191 〇〇〇〇宗が伝わる":     "〇〇〇〇<ruby>宗<rt>しゅう</rt></ruby>が<ruby>伝<rt>つた</rt></ruby>わる",
      "1224 〇〇〇〇真宗が広まる":   "〇〇〇〇<ruby>真宗<rt>しんしゅう</rt></ruby>が広まる",
      "1227 〇〇〇宗が広まる":       "〇〇〇<ruby>宗<rt>しゅう</rt></ruby>が広まる",
      "1247 〇〇〇〇宗が広まる":     "〇〇〇〇<ruby>宗<rt>しゅう</rt></ruby>が広まる",
      "1253 〇〇〇〇宗が広まる":     "〇〇〇〇<ruby>宗<rt>しゅう</rt></ruby>が広まる"
    },
    blanks: {
      "1180 〇〇〇〇合戦がはじまる": ["げんぺい"],
      "1185 〇〇〇〇〇の戦い":       ["たんのうら"],
      "1185 〇〇〇・〇〇〇の設置":   ["しゅご","じとう"],
      "1185 〇〇〇〇幕府がはじまる": ["かまくら"],
      "1192 〇〇〇〇が将軍に":       ["よりとも"],

      "1203 〇〇〇〇政治がはじまる": ["しっけん"],
      "1213 〇〇合戦":               ["わだ"],
      "1221 〇〇〇〇の乱":           ["じょうきゅう"],
      "1232 〇〇〇〇〇〇〇〇〇が定まる": ["ごせいばいしきもく"],
      "1247 〇〇〇合戦":             ["ほうじ"],
      "1252 〇〇〇〇ができる":       ["だいぶつ"],

      "1274 〇〇〇〇の役":           ["ぶんえい"],
      "1281 〇〇〇〇の役":           ["こうあん"],
      "1297 〇〇〇〇〇〇が出る":     ["とくせいれい"],
      "1305 〇〇〇〇騒動":           ["しもつき"],
      "1331 〇〇〇〇の乱":           ["げんこう"],
      "1333 〇〇〇〇幕府がほろぶ":   ["かまくら"],

      "1175 〇〇〇〇宗が広まる":     ["じょうど"],
      "1191 〇〇〇〇宗が伝わる":     ["りんざい"],
      "1224 〇〇〇〇真宗が広まる":   ["じょうど"],
      "1227 〇〇〇宗が広まる":       ["じしゅう"],
      "1247 〇〇〇〇宗が広まる":     ["そうとう"],
      "1253 〇〇〇〇宗が広まる":     ["にちれん"]
    }
  },
  /* ---------- 戦国時代（多め） ---------- */
  sengoku: {
    title: "戦国時代",
    LS_KEY: "cards_sengoku_complete_v1",
    chapters: {
      "前期（戦乱のはじまり）": {
        "1467 〇〇〇〇の乱":                { text: "京都で大きな戦いがはじまり、全国に広がる。", icon: "🔥", year: 1467 }, // おうにん
        "1485 〇〇〇〇国一揆":              { text: "人びとが協力して自治（山城国）。", icon: "🛡️", year: 1485 }           // やましろ
      },
      "群雄割拠": {
        "1543 〇〇〇〇伝来":                { text: "新しい武器が伝わる（鉄砲）。", icon: "🔫", year: 1543 },             // てっぽう
        "1549 〇〇〇〇教伝来":              { text: "キリスト教が日本に広がる。", icon: "⛪", year: 1549 },               // きりすと
        "1555 〇〇〇〇〇の戦い":            { text: "厳島の戦い、武将が勢力拡大。", icon: "🗺️", year: 1555 },           // いつくしま
        "1560 〇〇〇〇〇の戦い":            { text: "桶狭間の戦い、奇襲でかつ。", icon: "⚔️", year: 1560 },             // おけはざま
        "1561 〇〇〇〇〇〇の戦い":          { text: "川中島の戦い、名将どうしが激突。", icon: "⚔️", year: 1561 },       // かわなかじま
        "1567 〇〇に改名（稲葉山→〜）":    { text: "城下町の名をあらためる（岐阜）。", icon: "🏯", year: 1567 },       // ぎふ
        "1568 〇〇〇〇が京都に入る":        { text: "都をおさえて天下へ進む。", icon: "🏯", year: 1568 }                 // のぶなが
      },
      "統一へ": {
        "1570 〇〇〇〇の戦い":              { text: "姉川の戦い。", icon: "⚔️", year: 1570 },                             // あねがわ
        "1571 〇〇〇〇〇焼き討ち":          { text: "比叡山を攻める。", icon: "🔥", year: 1571 },                         // ひえいざん
        "1573 〇〇〇〇幕府がおわる":        { text: "室町幕府の終わり。", icon: "🌅", year: 1573 },                       // むろまち
        "1575 〇〇〇〇の戦い":              { text: "長篠の戦い、鉄砲で勝つ。", icon: "🔫", year: 1575 },                // ながしの
        "1576 〇〇〇城を築く":              { text: "安土城をつくる。", icon: "🏰", year: 1576 },                         // あづち
        "1582 〇〇〇〇〇の変":              { text: "本能寺の変。", icon: "🗡️", year: 1582 },                             // ほんのうじ
        "1582 〇〇〇〇の戦い":              { text: "山崎の戦い。", icon: "⚔️", year: 1582 },                             // やまざき
        "1583 〇〇〇〇〇の戦い":            { text: "賤ヶ岳の戦い。", icon: "⚔️", year: 1583 },                           // しずがたけ
        "1584 〇〇〇・〇〇〇〇の戦い":      { text: "小牧・長久手の戦い。", icon: "⚔️", year: 1584 },                     // こまき / ながくて
        "1585 〇〇〇〇になる":              { text: "関白になる。", icon: "🎖️", year: 1585 },                             // かんぱく
        "1587 〇〇〇〇〇〇を平定":          { text: "九州をおさめる。", icon: "🗾", year: 1587 },                           // きゅうしゅう
        "1588 〇〇〇〇〇〇〇令":            { text: "刀狩令を出す。", icon: "📢", year: 1588 },                             // かたながりれい
        "1590 〇〇〇〇の戦い":              { text: "小田原の戦い。", icon: "⚔️", year: 1590 },                           // おだわら
        "1591 〇〇〇〇〇〇〇〇が出る":      { text: "身分統制令を出す。", icon: "📜", year: 1591 },                         // みぶんとうせいれい
        "1592 〇〇〇〇〇〇〇の役":          { text: "朝鮮へ出兵（文禄の役）。", icon: "⛴️", year: 1592 },                  // ぶんろくのえき
        "1597 〇〇〇〇〇〇〇〇の役":        { text: "ふたたび出兵（慶長の役）。", icon: "⛴️", year: 1597 },               // けいちょうのえき
        "1598 〇〇〇〇がなくなる":          { text: "秀吉が亡くなる。", icon: "🕊️", year: 1598 },                         // ひでよし
        "1600 〇〇〇〇〇の戦い":            { text: "関ヶ原の戦い。", icon: "⚔️", year: 1600 }                             // せきがはら
      },
      "政策と町づくり": {
        "1577 〇〇〇〇・〇〇〇をすすめる":  { text: "楽市・楽座をすすめ、商いが活発に。", icon: "🛍️", year: 1577 },      // らくいち / らくざ
        "1582 〇〇〇〇<ruby>検地<rt>けんち</rt></ruby>がすすむ": { text: "田んぼの広さをはかり、税を決める（太閤検地）。", icon: "📏", year: 1582 }, // たいこう
        "1583 〇〇〇〇城を築く":            { text: "大阪城を築く。", icon: "🏯", year: 1583 }                              // おおさか
      }
    },
    ruby: {
      "1467 〇〇〇〇の乱":                 "〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1485 〇〇〇〇国一揆":               "〇〇〇〇<ruby>国<rt>くに</rt></ruby><ruby>一揆<rt>いっき</rt></ruby>",

      "1543 〇〇〇〇伝来":                 "〇〇〇〇<ruby>伝来<rt>でんらい</rt></ruby>",
      "1549 〇〇〇〇教伝来":               "〇〇〇〇<ruby>教<rt>きょう</rt></ruby><ruby>伝来<rt>でんらい</rt></ruby>",
      "1555 〇〇〇〇〇の戦い":             "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1560 〇〇〇〇〇の戦い":             "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1561 〇〇〇〇〇〇の戦い":           "〇〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1567 〇〇に改名（稲葉山→〜）":     "〇〇に<ruby>改名<rt>かいめい</rt></ruby>（<ruby>稲葉山<rt>いなばやま</rt></ruby>→〜）",
      "1568 〇〇〇〇が京都に入る":         "〇〇〇〇が<ruby>京都<rt>きょうと</rt></ruby>に<ruby>入<rt>はい</rt></ruby>る",

      "1570 〇〇〇〇の戦い":               "〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1571 〇〇〇〇〇焼き討ち":           "〇〇〇〇〇<ruby>焼<rt>や</rt></ruby>き<ruby>討<rt>う</rt></ruby>ち",
      "1573 〇〇〇〇幕府がおわる":         "〇〇〇〇<ruby>幕府<rt>ばくふ</rt></ruby>が<ruby>終<rt>お</rt></ruby>わる",
      "1575 〇〇〇〇の戦い":               "〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1576 〇〇〇城を築く":               "〇〇〇<ruby>城<rt>じょう</rt></ruby>を<ruby>築<rt>きず</rt></ruby>く",
      "1582 〇〇〇〇〇の変":               "〇〇〇〇〇の<ruby>変<rt>へん</rt></ruby>",
      "1582 〇〇〇〇の戦い":               "〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1583 〇〇〇〇〇の戦い":             "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1584 〇〇〇・〇〇〇〇の戦い":       "〇〇〇・〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1585 〇〇〇〇になる":               "〇〇〇〇に<ruby>成<rt>な</rt></ruby>る",
      "1587 〇〇〇〇〇〇を平定":           "〇〇〇〇〇〇を<ruby>平定<rt>へいてい</rt></ruby>",
      "1588 〇〇〇〇〇〇〇令":             "〇〇〇〇〇〇〇<ruby>令<rt>れい</rt></ruby>",
      "1590 〇〇〇〇の戦い":               "〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1591 〇〇〇〇〇〇〇〇が出る":       "〇〇〇〇〇〇〇〇が<ruby>出<rt>で</rt></ruby>る",
      "1592 〇〇〇〇〇〇〇の役":           "〇〇〇〇〇〇〇の<ruby>役<rt>えき</rt></ruby>",
      "1597 〇〇〇〇〇〇〇〇の役":         "〇〇〇〇〇〇〇〇の<ruby>役<rt>えき</rt></ruby>",
      "1598 〇〇〇〇がなくなる":           "〇〇〇〇が<ruby>亡<rt>な</rt></ruby>くなる",
      "1600 〇〇〇〇〇の戦い":             "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",

      "1577 〇〇〇〇・〇〇〇をすすめる":   "〇〇〇〇・〇〇〇を<ruby>勧<rt>すす</rt></ruby>める",
      "1582 〇〇〇〇<ruby>検地<rt>けんち</rt></ruby>がすすむ": "〇〇〇〇<ruby>検地<rt>けんち</rt></ruby>がすすむ",
      "1583 〇〇〇〇城を築く":             "〇〇〇〇<ruby>城<rt>じょう</rt></ruby>を<ruby>築<rt>きず</rt></ruby>く"
    },
    blanks: {
      "1467 〇〇〇〇の乱":                ["おうにん"],
      "1485 〇〇〇〇国一揆":              ["やましろ"],

      "1543 〇〇〇〇伝来":                ["てっぽう"],
      "1549 〇〇〇〇教伝来":              ["きりすと"],
      "1555 〇〇〇〇〇の戦い":            ["いつくしま"],
      "1560 〇〇〇〇〇の戦い":            ["おけはざま"],
      "1561 〇〇〇〇〇〇の戦い":          ["かわなかじま"],
      "1567 〇〇に改名（稲葉山→〜）":    ["ぎふ"],
      "1568 〇〇〇〇が京都に入る":        ["のぶなが"],

      "1570 〇〇〇〇の戦い":              ["あねがわ"],
      "1571 〇〇〇〇〇焼き討ち":          ["ひえいざん"],
      "1573 〇〇〇〇幕府がおわる":        ["むろまち"],
      "1575 〇〇〇〇の戦い":              ["ながしの"],
      "1576 〇〇〇城を築く":              ["あづち"],
      "1582 〇〇〇〇〇の変":              ["ほんのうじ"],
      "1582 〇〇〇〇の戦い":              ["やまざき"],
      "1583 〇〇〇〇〇の戦い":            ["しずがたけ"],
      "1584 〇〇〇・〇〇〇〇の戦い":      ["こまき","ながくて"],
      "1585 〇〇〇〇になる":              ["かんぱく"],
      "1587 〇〇〇〇〇〇を平定":          ["きゅうしゅう"],
      "1588 〇〇〇〇〇〇〇令":            ["かたながりれい"],
      "1590 〇〇〇〇の戦い":              ["おだわら"],
      "1591 〇〇〇〇〇〇〇〇が出る":      ["みぶんとうせいれい"],
      "1592 〇〇〇〇〇〇〇の役":          ["ぶんろくのえき"],
      "1597 〇〇〇〇〇〇〇〇の役":        ["けいちょうのえき"],
      "1598 〇〇〇〇がなくなる":          ["ひでよし"],
      "1600 〇〇〇〇〇の戦い":            ["せきがはら"],

      "1577 〇〇〇〇・〇〇〇をすすめる":  ["らくいち","らくざ"],
      "1582 〇〇〇〇検地がすすむ":        ["たいこう"],
      "1583 〇〇〇〇城を築く":            ["おおさか"]
    }
  }

};

/* ========= 共通ユーティリティ ========= */
const eraSelect      = document.getElementById("eraSelect");
const chapterFilter  = document.getElementById("chapterFilter");
const infoBox        = document.getElementById("info");
const town           = document.getElementById("town");
const zukanPanel     = document.getElementById("zukanPanel");
const zukanList      = document.getElementById("zukanList");
const completeMsg    = document.getElementById("completeMsg");
const zukanBtn       = document.getElementById("zukanBtn");
const closeZukan     = document.getElementById("closeZukan");
const resetBtn       = document.getElementById("resetBtn");

const quizModal  = document.getElementById("quizModal");
const quizTitle  = document.getElementById("quizTitle");
const quizHint   = document.getElementById("quizHint");
const quizInput  = document.getElementById("quizInput");
const quizOk     = document.getElementById("quizOk");
const quizCancel = document.getElementById("quizCancel");
const quizBg     = document.getElementById("quizBg");

let currentEra = eraSelect ? eraSelect.value : "edo";
let gotCards = {}; // 現在の時代の進捗（localStorageに保存）

function onlyHiraAndSep(s){
  return /^[\u3041-\u3096\s・,，、/／]+$/.test(s);
}
function splitTokens(ans){
  let s = ans.replace(/[・,，、/／]+/g, ' ');
  s = s.replace(/\s+/g, ' ').trim();
  return s ? s.split(' ') : [];
}
function persist(){
  try { localStorage.setItem(dataSets[currentEra].LS_KEY, JSON.stringify(gotCards)); } catch(e){}
}
function loadProgress(){
  const raw = localStorage.getItem(dataSets[currentEra].LS_KEY);
  try{ gotCards = raw ? JSON.parse(raw) : {}; } catch{ gotCards = {}; }
}

/* ========= 表示構築 ========= */
function withRubyMasked(fullName){
  const m = dataSets[currentEra].ruby[fullName];
  if(m) {
    const sp   = fullName.indexOf(" ");
    const year = fullName.slice(0, sp);
    return `<span class="yr">${year}</span> ${m}`;
  }
  return fullName;
}

function buildChapterFilter(){
  if(!chapterFilter) return;
  chapterFilter.innerHTML = `<option value="ALL">章：ぜんぶ</option>`;
  const chapters = dataSets[currentEra].chapters;
  Object.keys(chapters).forEach(ch=>{
    chapterFilter.innerHTML += `<option value="${ch}">${ch}</option>`;
  });
}

function buildCards(){
  const wrap = document.getElementById("cards");
  if(!wrap) return;
  wrap.innerHTML = "";
  const sel = chapterFilter ? chapterFilter.value : "ALL";
  const chapters = dataSets[currentEra].chapters;

  Object.keys(chapters).forEach(ch=>{
    if(sel!=="ALL" && sel!==ch) return;
    for(const name in chapters[ch]){
      const el = document.createElement("div");
      el.className = "card";
      el.dataset.card = name;

      // アクセシビリティ（キーボード操作OK）
      el.setAttribute('role','button');
      el.setAttribute('tabindex','0');

      if(gotCards[name]) { el.innerHTML = withRubyMasked(name); el.classList.add("done"); }
      else { el.textContent = "？\n" + name.split(" ")[0]; }

      el.addEventListener("click", ()=>onCardClick(el, name, ch));
      el.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          onCardClick(el, name, ch);
        }
      });

      wrap.appendChild(el);
    }
  });
}

function renderZukan(){
  zukanList.innerHTML = "";
  let allComplete = true;
  const chapters = dataSets[currentEra].chapters;
  for(const ch in chapters){
    const section = document.createElement("div");
    section.className = "zukanSec";
    section.innerHTML = `<h3>${ch}</h3>`;
    for(const name in chapters[ch]){
      const div = document.createElement("div");
      div.className = "zCard";
      if(gotCards[name]){
        div.innerHTML = withRubyMasked(name);
      }else{
        div.textContent = "？？？";
        div.classList.add("locked");
        allComplete = false;
      }
      section.appendChild(div);
    }
    zukanList.appendChild(section);
  }
  if(allComplete){
    completeMsg.textContent = `🎉 ${dataSets[currentEra].title}コンプリート！おめでとう！ 🎉`;
    launchPetals();
  }else{
    completeMsg.textContent = "";
  }
}

function launchPetals(){
  for(let i=0;i<24;i++){
    const p=document.createElement("div");
    p.className="petal";
    p.textContent="🌸";
    p.style.left = Math.random()*100 + "vw";
    p.style.animationDuration = (3 + Math.random()*3) + "s";
    document.body.appendChild(p);
    setTimeout(()=>p.remove(), 7000);
  }
}

/* ========= クイズ（モーダル） ========= */
let quizCtx = { card:null, name:"", ch:"", expected:[] };

function openQuiz(card, name, ch){
  const expected = dataSets[currentEra].blanks[name];
  if(!expected){ alert("このカードの空欄答えが未登録です"); return; }
  quizCtx = { card, name, ch, expected };

  quizTitle.innerHTML = withRubyMasked(name);
  quizHint.textContent = expected.length >= 2
    ? `空欄は ${expected.length} こ。順番に入力してね`
    : `空欄は 1 こ。例：えど`;

  quizModal.classList.add("active");
  quizModal.setAttribute("aria-hidden","false");
  quizInput.value = "";
  setTimeout(()=>quizInput.focus(), 50);
}
function closeQuiz(){
  quizModal.classList.remove("active");
  quizModal.setAttribute("aria-hidden","true");
}
function submitQuiz(){
  const { card, name, ch, expected } = quizCtx;
  if(!card) return;
  const raw = quizInput.value.trim();
  if(!onlyHiraAndSep(raw)){
    alert("ひらがな だけで入力してね（区切りは スペース/・/、/，/／ だけOK）");
    quizInput.focus(); return;
  }
  const tokens = splitTokens(raw);
  const joined = tokens.join("");
  const expectJoined = expected.join("");

  let ok = false;
  if(tokens.length === expected.length){
    ok = tokens.every((t,i)=>t === expected[i]);
  }else if(tokens.length === 1){
    ok = joined === expectJoined; // まとめ入力OK
  }

  if(!ok){
    alert(`ざんねん！せいかいは「${expected.join(" ・ ")}」だよ（〇の部分だけ）`);
    quizInput.focus();
    return;
  }

  // 正解処理
  closeQuiz();
  const data = dataSets[currentEra].chapters[ch][name];
  card.innerHTML = withRubyMasked(name);
  card.classList.add("done");
  infoBox && (infoBox.textContent = data.text);

  const b = document.createElement("div");
  b.className = "building";
  b.textContent = data.icon;
  b.style.left = (Math.random()*80 + 5) + "%";
  b.style.top  = (Math.random()*70 + 5) + "%";
  town.appendChild(b);
  setTimeout(()=>b.classList.add("show"),50);

  const v = document.createElement("div");
  v.className = "villager";
  v.textContent = Math.random()>0.5 ? "😊" : "👘";
  v.style.top = Math.floor(Math.random()*Math.max(40, town.clientHeight-40)) + "px";
  town.appendChild(v);

  gotCards[name] = true;
  persist();
  renderZukan();
}

function onCardClick(card, name, ch){
  if(card.classList.contains("done")) return;
  openQuiz(card, name, ch);
}

/* ========= イベント ========= */
quizCancel?.addEventListener("click", closeQuiz);
quizBg?.addEventListener("click", closeQuiz);
quizOk?.addEventListener("click", submitQuiz);
quizInput?.addEventListener("keydown", e=>{ if(e.key === "Enter") submitQuiz(); });

zukanBtn?.addEventListener("click", ()=>{
  const active = !zukanPanel.classList.contains("active");
  zukanPanel.classList.toggle("active");
  zukanPanel.setAttribute("aria-hidden", active ? "false" : "true");
  zukanBtn.setAttribute("aria-expanded", String(active));
});
closeZukan?.addEventListener("click", ()=>{
  zukanPanel.classList.remove("active");
  zukanPanel.setAttribute("aria-hidden","true");
  zukanBtn.setAttribute("aria-expanded","false");
});
chapterFilter?.addEventListener("change", buildCards);

// リセット
resetBtn?.addEventListener("click", ()=>{
  if(!confirm(`${dataSets[currentEra].title}の進捗（開いたカード・町づくり）をリセットします。よろしいですか？`)) return;
  localStorage.removeItem(dataSets[currentEra].LS_KEY);
  gotCards = {};
  document.querySelectorAll("#town .building, #town .villager").forEach(el=>el.remove());
  if(infoBox) infoBox.textContent = "時代をえらんでカードをめくろう！ 〇の部分だけを「ひらがな」で答えると開くよ。";
  zukanPanel.classList.remove("active");
  zukanPanel.setAttribute("aria-hidden","true");
  zukanBtn.setAttribute("aria-expanded","false");
  buildCards();
  renderZukan();
  alert("リセットしました！");
});

// イントロのクイックボタンで時代切り替え（PC/スマホ両対応）
function bindEraLink(sel, era){
  const el = document.getElementById(sel);
  if(!el) return;
  el.addEventListener("click", (e)=>{
    e.preventDefault();
    if(eraSelect){ eraSelect.value = era; eraSelect.dispatchEvent(new Event("change")); }
    document.getElementById("cards")?.scrollIntoView({ behavior: "smooth" });
  });
}
bindEraLink("playEdo", "edo");
bindEraLink("playMuromachi", "muromachi");
bindEraLink("playKamakura", "kamakura");
bindEraLink("playSengoku", "sengoku");

// フッターのショートカット（存在チェックしてから）
bindEraLink("footEdo", "edo");
bindEraLink("footMuromachi", "muromachi");
bindEraLink("footKamakura", "kamakura");
document.getElementById("footZukan")?.addEventListener("click", (e)=>{ e.preventDefault(); document.getElementById("openZukan")?.click(); });
bindEraLink("footSengoku", "sengoku");

// 図鑑ボタン直リンク
document.getElementById("openZukan")?.addEventListener("click", (e)=>{
  e.preventDefault();
  zukanPanel.classList.add("active");
  zukanPanel.setAttribute("aria-hidden","false");
  zukanBtn.setAttribute("aria-expanded","true");
  zukanPanel.scrollIntoView({ behavior: "smooth" });
});

// 時代セレクト変更
eraSelect?.addEventListener("change", ()=>{
  currentEra = eraSelect.value;
  document.querySelectorAll("#town .building, #town .villager").forEach(el=>el.remove());
  loadProgress();
  buildChapterFilter();
  buildCards();
  renderZukan();
});

/* ========= 初期描画 ========= */
loadProgress();
buildChapterFilter();
buildCards();
renderZukan();

// 保存復元（建物＆住人）
(function restoreTown(){
  const chapters = dataSets[currentEra].chapters;
  for(const ch in chapters){
    for(const name in chapters[ch]){
      if(!gotCards[name]) continue;
      const item = chapters[ch][name];
      const b = document.createElement("div");
      b.className = "building show";
      b.textContent = item.icon;
      b.style.left = (Math.random()*80 + 5) + "%";
      b.style.top = (Math.random()*70 + 5) + "%";
      town.appendChild(b);

      const v = document.createElement("div");
      v.className = "villager";
      v.textContent = Math.random()>0.5 ? "😊" : "👘";
      v.style.top = Math.floor(Math.random()*Math.max(40, town.clientHeight-40)) + "px";
      town.appendChild(v);
    }
  }
})();



