 <!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />
  <meta name="theme-color" content="#FCD34D" />
  <meta name="format-detection" content="telephone=no,email=no,address=no" />

  <!-- DNS Prefetch / Preconnect（計測・広告の初速改善） -->
  <link rel="dns-prefetch" href="//www.googletagmanager.com">
  <link rel="dns-prefetch" href="//pagead2.googlesyndication.com">
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin>

 <link rel="manifest" href="/manifest.webmanifest" type="application/manifest+json">
 <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js', { scope: '/' });
    });
  }
</script>
 
  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32"   href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="48x48"   href="/favicon-48x48.png">
  <link rel="apple-touch-icon"      sizes="180x180" href="/favicon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon-512x512.png">

  <!-- hreflang（将来の多言語展開を見越して） -->
  <link rel="alternate" hreflang="ja" href="https://historykids.github.io/">
  <link rel="alternate" hreflang="x-default" href="https://historykids.github.io/">
<!-- SEO -->
  <title>歴史キッズ｜3Dで街づくり！小学生・中学生・高校生向け 歴史クイズ・一問一答形式で楽しく勉強できる！（江戸・戦国・室町・鎌倉）</title>
  <meta name="description" content="歴史キッズは小学生・中学生・高校生向けの歴史学習サイト。江戸・戦国・室町・鎌倉の出来事を、ひらがな一問一答クイズ／年表（図鑑）／社会／カード集め＆3D街づくりで楽しく勉強できます。スマホ最適化・無料。自由研究や受験対策にも役立ちます。" />
  <meta name="keywords" content="歴史,小学生,中学生,高校生,社会,一問一答,クイズ,年表,図鑑,江戸,戦国,室町,鎌倉,自由研究,社会,日本史,歴史人物" />
  <link rel="canonical" href="https://historykids.github.io/">

  <!-- OGP -->
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="ja_JP" />
  <meta property="og:url" content="https://historykids.github.io/" />
  <meta property="og:title" content="楽しく学べる！小中学生、高校生向け歴史学習サイト｜歴史キッズ" />
  <meta property="og:description" content="江戸・戦国・室町・鎌倉の出来事をカード収集と3D街づくりで学べる、子ども向け歴史勉強サイト。クイズ／年表／図鑑でテスト・受験にも。" />
  <meta property="og:image" content="https://historykids.github.io/thumbnail.png" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="楽しく学べる！小中学生・高校生向け歴史学習サイト｜歴史キッズ" />
  <meta name="twitter:description" content="江戸・戦国・室町・鎌倉の出来事をカード収集と3D街づくりで学べる歴史サイト。" />
  <meta name="twitter:image" content="https://historykids.github.io/thumbnail.png" />

  <!-- Google tag (gtag.js) ※1回のみ -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EZP12GC8W1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-EZP12GC8W1');
    gtag('config', 'G-6Z9WN4HFK5');
  </script>

  <!-- AdSense（1回だけ） -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4922140858632050" crossorigin="anonymous"></script>

  <!-- 構造化データ（WebSite + SitelinksSearchBox） -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebSite",
    "name":"歴史キッズ",
    "url":"https://historykids.github.io/",
    "inLanguage":"ja",
    "potentialAction":{
      "@type":"SearchAction",
      "target":"https://historykids.github.io/?q={search_term_string}#cards",
      "query-input":"required name=search_term_string"
    }
  }
  </script>

  <!-- 構造化データ（WebPage） -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebPage",
    "name":"歴史キッズ｜歴史クイズ・年表・図鑑",
    "url":"https://historykids.github.io/",
    "description":"江戸・戦国・室町・鎌倉を、クイズ／年表（図鑑）／カード集め＆3D街づくりで勉強できるサイト。自由研究にもおすすめ！小学生・中学生向けにスマホ最適化。"
  }
  </script>

  <!-- 構造化データ（FAQ） -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"FAQPage",
    "inLanguage":"ja",
    "mainEntity":[
      {"@type":"Question","name":"対象は小学生ですか？","acceptedAnswer":{"@type":"Answer","text":"はい。年少〜小学校低学年、中学生でも遊びながら歴史に親しめるように、ひらがなクイズや図鑑（年表）でやさしく学べます。"}},
      {"@type":"Question","name":"無料で使えますか？","acceptedAnswer":{"@type":"Answer","text":"無料で利用できます。サイト下部に広告が表示されます。"}},
      {"@type":"Question","name":"どんな学習内容がありますか？","acceptedAnswer":{"@type":"Answer","text":"江戸・戦国・室町・鎌倉の出来事を、年と出来事を結びつけるクイズ、年表の拡張表示、カード収集と3Dの街づくり演出で学べます。"}},
      {"@type":"Question","name":"自由研究に使えますか？","acceptedAnswer":{"@type":"Answer","text":"はい。歴史人物や年表をまとめて自由研究や調べ学習に活用できます。"}},
      {"@type":"Question","name":"スマホやタブレットでも使えますか？","acceptedAnswer":{"@type":"Answer","text":"はい。縦画面・1画面で遊べるよう最適化しています。"}}
    ]
  }
  </script>

  <!-- 構造化データ（BreadcrumbList） -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {"@type":"ListItem","position":1,"name":"ホーム","item":"https://historykids.github.io/"},
      {"@type":"ListItem","position":2,"name":"学習コンテンツ","item":"https://historykids.github.io/#cards"}
    ]
  }
  </script>

  <!-- 構造化データ（運営者） -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Person",
    "name":"しろながす",
    "jobTitle":"歴史キッズ 運営者",
    "url":"https://historykids.github.io/",
    "image":"https://historykids.github.io/歴史のキャラクターの紹介.png",
    "sameAs":[
      "https://x.com/your_handle",
      "https://github.com/your_github"
    ],
    "inLanguage":"ja"
  }
  </script>

  <!-- Search Console 所有権 -->
  <meta name="google-site-verification" content="bgJFyYeBgPsces8Rz5ONG_d-nj8ZEH_fHddcwAXMX0U" />

  <!-- ===== Styles ===== -->
  <style>
  :root{
    --edo-yellow:#FCD34D;
    --edo-info:#FFF8DC;
    --edo-border:#b89233;
    --bg:#fff7ec;
    --surface:#ffffff;
    --surface-muted:#fff0d7;
    --surface-soft:#fff9ef;
    --ink:#1f2933;
    --ink-light:#4b5563;
    --shadow:rgba(15,23,42,.12);
    --shadow-lg:rgba(15,23,42,.18);
    --radius-lg:24px;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(130% 100% at 0% 0%, rgba(252,211,77,.22) 0%, transparent 55%),
      radial-gradient(100% 120% at 100% 0%, rgba(249,168,212,.22) 0%, transparent 56%),
      linear-gradient(180deg,#fffdf4 0%,#fff7ec 48%,#fffdf7 100%);
    color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
      "Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;
    line-height:1.6;
  }
  a{color:inherit}
  h1,h2,h3{color:var(--ink)}
  h2{font-size:clamp(18px,3.2vw,22px);line-height:1.35;}

  .wrap{display:flex;flex-direction:column;min-height:100svh;}
  header{
    position:sticky;top:0;z-index:3;
    background:linear-gradient(135deg,rgba(252,211,77,.95),rgba(251,146,60,.95));
    padding:14px 20px;
    box-shadow:0 6px 20px rgba(249,168,38,.25);
    backdrop-filter:blur(6px);
  }
  header::after{
    content:"";
    position:absolute;
    inset:0;
    background:radial-gradient(120% 100% at 0% 0%,rgba(255,255,255,.25) 0%,transparent 60%);
    pointer-events:none;
  }
  .header-inner{
    max-width:1120px;
    margin:0 auto;
    display:grid;
    gap:12px;
    position:relative;
    z-index:1;
  }
  header h1.siteTitle{
    margin:0;
    font-size:clamp(16px,2.5vw,24px);
    line-height:1.25;
    font-weight:800;
    text-shadow:0 2px 6px rgba(0,0,0,.08);
  }
  header .controls{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }
  header label{
    font-size:12px;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:rgba(31,41,51,.88);
  }
  header button,
  header select{
    border:0;
    border-radius:12px;
    background:#fff;
    padding:8px 14px;
    font-weight:700;
    box-shadow:0 2px 6px rgba(0,0,0,.16);
    cursor:pointer;
    transition:transform .2s,box-shadow .2s,filter .2s;
  }
  header select{
    appearance:none;
    padding-right:32px;
    background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23333"><path d="M4 6l4 4 4-4z"/></svg>');
    background-repeat:no-repeat;
    background-position:right 12px center;
    background-size:14px;
  }
  header button:hover,
  header select:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,.18);}
  header button:focus-visible,
  header select:focus-visible{outline:3px solid rgba(59,130,246,.65);outline-offset:2px;}
  #resetBtn{background:#ffe4e6;color:#c53030;}
  .moneybox{
    margin-left:auto;
    background:linear-gradient(135deg,#fff,#fff7d4);
    border-radius:14px;
    padding:8px 14px;
    box-shadow:0 3px 10px rgba(0,0,0,.18);
    font-weight:700;
    display:flex;
    align-items:center;
    gap:6px;
  }
  #openShopBtn{
    background:linear-gradient(135deg,#fde68a,#fbbf24);
    color:#6b3a00;
  }
  main.content{
    flex:1;
    width:min(1120px,calc(100% - 32px));
    margin:16px auto 48px;
    display:flex;
    flex-direction:column;
    gap:20px;
  }
  #intro{
    background:var(--surface);
    border-radius:var(--radius-lg);
    padding:26px;
    box-shadow:0 18px 48px rgba(15,23,42,.12);
    position:relative;
    overflow:hidden;
    display:grid;
    gap:24px;
    align-items:center;
  }
  #intro::before{
    content:"";
    position:absolute;
    inset:-30% 40% auto -30%;
    height:120%;
    background:radial-gradient(ellipse at center,rgba(252,211,77,.25) 0%,transparent 70%);
    opacity:.8;
    pointer-events:none;
  }
  #intro::after{
    content:"";
    position:absolute;
    inset:auto -25% -60% 50%;
    height:120%;
    background:radial-gradient(ellipse at center,rgba(191,219,254,.28) 0%,transparent 70%);
    pointer-events:none;
  }
  #intro .hero-content{display:flex;flex-direction:column;gap:16px;position:relative;z-index:1;}
  #intro p{margin:0;font-size:16px;color:var(--ink-light);}
  .hero-highlights{display:grid;gap:8px;}
  .hero-highlights h2{
    margin:0;
    font-size:clamp(12px,1.4vw,14px);
    line-height:1.4;
    display:flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:14px;
    background:linear-gradient(120deg,rgba(252,211,77,.28),rgba(255,255,255,.9));
    box-shadow:0 1px 0 rgba(255,255,255,.7) inset;
  }
  .hero-highlights h2::before{content:"✨";font-size:14px;}
  .hero-actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .cta{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    padding:9px 16px;
    border-radius:999px;
    font-weight:700;
    text-decoration:none;
    transition:transform .2s,box-shadow .2s,filter .2s;
    box-shadow:0 8px 18px rgba(15,23,42,.12);
  }
  .cta:hover{transform:translateY(-2px);box-shadow:0 12px 28px rgba(15,23,42,.16);}
  .cta:focus-visible{outline:3px solid rgba(59,130,246,.6);outline-offset:2px;}
  .cta.edo{background:linear-gradient(130deg,#fcd34d,#fbbf24);color:#5c3b00;}
  .cta.sengoku{background:linear-gradient(130deg,#f6d5a4,#f59e0b);color:#5b3510;}
  .cta.muromachi{background:linear-gradient(130deg,#fde68a,#facc15);color:#5b4410;}
  .cta.kamakura{background:linear-gradient(130deg,#f9e2af,#fbcfe8);color:#653a32;}
  .cta.outline{background:rgba(255,255,255,.78);border:2px solid rgba(17,24,39,.12);box-shadow:none;}
  .cta.soft{background:linear-gradient(130deg,#e0f2fe,#bfdbfe);color:#1d4ed8;}
  .cta.success{background:linear-gradient(130deg,#dcfce7,#bbf7d0);color:#166534;}
  .cta.highlight{background:linear-gradient(120deg,#ffd814,#fbbf24);color:#4a3300;}
  .promoBar{
    background:var(--surface);
    border-radius:20px;
    padding:18px 22px;
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    align-items:center;
    box-shadow:0 12px 32px rgba(15,23,42,.12);
    border:1px solid rgba(249,168,38,.15);
  }
  .promoBar .promo-badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:4px 12px;
    border-radius:999px;
    font-weight:700;
    letter-spacing:.08em;
    font-size:12px;
    background:#f59e0b;
    color:#fff;
  }
  .promoBar .title{font-weight:700;color:var(--ink);}
  .promoBar small{color:var(--ink-light);}
  #info{
    padding:12px 16px;
    background:linear-gradient(120deg,rgba(224,242,254,.85),rgba(219,234,254,.85));
    border-radius:18px;
    border:1px solid rgba(59,130,246,.18);
    font-size:15px;
    min-height:40px;
    display:flex;
    align-items:center;
    gap:8px;
    box-shadow:0 6px 16px rgba(15,23,42,.1);
    color:#1e3a5f;
  }
  #info::before{content:"📘";font-size:20px;}

  #town{
    position:relative;width:100%;height:clamp(260px,44vh,520px);background:var(--surface);
    border-radius:24px;border:1px solid rgba(17,24,39,.08);box-shadow:0 20px 48px rgba(15,23,42,.16);overflow:hidden;
  }
  @media (min-width: 1024px){ #town{ height:clamp(320px, 50vh, 640px); } }
  #town > canvas{ display:block;width:100%;height:100%; touch-action:none;
    background-image: radial-gradient(rgba(0,0,0,.04) 1px, transparent 1px);
    background-size: 20px 20px; }

  .place-hud{
    position: fixed; right: 12px; bottom: 12px; z-index: 200;
    display: flex; gap: 8px; padding: 10px; border-radius: 14px;
    background: rgba(255,255,255,.92); box-shadow: 0 12px 30px rgba(15,23,42,.18);
  }
  .place-hud button{
    border: 0; border-radius: 12px; padding: 10px 14px; font-weight: 700;
    box-shadow: 0 3px 8px rgba(15,23,42,.16); cursor: pointer;
    transition:transform .2s,box-shadow .2s;
  }
  .place-hud button:hover{transform:translateY(-1px);}
  .place-hud #btnRotate{ background:#e0f2fe; }
  .place-hud #btnCancel{ background:#fee2e2; }

  #cards{
    display:grid;gap:12px;padding:18px;
    grid-template-columns:repeat(auto-fill, minmax(104px, 1fr));
    background:var(--surface);
    border-radius:24px;
    box-shadow:0 18px 48px rgba(15,23,42,.12);
  }
  @media (min-width: 768px){
    #cards{ grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); }
  }
  .card{
    height:clamp(110px,18vw,140px);border-radius:16px;background:linear-gradient(135deg,rgba(252,211,77,.35),rgba(255,255,255,.9));
    display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;
    cursor:pointer;box-shadow:0 6px 16px rgba(15,23,42,.12);user-select:none;text-align:center;padding:8px;
    transition:transform .2s, box-shadow .2s,filter .2s
  }
  .card:hover{transform:translateY(-4px) scale(1.02);box-shadow:0 14px 28px rgba(15,23,42,.16)}
  .card.done{background:linear-gradient(135deg,rgba(187,247,208,.95),rgba(134,239,172,.9));color:#14532d}

  .villager{position:absolute;font-size:20px;animation:walk 8s linear infinite}
  @keyframes walk{0%{left:2%}50%{left:90%}100%{left:2%}}

  #zukanPanel{position:fixed;inset:0 0 auto 0;height:72%;top:-100%;background:var(--surface);
    border-bottom:3px solid #333;box-shadow:0 18px 36px rgba(15,23,42,.2);
    transition:top .45s ease;z-index:5;overflow:auto}
  #zukanPanel.active{top:0}
  #zukanHead{position:sticky;top:0;background:var(--surface);padding:12px 16px;border-bottom:1px solid #eee;
    display:flex;align-items:center;gap:8px}
  #zukanHead h2{margin:0;font-size:18px}
  #closeZukan{margin-left:auto;border:0;background:#f1f5f9;border-radius:10px;padding:6px 12px;cursor:pointer;font-weight:600}
  .zukanSec{padding:16px}
  .zukanSec h3{margin:8px 0}
  .zCard{display:inline-flex;align-items:center;justify-content:center;width:96px;height:116px;margin:4px;
    border:1px solid #ccc;border-radius:10px;box-shadow:0 6px 12px rgba(15,23,42,.12);white-space:pre-line;text-align:center;padding:6px;background:#fff}
  .locked{background:#f1f5f9;color:#94a3b8}
  #completeMsg{font-size:18px;font-weight:800;color:green;text-align:center;padding:16px}

  .petal{position:fixed;top:-10px;font-size:20px;animation:fall linear forwards;pointer-events:none}
  @keyframes fall{to{transform:translateY(110vh) rotate(360deg);opacity:0}}

  .adbar{position:sticky;bottom:0;background:rgba(255,255,255,.92);border-top:1px solid rgba(15,23,42,.08);
    padding:8px 12px;display:flex;justify-content:center;align-items:center;min-height:56px;
    backdrop-filter:blur(6px);border-radius:18px 18px 0 0;box-shadow:0 -10px 20px rgba(15,23,42,.12)}
  .adslot{width:100%;max-width:728px;height:50px;background:
    repeating-linear-gradient(45deg,#f3f4f6,#f3f4f6 8px,#e5e7eb 8px,#e5e7eb 16px);
    border:1px dashed #bbb;border-radius:12px;display:flex;align-items:center;justify-content:center;
    font-size:12px;color:#666}
  footer{height:12px}

  .landscapeWarn{
    position:fixed;inset:0;background:rgba(0,0,0,.65);color:#fff;display:none;
    align-items:center;justify-content:center;z-index:20;text-align:center;padding:20px
  }
  @media (orientation:landscape) and (max-width: 768px){ .landscapeWarn{display:flex} }

  ruby rt{font-size:.7em;color:#444}
  .yr{font-weight:800;margin-right:2px}

  /* モーダル共通 */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center;
 z-index:100; }
  .modal-overlay.active { display:flex; }
  .modal-box { background:var(--surface); border-radius:18px; max-width:640px; width:92%; max-height:90vh; overflow:auto; padding:24px; box-shadow:0 24px 60px rgba(15,23,42,.3); position:relative; }
  .modal-box h2 { margin-top:0; font-size:20px; }
  .modal-close { position:absolute; top:14px; right:14px; border:0; background:#e2e8f0; border-radius:50%; width:36px; height:36px; cursor:pointer; font-weight:800; display:grid; place-items:center; }
  .profile-card{display:flex;flex-direction:column;gap:12px;align-items:center;text-align:center;}
  @media (min-width:580px){.profile-card{flex-direction:row;text-align:left;align-items:center;}}
  .profile-avatar{width:176px;height:auto;border-radius:20px;box-shadow:0 10px 24px rgba(15,23,42,.18);}
  .profile-meta{display:flex;flex-direction:column;gap:10px;color:var(--ink-light);}
  .profile-meta p{margin:0;}
  .profile-name{font-weight:700;font-size:18px;color:var(--ink);}
  .profile-list{margin:0;padding-left:18px;color:var(--ink-light);}
  .profile-list li{margin-bottom:6px;}
  .socials{display:flex;gap:8px;}
  .chip{display:inline-flex;align-items:center;justify-content:center;padding:8px 12px;border-radius:999px;background:linear-gradient(120deg,#e0f2fe,#bfdbfe);font-weight:700;color:#1d4ed8;text-decoration:none;}
  #contactModal p{color:var(--ink-light);margin:0 0 12px;}
  #contactModal p:last-child{margin:0;}
  #contactModal a{display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(130deg,#fcd34d,#fbbf24);padding:10px 16px;border-radius:999px;font-weight:700;color:#4a3300;text-decoration:none;box-shadow:0 8px 18px rgba(15,23,42,.12);}

  /* ショップモーダル */
  .shop-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;
    align-items:center;justify-content:center;z-index:120}
  .shop-overlay.active{display:flex}
  .shop-box{background:var(--surface);border-radius:20px;max-width:760px;width:94%;max-height:90vh;
    overflow:auto;padding:18px;box-shadow:0 24px 60px rgba(15,23,42,.3);position:relative}
  .shop-box h2{margin:0 0 8px;font-size:18px;}
  .shop-close{position:absolute;top:12px;right:12px;border:0;background:#e2e8f0;border-radius:50%;
    width:36px;height:36px;cursor:pointer;font-weight:800}
  .shop-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
  .shop-card{border:1px solid rgba(15,23,42,.08);border-radius:14px;padding:12px;box-shadow:0 10px 20px rgba(15,23,42,.1);background:var(--surface-soft);display:flex;flex-direction:column;gap:6px}
  .shop-card h4{margin:0 0 4px 0;font-size:15px;color:var(--ink)}
  .shop-card .preview{font-size:28px;height:36px;display:flex;align-items:center;justify-content:center}
  .shop-card .buyrow{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px}
  .shop-card button{border:0;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer;
    box-shadow:0 6px 12px rgba(15,23,42,.12);background:linear-gradient(130deg,#e0f2fe,#bfdbfe);color:#1d4ed8}
  .shop-card .price{color:var(--ink-light)}
  .shop-tip{font-size:13px;color:var(--ink-light);margin:10px 0 0}
  .toolrow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .toolrow .toolbtn{border:1px solid rgba(15,23,42,.12);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer;transition:background .2s,border-color .2s,box-shadow .2s}
  .toolrow .toolbtn.active{background:#e6f4ff;border-color:#8ecbff;box-shadow:0 3px 8px rgba(15,23,42,.12)}

  /* ===== ツールバー ===== */
   #ui-toolbar{
  position: fixed; z-index: 9999; top: 16px; right: 16px;
  display: flex; gap: 8px; align-items: center;
  background: rgba(255,255,255,.9);
  border: 1px solid #e5e7eb; border-radius: 12px; padding: 8px 10px;
  box-shadow: 0 6px 20px rgba(0,0,0,.12);
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
}
#ui-toolbar button{
  appearance: none; border: 1px solid #e5e7eb; border-radius: 10px;
  background: #fff; padding: 6px 10px; cursor: pointer; font-size: 14px;
}
#ui-toolbar button.active{ background: #fcd34d; border-color: #f59e0b; }
#ui-toolbar #ui-hint{ margin-left: 4px; font-size: 13px; color: #374151; }
canvas { outline: none; } /* ドラッグ時の青枠防止 */



    /* ===== ジョイスティック ===== */
.joypad{
  position: fixed; left: 12px; bottom: 12px; z-index: 220;
  width: 120px; height: 120px; touch-action: none; user-select: none;
}
.joypad .joy-base{
  position: absolute; inset: 0;
  border-radius: 999px; background: rgba(255,255,255,.9);
  box-shadow: 0 4px 16px rgba(0,0,0,.18), inset 0 0 0 2px rgba(0,0,0,.08);
}
.joypad .joy-stick{
  position: absolute; left: 50%; top: 50%; width: 56px; height: 56px;
  margin-left: -28px; margin-top: -28px; border-radius: 999px;
  background: rgba(0,0,0,.18); backdrop-filter: blur(2px);
  box-shadow: 0 2px 10px rgba(0,0,0,.22);
  transition: transform .05s linear;
}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:30;}

  </style>
</head>

<body>
<!-- admax -->
<!-- admax -->

<div class="wrap">
  <header>
    <div class="header-inner">
      <h1 class="siteTitle">歴史キッズ｜楽しく学べる！小学生・中学生向け歴史学習サイト</h1>

      <div class="controls">
        <label for="eraSelect">時代：</label>
        <select id="eraSelect" title="時代をえらぶ">
          <option value="edo">江戸時代</option>
          <option value="muromachi">室町時代</option>
          <option value="kamakura">鎌倉時代</option>
          <option value="sengoku">戦国時代</option>
        </select>

        <select id="chapterFilter" title="章をえらぶ">
          <option value="ALL">章：ぜんぶ</option>
        </select>

        <button id="zukanBtn" aria-controls="zukanPanel" aria-expanded="false">図鑑</button>
        <button id="resetBtn" title="進捗を全部消して最初から">リセット</button>

        <!-- 所持金とショップ -->
        <div class="moneybox" aria-live="polite">
          💰 <b id="moneyValue">0</b> 両
        </div>
        <button id="openShopBtn" title="ショップを開く">ショップ</button>
      </div>
    </div>
  </header>

  <main class="content">
    <section id="intro">
      <div class="hero-content">
        <p>
          小学生・中学生・高校生向けの<strong>歴史学習サイト</strong>です。<br>
          <b>江戸・戦国・室町・鎌倉</b>の出来事を、<b>クイズ</b>と<b>年表</b>、<b>カード集め</b>で楽しく学べます（スマホ対応・無料）。
        </p>
        <div class="hero-highlights">
          <h2>戦国、江戸、室町、鎌倉を勉強できる！</h2>
          <h2>テストや受験勉強に役立つ！</h2>
          <h2>3Dで街づくりができる！</h2>
        </div>

        <nav class="hero-actions">
          <a href="#cards" id="playEdo" class="cta edo">江戸時代で遊ぶ</a>
          <a href="#cards" id="playSengoku" class="cta sengoku">戦国時代で遊ぶ</a>
          <a href="#cards" id="playMuromachi" class="cta muromachi">室町時代で遊ぶ</a>
          <a href="#cards" id="playKamakura" class="cta kamakura">鎌倉時代で遊ぶ</a>
          <a href="#zukanPanel" id="openZukan" class="cta outline">図鑑（年表）を見る</a>
          <a href="#" id="openProfile" class="cta soft">プロフィール</a>
          <a href="#" id="openContact" class="cta success">お問い合わせ</a>
        </nav>
         </div>
     </section>

    <!-- PR -->
    <aside class="promoBar" role="note" aria-label="おすすめの本（PR）">
      <span class="promo-badge">PR</span>
      <span class="title">歴史入門にぴったり！<strong>ドラえもんの社会科おもしろ攻略 日本の歴史</strong>（小学館）</span>
      <a id="promoLink" class="cta highlight" href="https://amzn.asia/d/bu7qdsv" target="_blank" rel="noopener sponsored nofollow">
        Amazonで見る
      </a>
      <small>※当サイトはアフィリエイト広告を利用しています</small>
    </aside>

    <div id="info" role="status" aria-live="polite">時代をえらんでカードをめくろう！ 〇の部分だけを「ひらがな」で答えると開くよ。</div> <footer>
  <a href="/Credits.html" rel="nofollow">3D Model Credits</a>
</footer>
   <!-- 🔧 ツールバー -->
<div id="ui-toolbar">
  <button id="btn-select" class="active" title="クリックで建物を選択">選択</button>
  <button id="btn-move"   title="選択した建物をドラッグで移動">移動</button>
  <button id="btn-delete" title="選択orクリックした建物を削除">削除</button>
  <span id="ui-hint">モード: 選択</span>
</div>

 <!-- ======== ここが街（3D） ======== -->
  <div id="town" role="img" aria-label="町エリア"></div>

  <div id="cards" aria-label="カードエリア"></div>

  <section id="zukanPanel" aria-hidden="true">
    <div id="zukanHead">
      <h2>カード図鑑（章ごと）</h2>
      <button id="closeZukan" aria-label="図鑑をとじる">とじる</button>
    </div>
    <div id="zukanList"></div>
    <div id="completeMsg"></div>
  </section>

  <!-- 広告枠 -->
  <div class="adbar" aria-label="広告枠">
    <div class="adslot">広告スペース</div>
  </div>
  <footer aria-hidden="true"></footer>
  </main>

  <!-- プロフィール / お問い合わせ モーダル -->
  <div id="profileModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
    <div class="modal-box">
      <button class="modal-close" data-close>×</button>
      <h2 id="profileTitle">プロフィール</h2>
      <div class="profile-card">
        <img src="https://historykids.github.io/かわいい青いクジラ.png" alt="サイト管理人のアイコン" class="profile-avatar" width="176" height="176" loading="lazy" decoding="async" />
        <div class="profile-meta">
          <div class="profile-name">サイト管理人：<b>しろながす</b></div>
          <p>小学生〜高校生が <b>クイズ・年表・カード</b>で歴史に親しめるサイトを目指して開発・運営しています。</p>
          <ul class="profile-list">
            <li>こどもでも<b>スマホ１台</b>で学べるUIに</li>
            <li>読みやすい <b>ふりがな</b> と <b>ひらがな回答</b>に対応</li>
            <li>学校の <b>自由研究</b>や <b>テスト対策</b>にも活用</li>
          </ul>
          <div class="socials" aria-label="SNSリンク">
            <a class="chip" href="mailto:you@example.com">メール</a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="contactModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="contactTitle">
    <div class="modal-box">
      <button class="modal-close" data-close>×</button>
      <h2 id="contactTitle">お問い合わせ</h2>
      <p>ご意見・ご要望・誤字のご指摘など、お気軽にお知らせください。</p>
      <p><a href="https://docs.google.com/forms/d/e/1FAIpQLSdHvqKAszs5j860tNIeesVlE83pMpP_qP9QrNLuJJaZ9g3h5Q/viewform" target="_blank" rel="noopener">Googleフォームを開く</a></p>
    </div>
  </div>

  <!-- ===== ショップ モーダル ===== -->
  <div id="shopOverlay" class="shop-overlay" role="dialog" aria-modal="true" aria-labelledby="shopTitle">
    <div class="shop-box">
      <button id="shopClose" class="shop-close" aria-label="ショップをとじる">×</button>
      <h2 id="shopTitle">ショップ</h2>
      <div class="toolrow">
        <button class="toolbtn" data-filter="ALL">すべて</button>
        <button class="toolbtn" data-filter="building">建物</button>
        <button class="toolbtn" data-filter="nature">自然</button>
        <button class="toolbtn" data-filter="infrastructure">インフラ</button>
      </div>
      <div id="shopGrid" class="shop-grid" aria-live="polite"></div>
      <p class="shop-tip">クイズに正解すると💰がふえます。買った建物は好きな場所に置けます。</p>
    </div>
  </div>
</div>

<div class="landscapeWarn">縦向きで遊んでね🔄</div>

<!-- クイズ用モーダル -->
<div id="quizModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:30">
  <div class="modal-bg" id="quizBg" style="position:absolute;inset:0;background:rgba(0,0,0,.5)"></div>
  <div class="modal-box" style="position:relative;z-index:1;width:min(92vw,560px);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:14px">
    <div id="quizTitle" class="quiz-title" style="font-weight:800;font-size:16px;margin:0 0 6px 0"></div>
    <p class="quiz-instruction" style="font-size:14px;margin:6px 0 10px 0;color:#444">
      〇のところだけを <b>ひらがな</b> でこたえてね。<br>
      空欄がいくつかあるときは <b>スペース / ・ / 、 / ／</b> で区切ってOK。
      <span id="quizHint" style="color:#666"></span>
    </p>
    <input id="quizInput" type="text" inputmode="text" autocomplete="off"
           placeholder="ここに ひらがな を入力（例：てんぽう）"
           style="width:100%;padding:10px 12px;font-size:16px;border:1px solid #ccc;border-radius:10px" />
    <div class="quiz-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="quizCancel" style="border:0;border-radius:10px;padding:8px 14px;background:#eee;cursor:pointer;box-shadow:0 1px 3px var(--shadow);">やめる</button>
      <button id="quizOk" style="border:0;border-radius:10px;padding:8px 14px;background:#cdeccd;color:#145f14;font-weight:700;cursor:pointer;box-shadow:0 1px 3px var(--shadow);">決定</button>
    </div>
  </div>
</div>

  <!-- スティック（ジョイスティック） -->
<div id="joypad" class="joypad" aria-label="スティック" hidden>
  <div class="joy-base"></div>
  <div class="joy-stick"></div>
</div>


<script>
/* ========== モーダル開閉（プロフィール/お問い合わせ） ========== */
(function(){
  const modals = document.querySelectorAll('.modal-overlay');
  document.getElementById('openProfile')?.addEventListener('click', e=>{ e.preventDefault(); document.getElementById('profileModal').classList.add('active'); });
  document.getElementById('openContact')?.addEventListener('click', e=>{ e.preventDefault(); document.getElementById('contactModal').classList.add('active'); });
  modals.forEach(m=>{
    m.addEventListener('click', e=>{ if(e.target===m) m.classList.remove('active'); });
    m.querySelectorAll('[data-close]').forEach(btn=>btn.addEventListener('click', ()=>m.classList.remove('active')));
  });
})();
</script>

<script>
/* =========================================================
   データセット（江戸／室町／鎌倉／戦国）
   ========================================================= */
const dataSets = {
  /* ---------- 江戸時代 ---------- */
  edo: {
    title: "江戸時代",
    LS_KEY: "cards_edo_complete_v1",
    chapters: {
      "初期": {
        "1603 〇〇幕府がはじまる": { text: "家康が将軍になり、江戸で国の中心が動き出す。", icon: "🏯", year: 1603 },
        "1615 〇〇〇〇の陣":       { text: "大きなたたかいが終わり、豊臣の時代に幕。", icon: "⚔️", year: 1615 },
        "1635 〇〇〇〇交代":          { text: "大名は国と江戸を行き来するきまりに。", icon: "🚶", year: 1635 },
        "1637 島〇〇・天〇〇の乱":  { text: "九州で大きな一揆が起きる。", icon: "🔥", year: 1637 },
        "1639 〇〇〇〇〇船の来航禁止": { text: "外国船の出入りをしめて、交流をせいげん。", icon: "⛵", year: 1639 },
        "1641 〇〇〇での貿易":      { text: "オランダ商館が長崎の出島へ。", icon: "🏝️", year: 1641 },
        "1657 〇〇〇〇の大火":      { text: "江戸の町が大火事。町づくりを立て直す。", icon: "🔥", year: 1657 },
        "1657 〇〇〇〇〇〇へ移転":  { text: "遊郭が浅草千束の新しい場所へ。", icon: "🏮", year: 1657 }
      },
      "中期": {
        "1688 〇〇〇〇文化がさかえる": { text: "町人の文化が花ひらく。歌舞伎や浮世絵が人気。", icon: "🎭", year: 1688 },
        "1716 〇〇〇〇〇の改革":         { text: "吉宗がくらしと財政を立て直す工夫をはじめる。", icon: "📜", year: 1716 },
        "1720 〇〇〇〇をとりいれる":   { text: "海外の学びが広がり、知識がふえる。", icon: "📚", year: 1720 },
        "1720 〇〇〇〇〇のしくみ":     { text: "火事にそなえる町人の組ができる。", icon: "🚒", year: 1720 },
        "1730 〇〇のながれを整える":   { text: "商いのきまりをととのえ、町を元気に。", icon: "🧺", year: 1730 },
        "1775 〇〇〇の時代":           { text: "商いを活かす政治でお金の流れをよくする試み。", icon: "💹", year: 1775 },
        "1783 〇〇〇〇のききん":       { text: "寒さや不作で食べ物がたりなくなる。", icon: "🌾", year: 1783 }
      },
      "幕末": {
        "1787 〇〇〇〇の改革":         { text: "くらしをひきしめ、教育も大切にする方針。", icon: "📝", year: 1787 },
        "1825 〇〇〇〇〇打払令":       { text: "近づく外国船を追いはらうきまり。", icon: "📣", year: 1825 },
        "1837 〇〇〇〇〇〇〇〇〇〇の乱": { text: "大阪で人びとの苦しさが爆発。", icon: "⚠️", year: 1837 },
        "1841 〇〇〇〇の改革":           { text: "町の決まりを見直し、ぜいたくをおさえる。", icon: "📏", year: 1841 },
        "1853 〇〇〇〇が来る":         { text: "アメリカの船が浦賀に来航。", icon: "⛴️", year: 1853 },
        "1854 〇〇〇条約":             { text: "日本は港を開き、交流をはじめる。", icon: "🤝", year: 1854 },
        "1858 〇〇〇〇の条約":         { text: "いくつかの国とむすび、貿易が広がる。", icon: "🌐", year: 1858 },
        "1858 〇〇〇〇の大獄":         { text: "意見のちがいで多くの人が処罰される。", icon: "⚖️", year: 1858 },
        "1860 〇〇〇〇〇〇〇〇の変":   { text: "政治の対立が事件に。", icon: "🗡️", year: 1860 },
        "1867 〇〇〇〇奉還":           { text: "政（まつりごと）を朝廷にお返し。", icon: "🗝️", year: 1867 },
        "1868 〇〇〇へ":               { text: "新しい時代のスタート！", icon: "🌸", year: 1868 }
      }
    },
    ruby: {
      "1603 〇〇幕府がはじまる": "〇〇<ruby>幕府<rt>ばくふ</rt></ruby>がはじまる",
      "1615 〇〇〇〇の陣": "〇〇〇〇の<ruby>陣<rt>じん</rt></ruby>",
      "1635 〇〇〇〇交代": "〇〇〇〇<ruby>交代<rt>こうたい</rt></ruby>",
      "1637 島〇〇・天〇〇の乱": "島〇〇・天〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1639 〇〇〇〇〇船の来航禁止": "〇〇〇〇〇<ruby>船<rt>せん</rt></ruby>の<ruby>来航<rt>らいこう</rt></ruby><ruby>禁止<rt>きんし</rt></ruby>",
      "1641 〇〇〇での貿易": "〇〇〇での<ruby>貿易<rt>ぼうえき</rt></ruby>",
      "1657 〇〇〇〇の大火": "〇〇〇〇の<ruby>大火<rt>たいか</rt></ruby>",
      "1657 〇〇〇〇〇〇へ移転": "〇〇〇〇〇〇へ<ruby>移転<rt>いてん</rt></ruby>",
      "1688 〇〇〇〇文化がさかえる": "〇〇〇〇<ruby>文化<rt>ぶんか</rt></ruby>がさかえる",
      "1716 〇〇〇〇〇の改革": "〇〇〇〇〇の<ruby>改革<rt>かいかく</rt></ruby>",
      "1720 〇〇〇〇をとりいれる": "〇〇〇〇をとりいれる",
      "1720 〇〇〇〇〇のしくみ": "〇〇〇〇〇のしくみ",
      "1730 〇〇のながれを整える": "〇〇のながれを<ruby>整える<rt>ととのえる</rt></ruby>",
      "1775 〇〇〇の時代": "〇〇〇の<ruby>時代<rt>じだい</rt></ruby>",
      "1783 〇〇〇〇のききん": "〇〇〇〇のききん",
      "1787 〇〇〇〇の改革": "〇〇〇〇の<ruby>改革<rt>かいかく</rt></ruby>",
      "1825 〇〇〇〇〇打払令": "〇〇〇〇〇<ruby>打払令<rt>うちはらいれい</rt></ruby>",
      "1837 〇〇〇〇〇〇〇〇〇〇の乱": "〇〇〇〇〇〇〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1841 〇〇〇〇の改革": "〇〇〇〇の<ruby>改革<rt>かいかく</rt></ruby>",
      "1853 〇〇〇〇が来る": "〇〇〇〇が<ruby>来<rt>く</rt></ruby>る",
      "1854 〇〇〇条約": "〇〇〇<ruby>条約<rt>じょうやく</rt></ruby>",
      "1858 〇〇〇〇の条約": "〇〇〇〇の<ruby>条約<rt>じょうやく</rt></ruby>",
      "1858 〇〇〇〇の大獄": "〇〇〇〇の<ruby>大獄<rt>たいごく</rt></ruby>",
      "1860 〇〇〇〇〇〇〇〇の変": "〇〇〇〇〇〇〇〇の<ruby>変<rt>へん</rt></ruby>",
      "1867 〇〇〇〇奉還": "〇〇〇〇<ruby>奉還<rt>ほうかん</rt></ruby>",
      "1868 〇〇〇へ": "〇〇〇へ"
    },
    blanks: {
      "1603 〇〇幕府がはじまる": ["えど"],
      "1615 〇〇〇〇の陣": ["おおさか"],
      "1635 〇〇〇〇交代": ["さんきん"],
      "1637 島〇〇・天〇〇の乱": ["ばら","くさ"],
      "1639 〇〇〇〇〇船の来航禁止": ["ぽるとがる"],
      "1641 〇〇〇での貿易": ["でじま"],
      "1657 〇〇〇〇の大火": ["めいれき"],
      "1657 〇〇〇〇〇〇へ移転": ["しんよしわら"],
      "1688 〇〇〇〇文化がさかえる": ["げんろく"],
      "1716 〇〇〇〇〇の改革": ["きょうほう"],
      "1720 〇〇〇〇をとりいれる": ["ようしょ"],
      "1720 〇〇〇〇〇のしくみ": ["まちびけし"],
      "1730 〇〇のながれを整える": ["もの"],
      "1775 〇〇〇の時代": ["たぬま"],
      "1783 〇〇〇〇のききん": ["てんめい"],
      "1787 〇〇〇〇の改革": ["かんせい"],
      "1825 〇〇〇〇〇打払令": ["いこくせん"],
      "1837 〇〇〇〇〇〇〇〇〇〇の乱": ["おおしおへいはちろう"],
      "1841 〇〇〇〇の改革": ["てんぽう"],
      "1853 〇〇〇〇が来る": ["くろふね"],
      "1854 〇〇〇条約": ["わしん"],
      "1858 〇〇〇〇の条約": ["あんせい"],
      "1858 〇〇〇〇の大獄": ["あんせい"],
      "1860 〇〇〇〇〇〇〇〇の変": ["さくらだもんがい"],
      "1867 〇〇〇〇奉還": ["たいせい"],
      "1868 〇〇〇へ": ["めいじ"]
    }
  },

  /* ---------- 室町時代 ---------- */
  muromachi: {
    title: "室町時代",
    LS_KEY: "cards_muromachi_complete_v1",
    chapters: {
      "初期（南北朝〜）": {
        "1336 〇〇〇〇幕府がはじまる": { text: "足利氏の幕府が京都で始まる。", icon: "🏯", year: 1336 },
        "1392 〇〇〇〇〇〇〇統一":       { text: "南朝と北朝がひとつになる。", icon: "🤝", year: 1392 },
        "1397 〇〇〇〇が建てられる":   { text: "きらびやかな建物（鹿苑寺）。", icon: "🏯", year: 1397 },
        "1390 〇〇〇〇文化がさかえる": { text: "能や茶の湯など都の文化が発展。", icon: "🎭", year: 1390 },
        "1401 〇〇〇〇貿易がはじまる": { text: "明との勘合（証明）を用いた貿易。", icon: "🛶", year: 1401 }
      },
      "中期（文化と争い）": {
        "1439 〇〇〇〇〇の乱":         { text: "関東で大きな戦い（将軍側と対立）。", icon: "⚔️", year: 1439 },
        "1441 〇〇〇の乱":             { text: "将軍が討たれる事件（赤松氏ら）。", icon: "⚠️", year: 1441 },
        "1467 〇〇〇〇の乱":           { text: "京都が荒廃、のちの戦国時代へ。", icon: "🔥", year: 1467 },
        "1485 〇〇〇〇国一揆":         { text: "人びとが協力して自治（山城国）。", icon: "🛡️", year: 1485 },
        "1489 〇〇〇〇が建てられる":   { text: "静かな美（慈照寺・銀閣）。", icon: "🏯", year: 1489 },
        "1493 〇〇〇〇の政変":         { text: "細川氏の政変で権力が移る。", icon: "🌀", year: 1493 }
      },
      "後期（戦国の入口）": {
        "1543 〇〇〇〇伝来":           { text: "新しい道具が日本へ（鉄砲）。", icon: "🔫", year: 1543 },
        "1549 〇〇〇〇教伝来":         { text: "キリスト教が日本に広がる。", icon: "⛪", year: 1549 },
        "1555 〇〇〇〇〇の戦い":       { text: "厳島の戦い、武将が勢力拡大。", icon: "🗺️", year: 1555 },
        "1573 〇〇〇〇幕府がおわる":   { text: "将軍追放で幕府が終わりへ。", icon: "🌅", year: 1573 }
      }
    },
    ruby: {
      "1336 〇〇〇〇幕府がはじまる": "〇〇〇〇<ruby>幕府<rt>ばくふ</rt></ruby>がはじまる",
      "1392 〇〇〇〇〇〇〇統一":       "〇〇〇〇〇〇〇<ruby>統一<rt>とういつ</rt></ruby>",
      "1397 〇〇〇〇が建てられる":   "〇〇〇〇が<ruby>建<rt>た</rt></ruby>てられる",
      "1390 〇〇〇〇文化がさかえる": "〇〇〇〇<ruby>文化<rt>ぶんか</rt></ruby>がさかえる",
      "1401 〇〇〇〇貿易がはじまる": "〇〇〇〇<ruby>貿易<rt>ぼうえき</rt></ruby>がはじまる",
      "1439 〇〇〇〇〇の乱":         "〇〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1441 〇〇〇の乱":             "〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1467 〇〇〇〇の乱":           "〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1485 〇〇〇〇国一揆":         "〇〇〇〇<ruby>国<rt>くに</rt></ruby><ruby>一揆<rt>いっき</rt></ruby>",
      "1489 〇〇〇〇が建てられる":   "〇〇〇〇が<ruby>建<rt>た</rt></ruby>てられる",
      "1493 〇〇〇〇の政変":         "〇〇〇〇の<ruby>政変<rt>せいへん</rt></ruby>",
      "1543 〇〇〇〇伝来":           "〇〇〇〇<ruby>伝来<rt>でんらい</rt></ruby>",
      "1549 〇〇〇〇教伝来":         "〇〇〇〇<ruby>教<rt>きょう</rt></ruby><ruby>伝来<rt>でんらい</rt></ruby>",
      "1555 〇〇〇〇〇の戦い":       "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1573 〇〇〇〇幕府がおわる":   "〇〇〇〇<ruby>幕府<rt>ばくふ</rt></ruby>が<ruby>終<rt>お</rt></ruby>わる"
    },
    blanks: {
      "1336 〇〇〇〇幕府がはじまる": ["むろまち"],
      "1392 〇〇〇〇〇〇〇統一":       ["なんぼくちょう"],
      "1397 〇〇〇〇が建てられる":   ["きんかく"],
      "1390 〇〇〇〇文化がさかえる": ["きたやま"],
      "1401 〇〇〇〇貿易がはじまる": ["かんごう"],
      "1439 〇〇〇〇〇の乱":         ["えいきょう"],
      "1441 〇〇〇の乱":             ["かきつ"],
      "1467 〇〇〇〇の乱":           ["おうにん"],
      "1485 〇〇〇〇国一揆":         ["やましろ"],
      "1489 〇〇〇〇が建てられる":   ["ぎんかく"],
      "1493 〇〇〇〇の政変":         ["めいおう"],
      "1543 〇〇〇〇伝来":           ["てっぽう"],
      "1549 〇〇〇〇教伝来":         ["きりすと"],
      "1555 〇〇〇〇〇の戦い":       ["いつくしま"],
      "1573 〇〇〇〇幕府がおわる":   ["むろまち"]
    }
  },

  /* ---------- 鎌倉時代 ---------- */
  kamakura: {
    title: "鎌倉時代",
    LS_KEY: "cards_kamakura_complete_v1",
    chapters: {
      "初期（源平〜創設）": {
        "1180 〇〇〇〇合戦がはじまる": { text: "源氏と平氏の大きなたたかいが始まる。", icon: "⚔️", year: 1180 },
        "1185 〇〇〇〇〇の戦い":       { text: "壇ノ浦で勝敗が決まる。", icon: "🚩", year: 1185 },
        "1185 〇〇〇・〇〇〇の設置":   { text: "国ごとに守る人・土地をおさめる人が置かれる。", icon: "🛡️", year: 1185 },
        "1185 〇〇〇〇幕府がはじまる": { text: "武士の政治が本格スタート。", icon: "🏯", year: 1185 },
        "1192 〇〇〇〇が将軍に":       { text: "よりともが将軍になる。", icon: "👑", year: 1192 }
      },
      "中期（執権政治）": {
        "1203 〇〇〇〇政治がはじまる": { text: "北条氏がまとめる政治（執権政治）。", icon: "📜", year: 1203 },
        "1213 〇〇合戦":               { text: "和田氏とのたたかい。", icon: "⚔️", year: 1213 },
        "1221 〇〇〇〇の乱":           { text: "朝廷との大きな対立（承久の乱）。", icon: "⚠️", year: 1221 },
        "1232 〇〇〇〇〇〇〇〇〇が定まる": { text: "武士のルール（御成敗式目）ができる。", icon: "📖", year: 1232 },
        "1247 〇〇〇合戦":             { text: "有力武士のあらそい（宝治合戦）。", icon: "🛡️", year: 1247 },
        "1252 〇〇〇〇ができる":       { text: "鎌倉大仏がつくられる。", icon: "🗿", year: 1252 }
      },
      "後期（元寇〜滅亡）": {
        "1274 〇〇〇〇の役":           { text: "元が攻めてくる（文永の役）。", icon: "⛴️", year: 1274 },
        "1281 〇〇〇〇の役":           { text: "ふたたび元が攻める（弘安の役）。", icon: "⛴️", year: 1281 },
        "1297 〇〇〇〇〇〇が出る":     { text: "借金をゆるす命令（徳政令）。", icon: "📢", year: 1297 },
        "1305 〇〇〇〇騒動":           { text: "有力者どうしの対立（霜月騒動）。", icon: "🌪️", year: 1305 },
        "1331 〇〇〇〇の乱":           { text: "朝廷がたちあがる（元弘の乱）。", icon: "⚠️", year: 1331 },
        "1333 〇〇〇〇幕府がほろぶ":   { text: "鎌倉幕府が終わる。", icon: "🌅", year: 1333 }
      },
      "文化（新しい仏教）": {
        "1175 〇〇〇〇宗が広まる":     { text: "法然の教え（浄土宗）。", icon: "🙏", year: 1175 },
        "1191 〇〇〇〇宗が伝わる":     { text: "栄西の教え（臨済宗）。", icon: "🧘", year: 1191 },
        "1224 〇〇〇〇真宗が広まる":   { text: "親鸞の教え（浄土真宗）。", icon: "🙏", year: 1224 },
        "1227 〇〇〇宗が広まる":       { text: "一遍の教え（時宗）。", icon: "🙏", year: 1227 },
        "1247 〇〇〇〇宗が広まる":     { text: "道元の教え（曹洞宗）。", icon: "🧘", year: 1247 },
        "1253 〇〇〇〇宗が広まる":     { text: "日蓮の教え（日蓮宗）。", icon: "🕊️", year: 1253 }
      }
    },
    ruby: {
      "1180 〇〇〇〇合戦がはじまる": "〇〇〇〇<ruby>合戦<rt>かっせん</rt></ruby>がはじまる",
      "1185 〇〇〇〇〇の戦い":       "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1185 〇〇〇・〇〇〇の設置":   "〇〇〇・〇〇〇の<ruby>設置<rt>せっち</rt></ruby>",
      "1185 〇〇〇〇幕府がはじまる": "〇〇〇〇<ruby>幕府<rt>ばくふ</rt></ruby>がはじまる",
      "1192 〇〇〇〇が将軍に":       "〇〇〇〇が<ruby>将軍<rt>しょうぐん</rt></ruby>に",
      "1203 〇〇〇〇政治がはじまる": "〇〇〇〇<ruby>政治<rt>せいじ</rt></ruby>がはじまる",
      "1213 〇〇合戦":               "〇〇<ruby>合戦<rt>かっせん</rt></ruby>",
      "1221 〇〇〇〇の乱":           "〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1232 〇〇〇〇〇〇〇〇〇が定まる": "〇〇〇〇〇〇〇〇〇が<ruby>定<rt>さだ</rt></ruby>まる",
      "1247 〇〇〇合戦":             "〇〇〇<ruby>合戦<rt>かっせん</rt></ruby>",
      "1252 〇〇〇〇ができる":       "〇〇〇〇ができる",
      "1274 〇〇〇〇の役":           "〇〇〇〇の<ruby>役<rt>えき</rt></ruby>",
      "1281 〇〇〇〇の役":           "〇〇〇〇の<ruby>役<rt>えき</rt></ruby>",
      "1297 〇〇〇〇〇〇が出る":     "〇〇〇〇〇〇が<ruby>出<rt>で</rt></ruby>る",
      "1305 〇〇〇〇騒動":           "〇〇〇〇<ruby>騒動<rt>そうどう</rt></ruby>",
      "1331 〇〇〇〇の乱":           "〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1333 〇〇〇〇幕府がほろぶ":   "〇〇〇〇<ruby>幕府<rt>ばくふ</rt></ruby>がほろぶ",
      "1175 〇〇〇〇宗が広まる":     "〇〇〇〇<ruby>宗<rt>しゅう</rt></ruby>が広まる",
      "1191 〇〇〇〇宗が伝わる":     "〇〇〇〇<ruby>宗<rt>しゅう</rt></ruby>が<ruby>伝<rt>つた</rt></ruby>わる",
      "1224 〇〇〇〇真宗が広まる":   "〇〇〇〇<ruby>真宗<rt>しんしゅう</rt></ruby>が広まる",
      "1227 〇〇〇宗が広まる":       "〇〇〇<ruby>宗<rt>しゅう</rt></ruby>が広まる",
      "1247 〇〇〇〇宗が広まる":     "〇〇〇〇<ruby>宗<rt>しゅう</rt></ruby>が広まる",
      "1253 〇〇〇〇宗が広まる":     "〇〇〇〇<ruby>宗<rt>しゅう</rt></ruby>が広まる"
    },
    blanks: {
      "1180 〇〇〇〇合戦がはじまる": ["げんぺい"],
      "1185 〇〇〇〇〇の戦い":       ["たんのうら"],
      "1185 〇〇〇・〇〇〇の設置":   ["しゅご","じとう"],
      "1185 〇〇〇〇幕府がはじまる": ["かまくら"],
      "1192 〇〇〇〇が将軍に":       ["よりとも"],
      "1203 〇〇〇〇政治がはじまる": ["しっけん"],
      "1213 〇〇合戦":               ["わだ"],
      "1221 〇〇〇〇の乱":           ["じょうきゅう"],
      "1232 〇〇〇〇〇〇〇〇〇が定まる": ["ごせいばいしきもく"],
      "1247 〇〇〇合戦":             ["ほうじ"],
      "1252 〇〇〇〇ができる":       ["だいぶつ"],
      "1274 〇〇〇〇の役":           ["ぶんえい"],
      "1281 〇〇〇〇の役":           ["こうあん"],
      "1297 〇〇〇〇〇〇が出る":     ["とくせいれい"],
      "1305 〇〇〇〇騒動":           ["しもつき"],
      "1331 〇〇〇〇の乱":           ["げんこう"],
      "1333 〇〇〇〇幕府がほろぶ":   ["かまくら"],
      "1175 〇〇〇〇宗が広まる":     ["じょうど"],
      "1191 〇〇〇〇宗が伝わる":     ["りんざい"],
      "1224 〇〇〇〇真宗が広まる":   ["じょうど"],
      "1227 〇〇〇宗が広まる":       ["じしゅう"],
      "1247 〇〇〇〇宗が広まる":     ["そうとう"],
      "1253 〇〇〇〇宗が広まる":     ["にちれん"]
    }
  },

  /* ---------- 戦国時代 ---------- */
  sengoku: {
    title: "戦国時代",
    LS_KEY: "cards_sengoku_complete_v1",
    chapters: {
      "前期（戦乱のはじまり）": {
        "1467 〇〇〇〇の乱":                { text: "京都で大きな戦いがはじまり、全国に広がる。", icon: "🔥", year: 1467 },
        "1485 〇〇〇〇国一揆":              { text: "人びとが協力して自治（山城国）。", icon: "🛡️", year: 1485 }
      },
      "群雄割拠": {
        "1543 〇〇〇〇伝来":                { text: "新しい武器が伝わる（鉄砲）。", icon: "🔫", year: 1543 },
        "1549 〇〇〇〇教伝来":              { text: "キリスト教が日本に広がる。", icon: "⛪", year: 1549 },
        "1555 〇〇〇〇〇の戦い":            { text: "厳島の戦い、武将が勢力拡大。", icon: "🗺️", year: 1555 },
        "1560 〇〇〇〇〇の戦い":            { text: "桶狭間の戦い、奇襲でかつ。", icon: "⚔️", year: 1560 },
        "1561 〇〇〇〇〇〇の戦い":          { text: "川中島の戦い、名将どうしが激突。", icon: "⚔️", year: 1561 },
        "1567 〇〇に改名（稲葉山→〜）":    { text: "城下町の名をあらためる（岐阜）。", icon: "🏯", year: 1567 },
        "1568 〇〇〇〇が京都に入る":        { text: "都をおさえて天下へ進む。", icon: "🏯", year: 1568 }
      },
      "統一へ": {
        "1570 〇〇〇〇の戦い":              { text: "姉川の戦い。", icon: "⚔️", year: 1570 },
        "1571 〇〇〇〇〇焼き討ち":          { text: "比叡山を攻める。", icon: "🔥", year: 1571 },
        "1573 〇〇〇〇幕府がおわる":        { text: "室町幕府の終わり。", icon: "🌅", year: 1573 },
        "1575 〇〇〇〇の戦い":              { text: "長篠の戦い、鉄砲で勝つ。", icon: "🔫", year: 1575 },
        "1576 〇〇〇城を築く":              { text: "安土城をつくる。", icon: "🏰", year: 1576 },
        "1582 〇〇〇〇〇の変":              { text: "本能寺の変。", icon: "🗡️", year: 1582 },
        "1582 〇〇〇〇の戦い":              { text: "山崎の戦い。", icon: "⚔️", year: 1582 },
        "1583 〇〇〇〇〇の戦い":            { text: "賤ヶ岳の戦い。", icon: "⚔️", year: 1583 },
        "1584 〇〇〇・〇〇〇〇の戦い":      { text: "小牧・長久手の戦い。", icon: "⚔️", year: 1584 },
        "1585 〇〇〇〇になる":              { text: "関白になる。", icon: "🎖️", year: 1585 },
        "1587 〇〇〇〇〇〇を平定":          { text: "九州をおさめる。", icon: "🗾", year: 1587 },
        "1588 〇〇〇〇〇〇〇令":            { text: "刀狩令を出す。", icon: "📢", year: 1588 },
        "1590 〇〇〇〇の戦い":              { text: "小田原の戦い。", icon: "⚔️", year: 1590 },
        "1591 〇〇〇〇〇〇〇〇が出る":      { text: "身分統制令を出す。", icon: "📜", year: 1591 },
        "1592 〇〇〇〇〇〇〇の役":          { text: "朝鮮へ出兵（文禄の役）。", icon: "⛴️", year: 1592 },
        "1597 〇〇〇〇〇〇〇〇の役":        { text: "ふたたび出兵（慶長の役）。", icon: "⛴️", year: 1597 },
        "1598 〇〇〇〇がなくなる":          { text: "秀吉が亡くなる。", icon: "🕊️", year: 1598 },
        "1600 〇〇〇〇〇の戦い":            { text: "関ヶ原の戦い。", icon: "⚔️", year: 1600 }
      },
      "政策と町づくり": {
        "1577 〇〇〇〇・〇〇〇をすすめる":  { text: "楽市・楽座をすすめ、商いが活発に。", icon: "🛍️", year: 1577 },
        "1582 〇〇〇〇検地がすすむ":        { text: "田んぼの広さをはかり、税を決める（太閤検地）。", icon: "📏", year: 1582 },
        "1583 〇〇〇〇城を築く":            { text: "大阪城を築く。", icon: "🏯", year: 1583 }
      }
    },
    ruby: {
      "1467 〇〇〇〇の乱":                 "〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1485 〇〇〇〇国一揆":               "〇〇〇〇<ruby>国<rt>くに</rt></ruby><ruby>一揆<rt>いっき</rt></ruby>",
      "1543 〇〇〇〇伝来":                 "〇〇〇〇<ruby>伝来<rt>でんらい</rt></ruby>",
      "1549 〇〇〇〇教伝来":               "〇〇〇〇<ruby>教<rt>きょう</rt></ruby><ruby>伝来<rt>でんらい</rt></ruby>",
      "1555 〇〇〇〇〇の戦い":             "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1560 〇〇〇〇〇の戦い":             "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1561 〇〇〇〇〇〇の戦い":           "〇〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1567 〇〇に改名（稲葉山→〜）":     "〇〇に<ruby>改名<rt>かいめい</rt></ruby>（<ruby>稲葉山<rt>いなばやま</rt></ruby>→〜）",
      "1568 〇〇〇〇が京都に入る":         "〇〇〇〇が<ruby>京都<rt>きょうと</rt></ruby>に<ruby>入<rt>はい</rt></ruby>る",
      "1570 〇〇〇〇の戦い":               "〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1571 〇〇〇〇〇焼き討ち":           "〇〇〇〇〇<ruby>焼<rt>や</rt></ruby>き<ruby>討<rt>う</rt></ruby>ち",
      "1573 〇〇〇〇幕府がおわる":         "〇〇〇〇<ruby>幕府<rt>ばくふ</rt></ruby>が<ruby>終<rt>お</rt></ruby>わる",
      "1575 〇〇〇〇の戦い":               "〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1576 〇〇〇城を築く":               "〇〇〇<ruby>城<rt>じょう</rt></ruby>を<ruby>築<rt>きず</rt></ruby>く",
      "1582 〇〇〇〇〇の変":               "〇〇〇〇〇の<ruby>変<rt>へん</rt></ruby>",
      "1582 〇〇〇〇の戦い":               "〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1583 〇〇〇〇〇の戦い":             "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1584 〇〇〇・〇〇〇〇の戦い":       "〇〇〇・〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1585 〇〇〇〇になる":               "〇〇〇〇に<ruby>成<rt>な</rt></ruby>る",
      "1587 〇〇〇〇〇〇を平定":           "〇〇〇〇〇〇を<ruby>平定<rt>へいてい</rt></ruby>",
      "1588 〇〇〇〇〇〇〇令":             "〇〇〇〇〇〇〇<ruby>令<rt>れい</rt></ruby>",
      "1590 〇〇〇〇の戦い":               "〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1591 〇〇〇〇〇〇〇〇が出る":       "〇〇〇〇〇〇〇〇が<ruby>出<rt>で</rt></ruby>る",
      "1592 〇〇〇〇〇〇〇の役":           "〇〇〇〇〇〇〇の<ruby>役<rt>えき</rt></ruby>",
      "1597 〇〇〇〇〇〇〇〇の役":         "〇〇〇〇〇〇〇〇の<ruby>役<rt>えき</rt></ruby>",
      "1598 〇〇〇〇がなくなる":           "〇〇〇〇が<ruby>亡<rt>な</rt></ruby>くなる",
      "1600 〇〇〇〇〇の戦い":             "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1577 〇〇〇〇・〇〇〇をすすめる":   "〇〇〇〇・〇〇〇を<ruby>勧<rt>すす</rt></ruby>める",
      "1582 〇〇〇〇検地がすすむ":         "〇〇〇〇<ruby>検地<rt>けんち</rt></ruby>がすすむ",
      "1583 〇〇〇〇城を築く":             "〇〇〇〇<ruby>城<rt>じょう</rt></ruby>を<ruby>築<rt>きず</rt></ruby>く"
    },
    blanks: {
      "1467 〇〇〇〇の乱":                ["おうにん"],
      "1485 〇〇〇〇国一揆":              ["やましろ"],
      "1543 〇〇〇〇伝来":                ["てっぽう"],
      "1549 〇〇〇〇教伝来":              ["きりすと"],
      "1555 〇〇〇〇〇の戦い":            ["いつくしま"],
      "1560 〇〇〇〇〇の戦い":            ["おけはざま"],
      "1561 〇〇〇〇〇〇の戦い":          ["かわなかじま"],
      "1567 〇〇に改名（稲葉山→〜）":    ["ぎふ"],
      "1568 〇〇〇〇が京都に入る":        ["のぶなが"],
      "1570 〇〇〇〇の戦い":              ["あねがわ"],
      "1571 〇〇〇〇〇焼き討ち":          ["ひえいざん"],
      "1573 〇〇〇〇幕府がおわる":        ["むろまち"],
      "1575 〇〇〇〇の戦い":              ["ながしの"],
      "1576 〇〇〇城を築く":              ["あづち"],
      "1582 〇〇〇〇〇の変":              ["ほんのうじ"],
      "1582 〇〇〇〇の戦い":              ["やまざき"],
      "1583 〇〇〇〇〇の戦い":            ["しずがたけ"],
      "1584 〇〇〇・〇〇〇〇の戦い":      ["こまき","ながくて"],
      "1585 〇〇〇〇になる":              ["かんぱく"],
      "1587 〇〇〇〇〇〇を平定":          ["きゅうしゅう"],
      "1588 〇〇〇〇〇〇〇令":            ["かたながりれい"],
      "1590 〇〇〇〇の戦い":              ["おだわら"],
      "1591 〇〇〇〇〇〇〇〇が出る":      ["みぶんとうせいれい"],
      "1592 〇〇〇〇〇〇〇の役":          ["ぶんろくのえき"],
      "1597 〇〇〇〇〇〇〇〇の役":        ["けいちょうのえき"],
      "1598 〇〇〇〇がなくなる":          ["ひでよし"],
      "1600 〇〇〇〇〇の戦い":            ["せきがはら"],
      "1577 〇〇〇〇・〇〇〇をすすめる":  ["らくいち","らくざ"],
      "1582 〇〇〇〇検地がすすむ":        ["たいこう"],
      "1583 〇〇〇〇城を築く":            ["おおさか"]
    }
  }
};
</script>

<script>
/* ========= メインロジック（UI/状態管理） ========= */
function onlyHiraAndSep(s){ return /^[\u3041-\u3096\s・,，、/／]+$/.test(s); }
function splitTokens(ans){ let s=ans.replace(/[・,，、/／]+/g,' ').replace(/\s+/g,' ').trim();return s? s.split(' '):[]; }
function normalizeTokens(arr){ return arr.map(s=>s.replace(/\s+/g,'').trim()); }

const eraSelectEl     = document.getElementById("eraSelect");
const chapterFilterEl = document.getElementById("chapterFilter");
const cardsWrap       = document.getElementById("cards");
const infoBoxEl       = document.getElementById("info");
const moneyEl         = document.getElementById("moneyValue");
const zukanPanelEl    = document.getElementById("zukanPanel");
const zukanBtnEl      = document.getElementById("zukanBtn");
const closeZukanEl    = document.getElementById("closeZukan");
const resetBtnEl      = document.getElementById("resetBtn");
const openShopBtnEl   = document.getElementById("openShopBtn");
const shopOverlayEl   = document.getElementById("shopOverlay");
const shopCloseEl     = document.getElementById("shopClose");
const shopGridEl      = document.getElementById("shopGrid");

/* スマホHUD */
const placeHud  = document.getElementById("placeHud");
const btnRotate = document.getElementById("btnRotate");
const btnCancel = document.getElementById("btnCancel");

/* 進捗＆所持金 */
const COLS = 30, ROWS = 18;
let currentEra = eraSelectEl ? eraSelectEl.value : "edo";
let gotCards   = {};
let money      = 0;
let cityBuildings = []; // [{id,type,x,y,rot}...]

function persist(){
  try{
    localStorage.setItem(dataSets[currentEra].LS_KEY, JSON.stringify(gotCards));
    localStorage.setItem("money_v1", String(money));
    localStorage.setItem("city_v1", JSON.stringify(cityBuildings));
  }catch(e){}
}
function loadProgress(){
  try{ gotCards = JSON.parse(localStorage.getItem(dataSets[currentEra].LS_KEY) || "{}"); }catch{ gotCards = {}; }
  money = Number(localStorage.getItem("money_v1") || "0");
  try{ cityBuildings = JSON.parse(localStorage.getItem("city_v1") || "[]"); }catch{ cityBuildings = []; }
  moneyEl.textContent = money;
  sync3DLayer();
}

/* 図鑑 */
zukanBtnEl?.addEventListener("click", ()=>{ zukanPanelEl.classList.add("active"); zukanPanelEl.setAttribute("aria-hidden","false"); });
closeZukanEl?.addEventListener("click", ()=>{ zukanPanelEl.classList.remove("active"); zukanPanelEl.setAttribute("aria-hidden","true"); });

/* 章プルダウン */
function buildChapterFilter(){
  if(!chapterFilterEl) return;
  chapterFilterEl.innerHTML = `<option value="ALL">章：ぜんぶ</option>`;
  const chapters = dataSets[currentEra].chapters;
  Object.keys(chapters).forEach(ch=>{
    const opt = document.createElement("option");
    opt.value = ch; opt.textContent = ch;
    chapterFilterEl.appendChild(opt);
  });
}

  function pickOnGround(ev){
  setPointerFromEvent(ev);
  raycaster.setFromCamera(pointer, camera);

  const hit = raycaster.intersectObject(ground, false)[0];
  if (hit) return { cell: worldToGrid(hit.point.x, hit.point.z), hit };

  // 予備: y=0 の平面
  const plane = new THREE.Plane(new THREE.Vector3(0,1,0), 0);
  const p3 = new THREE.Vector3();
  if (raycaster.ray.intersectPlane(plane, p3)) {
    return { cell: worldToGrid(p3.x, p3.z), hit: null };
  }
  return null;
}

  function openQuiz(name){
  currentQuizName = name;
  quizTitleEl.textContent = name;
  quizHintEl.textContent  = "（例：てんぽう／わしん など ひらがなで）";
  quizHintEl.style.color = "#666"; // ★追加：色を毎回リセット
  quizInputEl.value = "";
  quizModalEl.style.display = "flex";
  setTimeout(()=>quizInputEl.focus(), 0);
}


/* ルビ表記 */
function withRubyMasked(fullName){
  const m = dataSets[currentEra].ruby[fullName];
  if(m){
    const sp = fullName.indexOf(" ");
    const year = fullName.slice(0, sp);
    return `<span class="yr">${year}</span> ${m}`;
  }
  return fullName;
}

/* カード生成 */
function buildCards(){
  if(!cardsWrap) return;
  cardsWrap.innerHTML = "";
  const sel = chapterFilterEl ? chapterFilterEl.value : "ALL";
  const chapters = dataSets[currentEra].chapters;

  Object.keys(chapters).forEach(ch=>{
    if(sel !== "ALL" && sel !== ch) return;
    Object.keys(chapters[ch]).forEach(name=>{
      const el = document.createElement("div");
      el.className = "card";
      el.dataset.card = name;
      el.setAttribute("role","button");
      el.setAttribute("tabindex","0");

      if(gotCards[name]){
        el.innerHTML = withRubyMasked(name);
        el.classList.add("done");
      }else{
        el.textContent = "？\n" + name.split(" ")[0];
      }
      el.addEventListener("click", ()=>onCardClick(el, name));
      el.addEventListener("keydown", (e)=>{ if(e.key==="Enter" || e.key===" "){ e.preventDefault(); onCardClick(el, name); }});
      cardsWrap.appendChild(el);
    });
  });
}

/* クイズ処理 */
const quizModalEl = document.getElementById("quizModal");
const quizTitleEl = document.getElementById("quizTitle");
const quizHintEl  = document.getElementById("quizHint");
const quizInputEl = document.getElementById("quizInput");
const quizOkEl    = document.getElementById("quizOk");
const quizCancelEl= document.getElementById("quizCancel");
const quizBgEl    = document.getElementById("quizBg");
let currentQuizName = null;

function openQuiz(name){
  currentQuizName = name;
  quizTitleEl.textContent = name;
  quizHintEl.textContent  = "（例：てんぽう／わしん など ひらがなで）";
  quizInputEl.value = "";
  quizModalEl.style.display = "flex";
  setTimeout(()=>quizInputEl.focus(), 0);
}
function closeQuiz(){ quizModalEl.style.display = "none"; currentQuizName = null; }
function onCardClick(_el, name){ if(gotCards[name]) return; openQuiz(name); }

quizOkEl?.addEventListener("click", ()=>{
  if(!currentQuizName) return;
  const blanks = dataSets[currentEra].blanks[currentQuizName] || [];
  const ansRaw = quizInputEl.value || "";
  if(!onlyHiraAndSep(ansRaw)){ alert("ひらがなで入力してね（区切りは スペース / ・ / 、 / ／ でもOK）"); return; }
  const userTokens = normalizeTokens(splitTokens(ansRaw));
  const needTokens = normalizeTokens(blanks);
  const ok = needTokens.length>0 && needTokens.every(tok => userTokens.includes(tok));
  if(ok){
    gotCards[currentQuizName] = true;
    money += 10;
    moneyEl.textContent = money;
    persist();
    buildCards();
    closeQuiz();
    infoBoxEl.textContent = "正解！💰がふえたよ。ショップで好きな場所に建物を置いてみよう！";
 }else{
  const ans = needTokens.join("・");
  // 画面下のインフォに出す
  infoBoxEl.textContent = "ざんねん！正解は「" + ans + "」だよ。";
  // モーダル内にも出す（赤字）
  quizHintEl.textContent = "→ 正解：" + ans + "（ひらがな）";
  quizHintEl.style.color = "#c62828";
  // モーダルは開いたまま（やり直し可能）
}
});
quizCancelEl?.addEventListener("click", closeQuiz);
quizBgEl?.addEventListener("click", closeQuiz);

/* ショップ */
const SHOP_ITEMS = [
  { id:"house",   name:"家",        price:30,  cat:"building",      preview:"🏠" },
  { id:"shop",    name:"商家",      price:40,  cat:"building",      preview:"🏪" },
  { id:"castle",  name:"城",        price:120, cat:"building",      preview:"🏯" },
  { id:"temple",  name:"寺",      price:70,  cat:"building",      preview:"⛩️" },
  { id:"tree",    name:"木",        price:8,   cat:"nature",        preview:"🌳" },
  { id:"field",   name:"畑",        price:12,  cat:"nature",        preview:"🌾" },
  { id:"road",    name:"道路",      price:10,  cat:"infrastructure",preview:"🛣️" },
  { id:"bridge",  name:"橋",        price:25,  cat:"infrastructure",preview:"🌉" },
  { id:"school",  name:"学校",      price:80,  cat:"building",      preview:"🏫" }
];

let shopFilter = "ALL";
function renderShop(){
  if(!shopGridEl) return;
  shopGridEl.innerHTML = "";
  SHOP_ITEMS
    .filter(it => shopFilter === "ALL" || it.cat === shopFilter)
    .forEach(it => {
      const card = document.createElement("div");
      card.className = "shop-card";
      card.innerHTML = `
        <h4>${it.name}</h4>
        <div class="preview">${it.preview}</div>
        <div class="buyrow">
          <span class="price">💰${it.price} 両</span>
          <button data-buy="${it.id}">買う</button>
        </div>`;
      shopGridEl.appendChild(card);
    });

  shopGridEl.querySelectorAll("[data-buy]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-buy");
      const item = SHOP_ITEMS.find(s => s.id === id);
      if(!item) return;
      startPlacementFlow(item); // 位置選択モードへ
    });
  });
}
openShopBtnEl?.addEventListener("click", ()=>{ shopOverlayEl.classList.add("active"); renderShop(); });
shopCloseEl?.addEventListener("click", ()=> shopOverlayEl.classList.remove("active"));
shopOverlayEl?.addEventListener("click", (e)=>{ if(e.target===shopOverlayEl) shopOverlayEl.classList.remove("active"); });
document.querySelectorAll(".toolrow .toolbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".toolrow .toolbtn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    shopFilter = btn.getAttribute("data-filter") || "ALL";
    renderShop();
  });
});

/* 配置フロー */
let pendingPurchase = null; // {type, price, rot}
function occupiedKey(x,y){ return `${x},${y}`; }
function occupiedSet(){ return new Set(cityBuildings.map(b=>occupiedKey(b.x,b.y))); }

function startPlacementFlow(item){
 if(money < item.price){
    alert("お金が足りないよ！クイズで💰を増やしてからもう一度ためしてね。");
    return;
  }
  pendingPurchase = { type: item.id, price: item.price, rot: 0 };
  infoBoxEl.textContent = "置く場所をえらんでね（タップ/クリックで確定、右クリック/Escでキャンセル、R/↻で回転）";
  shopOverlayEl.classList.remove("active");

  // 3Dレイヤーへ開始通知（占有マスと盤面サイズを渡す）
  const occ = Array.from(occupiedSet()).map(s=>s.split(',').map(n=>Number(n)));
  document.dispatchEvent(new CustomEvent("placement:start", {
    detail: { type: item.id, cols: COLS, rows: ROWS, occupied: occ }
  }));
}

/* 3Dからの配置確定/キャンセル通知 */
document.addEventListener("placement:confirm", (ev)=>{
  if(!pendingPurchase) return;
  const { x, y, rot=0, type } = ev.detail || {};
  if(x<0 || y<0 || x>=COLS || y>=ROWS){ infoBoxEl.textContent="はみ出してるよ！別の場所に置いてね。"; return; }
  if(occupiedSet().has(occupiedKey(x,y))){ infoBoxEl.textContent="その場所は使えないよ！"; return; }
  if(money < pendingPurchase.price){ alert("お金が足りないよ！"); document.dispatchEvent(new Event("placement:end")); pendingPurchase=null; return; }

  money -= pendingPurchase.price;
  moneyEl.textContent = money;
  placeBuildingAt(type, x, y, rot);
  infoBoxEl.textContent = "設置したよ！";
  pendingPurchase = null;
  persist();
  document.dispatchEvent(new Event("placement:end"));
  sparkle();
});
document.addEventListener("placement:cancel", ()=>{ pendingPurchase = null; infoBoxEl.textContent = "キャンセルしたよ。"; });

/* 実配置（保存→3Dへ通知） */
function placeBuildingAt(type, x, y, rot=0){
  const id = Date.now().toString(36) + Math.random().toString(36).slice(2,7);
  const placed = { id, type, x, y, rot };
  cityBuildings.push(placed);
  persist();
  document.dispatchEvent(new CustomEvent("city:add", { detail: placed }));
}

/* 設置後の回転：Three側から保存更新 */
document.addEventListener("edit:rotate", (ev)=>{
  const { id, rot } = ev.detail || {};
  const t = cityBuildings.find(b => b.id === id);
  if(!t) return;
  t.rot = rot % 360;
  persist();
});

/* 全体を3Dへ同期（読込・リセット時） */
function sync3DLayer(){
  document.dispatchEvent(new CustomEvent("city:reset"));
  cityBuildings.forEach(b=> document.dispatchEvent(new CustomEvent("city:add", { detail: b })));
}

/* きらきら演出 */
function sparkle(){
  for(let i=0;i<8;i++){
    const p=document.createElement("div");
    p.className="petal"; p.textContent="✨";
    p.style.left = (20+Math.random()*60) + "vw";
    p.style.animationDuration = (2 + Math.random()*1.5) + "s";
    document.body.appendChild(p);
    setTimeout(()=>p.remove(), 4000);
  }
}

/* リセット */
resetBtnEl?.addEventListener("click", ()=>{
  if(!confirm("進捗と所持金をリセットしますか？")) return;
  gotCards = {}; money = 0; cityBuildings = [];
  persist(); buildCards(); moneyEl.textContent = money;
  infoBoxEl.textContent = "リセットしました。カードをめくって学ぼう！";
  sync3DLayer();
});

/* セレクト変更 */
eraSelectEl?.addEventListener("change", ()=>{
  currentEra = eraSelectEl.value;
  loadProgress();
  buildChapterFilter();
  buildCards();
});
chapterFilterEl?.addEventListener("change", buildCards);

/* ナビのショートカット */
document.getElementById("playEdo")?.addEventListener("click", ()=>{ eraSelectEl.value="edo";      eraSelectEl.dispatchEvent(new Event("change")); });
document.getElementById("playSengoku")?.addEventListener("click", ()=>{ eraSelectEl.value="sengoku"; eraSelectEl.dispatchEvent(new Event("change")); });
document.getElementById("playMuromachi")?.addEventListener("click", ()=>{ eraSelectEl.value="muromachi";eraSelectEl.dispatchEvent(new Event("change")); });
document.getElementById("playKamakura")?.addEventListener("click", ()=>{ eraSelectEl.value="kamakura"; eraSelectEl.dispatchEvent(new Event("change")); });

/* スマホHUD連携 */
setHidden('xxx', true);
setHidden('yyy', false);
document.addEventListener("placement:cancel",()=>{ placeHud.hidden = true;  });
btnRotate?.addEventListener("click", ()=>{ document.dispatchEvent(new Event("placement:rotate")); });
btnCancel?.addEventListener("click", ()=>{ document.dispatchEvent(new Event("placement:cancel")); });

/* 起動 */
function init(){
  currentEra = eraSelectEl ? eraSelectEl.value : "edo";
  loadProgress();
  buildChapterFilter();
  buildCards();
  document.querySelector('.toolrow .toolbtn[data-filter="ALL"]')?.classList.add("active");
}
document.addEventListener("DOMContentLoaded", init);


  /* ========== スティック操作（ジョイスティック） ========== */
const joypadEl  = document.getElementById("joypad");
const joyStick  = joypadEl?.querySelector(".joy-stick");

let joyActive = false, joyRAF = null, joyDir = {dx:0, dy:0}, joyLastStepAt = 0;

function joyShow(){ if(joypadEl) joypadEl.hidden = false; }
function joyHide(){ if(joypadEl) joypadEl.hidden = true; }

function quantizeDir(vx, vy){
  // vx: 右+, vy: 上+（後でy反転する）
  const mag = Math.hypot(vx, vy);
  if (mag < 0.15) return {dx:0, dy:0, speed:0}; // デッドゾーン

  // 角度を8方向に量子化
  const ang = Math.atan2(vy, vx); // -PI..PI
  const sector = Math.round(ang / (Math.PI/4)); // -4..4
  const dir8 = (sector + 8) % 8;

  // 8方向 → (dx,dy)
  const table = [
    {dx:1, dy:0},   // 0: →
    {dx:1, dy:1},   // 1: ↗
    {dx:0, dy:1},   // 2: ↑
    {dx:-1,dy:1},   // 3: ↖
    {dx:-1,dy:0},   // 4: ←
    {dx:-1,dy:-1},  // 5: ↙
    {dx:0, dy:-1},  // 6: ↓
    {dx:1, dy:-1}   // 7: ↘
  ];
  const {dx, dy} = table[dir8];

  // 速度（外周ほど速い）
  let speed;
  if (mag > 0.85) speed = 60;     // ms/step
  else if (mag > 0.55) speed = 90;
  else speed = 130;

  // 画面上では上がマイナスに進むので、yはそのまま（THREE側で減少が上）
  // ここでは {dx,dy} をそのまま渡す（dy:-1が下、+1が上になるよう THREE側で扱う）
  return {dx, dy, speed};
}

function joyStepLoop(ts){
  if(!joyActive){ joyRAF = null; return; }
  if(!joyDir.speed){ joyRAF = requestAnimationFrame(joyStepLoop); return; }

  if(ts - joyLastStepAt >= joyDir.speed){
    document.dispatchEvent(new CustomEvent("placement:nudge", { detail: { dx: joyDir.dx, dy: -joyDir.dy }}));
    // ↑ dy を反転：画面の上方向ドラッグで「手前→上（y-1）」へ
    joyLastStepAt = ts;
  }
  joyRAF = requestAnimationFrame(joyStepLoop);
}

function joyStart(x, y){
  joyActive = true; joyLastStepAt = 0;
  // スティック位置を動かす
  joyMove(x, y);
  if(!joyRAF) joyRAF = requestAnimationFrame(joyStepLoop);
}
function joyMove(x, y){
  const rect = joypadEl.getBoundingClientRect();
  const cx = rect.left + rect.width/2;
  const cy = rect.top  + rect.height/2;
  let dx = (x - cx) / (rect.width/2);   // -1..1
  let dy = (y - cy) / (rect.height/2);  // -1..1
  const mag = Math.hypot(dx, dy);
  if(mag > 1){ dx/=mag; dy/=mag; }

  // ノブ見た目
  if(joyStick){
    const px = dx * 28, py = dy * 28; // 半径 ~28px
    joyStick.style.transform = `translate(${px}px, ${py}px)`;
  }

  joyDir = quantizeDir(dx, -dy); // 画面座標→上が正に見えるよう反転して量子化
}
function joyEnd(){
  joyActive = false; joyDir = {dx:0, dy:0, speed:0};
  if(joyRAF){ cancelAnimationFrame(joyRAF); joyRAF = null; }
  if(joyStick){ joyStick.style.transform = "translate(0,0)"; }
}

// 入力イベント
if(joypadEl){
  const onDown = (e)=>{ const p = e.touches ? e.touches[0] : e; joyStart(p.clientX, p.clientY); };
  const onMove = (e)=>{ if(!joyActive) return; const p = e.touches ? e.touches[0] : e; joyMove(p.clientX, p.clientY); };
  const onUp   = ()=> joyEnd();

  joypadEl.addEventListener("pointerdown", onDown);
  joypadEl.addEventListener("pointermove", onMove);
  window.addEventListener("pointerup", onUp);
  joypadEl.addEventListener("touchstart", onDown, {passive:false});
  joypadEl.addEventListener("touchmove",  onMove, {passive:false});
  window.addEventListener("touchend", onUp);
}

// 配置フローと連動（表示/非表示）
document.addEventListener("placement:start", ()=>{ joyShow(); });
document.addEventListener("placement:end",   ()=>{ joyHide(); joyEnd(); });
document.addEventListener("placement:cancel",()=>{ joyHide(); joyEnd(); });

// 「決定」ボタン → THREE 側にOKシグナル
document.getElementById("btnOK")?.addEventListener("click", ()=>{
  document.dispatchEvent(new Event("placement:ok"));
});


  </script>

  <script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

  

<!-- ===== Three.js レイヤー（モジュール） ===== -->
<script type="module">

 // --- 安全に hidden を切り替えるヘルパー（要素が無くても落ちない）---
function setHidden(idOrEl, value){
  const el = typeof idOrEl === 'string' ? document.getElementById(idOrEl) : idOrEl;
  if (!el) { console.warn('[UI missing]', idOrEl); return false; }
  el.hidden = !!value;
  return true;
}
// classの表示/非表示を使う版（お好みで）
function setShown(idOrEl, shown){
  const el = typeof idOrEl === 'string' ? document.getElementById(idOrEl) : idOrEl;
  if (!el) { console.warn('[UI missing]', idOrEl); return false; }
  if (shown) el.removeAttribute('hidden'); else el.setAttribute('hidden','');
  return true;
}

/* ========= 依存 ========= */
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { TransformControls } from 'three/addons/controls/TransformControls.js';

/* ========= 画面UI（ツールバー）をJSから注入 ========= */
(() => {
  const css = `
  #ui-toolbar{
    position: fixed; z-index: 9999; top: 16px; right: 16px;
    display: flex; gap: 8px; align-items: center;
    background: rgba(255,255,255,.92);
    border: 1px solid #e5e7eb; border-radius: 12px; padding: 8px 10px;
    box-shadow: 0 6px 20px rgba(0,0,0,.12);
    font-family: system-ui, -apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
  }
  #ui-toolbar button{
    appearance: none; border: 1px solid #e5e7eb; border-radius: 10px;
    background: #fff; padding: 6px 10px; cursor: pointer; font-size: 14px;
  }
  #ui-toolbar button.active{ background: #fcd34d; border-color: #f59e0b; }
  #ui-toolbar #ui-hint{ margin-left: 4px; font-size: 13px; color: #374151; }
  canvas { outline: none; }
  `;
  const style = document.createElement('style'); style.textContent = css; document.head.appendChild(style);

  const bar = document.createElement('div'); bar.id = 'ui-toolbar';
  bar.innerHTML = `
    <button id="btn-select" class="active" title="建物を選択">選択</button>
    <button id="btn-move"   title="選択した建物をドラッグで移動">移動</button>
    <button id="btn-delete" title="クリックした建物を削除">削除</button>
    <span id="ui-hint">モード: 選択</span>
  `;
  document.body.appendChild(bar);
})();

/* ========= Three.js セットアップ ========= */
const townEl = document.getElementById("town");
let renderer, scene, camera, controls, loader, ground, grid;
let placed3D = [];                  // 設置済みオブジェクトの“ルート”配列
let tControls = null;               // TransformControls は ensureRenderer 内で生成

let COLS = 30, ROWS = 18;
const WORLD_SCALE = 1.0;
const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

function gridToWorld(x, y){
  const ox = Math.floor(COLS/2), oy = Math.floor(ROWS/2);
  return new THREE.Vector3((x-ox)*WORLD_SCALE, 0, (y-oy)*WORLD_SCALE);
}
function worldToGrid(X,Z){
  const ox = Math.floor(COLS/2), oy = Math.floor(ROWS/2);
  return { x: Math.round(X/WORLD_SCALE)+ox, y: Math.round(Z/WORLD_SCALE)+oy };
}

/* === 地面に載せるユーティリティ === */
const EPS_Y = 0.01;
function snapBaseY(obj, targetY = 0){
  obj.updateWorldMatrix(true, true);
  const box = new THREE.Box3().setFromObject(obj);
  const dy  = (targetY + EPS_Y) - box.min.y;
  obj.position.y += dy;
  obj.updateWorldMatrix(true, true);
}

function ensureRenderer(){
  if(renderer) return;
  const w = townEl.clientWidth, h = townEl.clientHeight;

  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
  renderer.setSize(w, h);
  renderer.domElement.style.position = "absolute";
  renderer.domElement.style.inset = "0";
  townEl.style.position = "relative";
  townEl.appendChild(renderer.domElement);

  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(50, w/h, 0.1, 1000);

  controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.06;
  controls.maxPolarAngle = Math.PI / 2 - 0.01;
  controls.minPolarAngle = 0.1;
  controls.screenSpacePanning = false;
  controls.addEventListener('change', () => {
    const minTargetY = 0.1;
    if (controls.target.y < minTargetY) {
      const dy = minTargetY - controls.target.y;
      controls.target.y += dy;
      camera.position.y = Math.max(camera.position.y + dy, minTargetY + 0.01);
    }
  });

  const center = gridToWorld(Math.floor(COLS/2), Math.floor(ROWS/2));
  controls.target.copy(center);
  camera.position.set(center.x + 15, 18, center.z + 22);

  scene.add(new THREE.AmbientLight(0xffffff, 1.0));
  const dir = new THREE.DirectionalLight(0xffffff, 1.2);
  dir.position.set(10, 20, 10);
  scene.add(dir);

  const plane = new THREE.PlaneGeometry(100, 100);
  const pm = new THREE.MeshBasicMaterial({ color: 0xd7f4d2, side: THREE.FrontSide });
  ground = new THREE.Mesh(plane, pm);
  ground.rotation.x = -Math.PI/2;
  ground.name = "ground";
  scene.add(ground);

  grid = new THREE.GridHelper(100, 100, 0x000000, 0x000000);
  grid.material.opacity = 0.08;
  grid.material.transparent = true;
  scene.add(grid);

  loader = new GLTFLoader();

  renderer.setAnimationLoop(()=>{ controls.update(); renderer.render(scene, camera); });

  controls.minPolarAngle = 0.1;
  controls.maxPolarAngle = Math.PI / 2.02;

  new ResizeObserver(()=>{
    const w2 = townEl.clientWidth, h2 = townEl.clientHeight;
    renderer.setSize(w2, h2);
    camera.aspect = w2/h2;
    camera.updateProjectionMatrix();
  }).observe(townEl);

  /* === 移動ハンドル（TransformControls） === */
  tControls = new TransformControls(camera, renderer.domElement);
  tControls.setMode('translate');
  tControls.addEventListener('dragging-changed', e => { controls.enabled = !e.value; });
  scene.add(tControls);
}
ensureRenderer();

/* ========= モデルURL ========= */
const MODEL_URLS = {
  house:  "/assets/_m/house.2a9f3.glb",
  shop:   "/assets/_m/j8ap2an8eses0ho1p.glb",
  castle: "/assets/_m/ja76386p2an8esecas6t9le.glb",
  temple: "/assets/_m/japanese.tem3pl4e1383.glb",
  tree:   "/assets/_m/t6r7e9e.glb",
  field:  "/assets/_m/f2i342el2d.glb",
  road:   "/assets/_m/w8a9l0k9w7a2y.glb",
  bridge: "/assets/_m/b7r89i6d8g9e.glb",
  school: "/assets/_m/s7c7h9o89ol.glb",
};

/* ========= フォールバック ========= */
function fallbackMesh(type, big=false){
  const s = big ? 1.6 : 0.9;
  const g = new THREE.BoxGeometry(s, s, s);
  const m = new THREE.MeshStandardMaterial({ color: 0x2ecc71, emissive: 0x0, metalness:0.1, roughness:0.8 });
  const mesh = new THREE.Mesh(g, m);
  mesh.position.y = s/2;
  return mesh;
}

/* ========= 設置 ========= */
async function place3D({id, type, x, y, rot=0}){
  const pos = gridToWorld(x, y);
  let obj; const url = MODEL_URLS[type];
  if(url){
    try { const gltf = await loader.loadAsync(url); obj = gltf.scene; obj.scale.set(0.8,0.8,0.8); }
    catch { obj = fallbackMesh(type); }
  }else{
    obj = fallbackMesh(type);
  }
  obj.position.copy(pos);
  obj.rotation.y = (rot/90) * Math.PI/2;

  snapBaseY(obj, 0);

  obj.userData.id  = id  || null;
  obj.userData.rot = rot || 0;
  scene.add(obj);
  placed3D.push(obj);
}
function clear3D(){ placed3D.forEach(o=>scene.remove(o)); placed3D = []; }

/* ========= 共通レイキャスター ========= */
const raycaster = new THREE.Raycaster();
const pointer   = new THREE.Vector2();

/* ========= 配置モード（プレビュー付き） ========= */
let placing=false, preview=null, placeType=null, placeRot=0;
let occSet = new Set();
let hoverCell = {x:-1,y:-1};
const okMat=new THREE.MeshBasicMaterial({ color:0x2e7d32, transparent:true, opacity:0.5 });
const ngMat=new THREE.MeshBasicMaterial({ color:0xc62828, transparent:true, opacity:0.5 });

function setPointerFromEvent(ev){
  const rect = renderer.domElement.getBoundingClientRect();
  const cx = ((ev.clientX ?? (ev.touches?.[0]?.clientX || 0)) - rect.left) / rect.width;
  const cy = ((ev.clientY ?? (ev.touches?.[0]?.clientY || 0)) - rect.top) / rect.height;
  pointer.x = cx * 2 - 1; pointer.y = -(cy * 2 - 1);
}
function pickOnGround(ev){
  setPointerFromEvent(ev);
  raycaster.setFromCamera(pointer, camera);
  const hit = raycaster.intersectObject(ground, false)[0];
  if(!hit) return null;
  return { cell: worldToGrid(hit.point.x, hit.point.z) };
}
function cellValid(x,y){ return (x>=0 && y>=0 && x<COLS && y<ROWS) && !occSet.has(`${x},${y}`); }

function applyTint(obj,mat){
  obj.traverse?.(n=>{
    if(n.isMesh){
      if(!n.userData._origMat) n.userData._origMat = n.material;
      n.material = mat;
    }
  });
}
function restoreTint(obj){
  obj.traverse?.(n=>{
    if(n.isMesh && n.userData._origMat){ n.material = n.userData._origMat; delete n.userData._origMat; }
  });
}
async function ensurePreview(){
  if (preview) return preview;
  preview = fallbackMesh(placeType, true);
  scene.add(preview);
  snapBaseY(preview, 0);
  const url = MODEL_URLS[placeType];
  if (url) {
    try{
      const gltf = await loader.loadAsync(url);
      const real = gltf.scene;
      real.scale.set(0.8,0.8,0.8);
      real.position.copy(preview.position);
      real.rotation.copy(preview.rotation);
      scene.add(real);
      scene.remove(preview);
      preview = real;
      snapBaseY(preview, 0);
    }catch(e){}
  }
  return preview;
}
function setPreviewAtCell(cell){
  hoverCell = cell;
  const pos = gridToWorld(cell.x, cell.y);
  preview.position.copy(pos);
  preview.rotation.y = (placeRot/90) * Math.PI/2;
  const valid = cellValid(cell.x, cell.y);
  restoreTint(preview);
  applyTint(preview, valid ? okMat : ngMat);
}
function endPlacement(){
  placing=false; placeType=null; placeRot=0; occSet.clear();
  if(preview){ scene.remove(preview); preview=null; }
  renderer.domElement.style.cursor="default";
  controls.enabled = true;
}

/* ========= 配置イベント ========= */
document.addEventListener("placement:start", async (ev)=>{
  const { type, cols, rows, occupied=[] } = ev.detail || {};
  COLS = cols ?? COLS; ROWS = rows ?? ROWS;

  placing = true; placeType = type; placeRot = 0;
  occSet = new Set(occupied.map(([x,y]) => `${x},${y}`));

  controls.enabled = false;
  renderer.domElement.style.cursor = "crosshair";

  await ensurePreview();

  // 中央から近傍の空きマスを探す
  const center = { x: Math.floor(COLS/2), y: Math.floor(ROWS/2) };
  const isFree = (c)=> c.x>=0 && c.y>=0 && c.x<COLS && c.y<ROWS && !occSet.has(`${c.x},${c.y}`);
  let init = center;
  if (!isFree(init)) {
    outer: for (let r=1; r<Math.max(COLS,ROWS); r++){
      for (let dx=-r; dx<=r; dx++){
        for (let dy=-r; dy<=r; dy++){
          const c = { x: center.x+dx, y: center.y+dy };
          if (isFree(c)){ init=c; break outer; }
        }
      }
    }
  }
  setPreviewAtCell(init);

  // カメラ寄せ
  const t = gridToWorld(init.x, init.y);
  controls.target.copy(t);
  camera.position.set(t.x + 15, 18, t.z + 22);
  controls.update();
});
document.addEventListener("placement:end",   ()=> endPlacement());
document.addEventListener("placement:cancel",()=> endPlacement());
document.addEventListener("placement:rotate",()=>{ if(!placing) return; placeRot=(placeRot+90)%360; if(preview && hoverCell){ setPreviewAtCell(hoverCell); } });

// マウス移動でプレビュー追従
renderer.domElement.addEventListener("pointermove", (ev)=>{
  if(!placing) return;
  const r = pickOnGround(ev); if(!r) return;
  setPreviewAtCell(r.cell);
}, { passive:true });

// クリックで確定
function tryPlace(ev){
  if(!placing) return;
  const r = pickOnGround(ev); if(!r) return;
  const {x,y}=r.cell;
  if(!cellValid(x,y)) return;
  document.dispatchEvent(new CustomEvent("placement:confirm",{ detail:{ type:placeType, x, y, rot:placeRot }}));
  endPlacement();
}
renderer.domElement.addEventListener("click", tryPlace, { passive:false });

// 右クリックでキャンセル
renderer.domElement.addEventListener("pointerdown", (ev)=>{
  if(placing && ev.button===2){ ev.preventDefault(); document.dispatchEvent(new Event("placement:cancel")); endPlacement(); }
});
renderer.domElement.addEventListener("contextmenu", (e)=>{ if(placing){ e.preventDefault(); } });

 // スティック操作：1ステップ移動
document.addEventListener("placement:nudge", (ev)=>{
  if(!placing || !hoverCell) return;
  const {dx=0, dy=0} = ev.detail || {};
  const nx = clamp(hoverCell.x + dx, 0, COLS-1);
  const ny = clamp(hoverCell.y + dy, 0, ROWS-1);
  setPreviewAtCell({x:nx, y:ny});
});

/* ========= 編集モード（選択／移動／削除） ========= */
let editMode = 'select';     // 'select' | 'move' | 'delete'
let selected = null;

function markSelected(obj){
  clearSelected();
  selected = obj;
  selected.traverse?.(n=>{
    if(n.isMesh && n.material && 'emissive' in n.material){
      n.userData.__origEmissive = n.material.emissive.clone();
      n.material.emissive.setHex(0xFF8800);
    }
  });
}
function clearSelected(){
  if(!selected) return;
  selected.traverse?.(n=>{
    if(n.isMesh && n.material && n.userData.__origEmissive){
      n.material.emissive.copy(n.userData.__origEmissive);
      delete n.userData.__origEmissive;
    }
  });
  selected = null;
}

const $btnSelect = document.getElementById('btn-select');
const $btnMove   = document.getElementById('btn-move');
const $btnDelete = document.getElementById('btn-delete');
const $hint      = document.getElementById('ui-hint');

function setEditMode(m){
  editMode = m;
  [$btnSelect,$btnMove,$btnDelete].forEach(b=>b.classList.remove('active'));
  if(m==='select') $btnSelect.classList.add('active');
  if(m==='move')   $btnMove.classList.add('active');
  if(m==='delete') $btnDelete.classList.add('active');
  $hint.textContent = `モード: ${m==='select'?'選択': m==='move'?'移動':'削除'}`;
  if (tControls && m!=='move') tControls.detach();
  renderer.domElement.style.cursor = (m==='delete') ? 'not-allowed' : 'default';
}
$btnSelect.onclick = ()=> setEditMode('select');
$btnMove.onclick   = ()=> { setEditMode('move');  if(selected && tControls) tControls.attach(selected); };
$btnDelete.onclick = ()=> setEditMode('delete');
setEditMode('select');

/* === 配置モードでない時の編集クリック === */
renderer.domElement.addEventListener('pointerup', (ev)=>{
  if(placing) return; // 配置中は編集しない

  const rect = renderer.domElement.getBoundingClientRect();
  const cx = (ev.clientX - rect.left) / rect.width;
  const cy = (ev.clientY - rect.top)  / rect.height;
  const p = new THREE.Vector2(cx*2-1, -(cy*2-1));
  raycaster.setFromCamera(p, camera);
  const hits = raycaster.intersectObjects(placed3D, true);

  if(!hits.length){
    clearSelected(); if (tControls) tControls.detach(); return;
  }
  let hit = hits[0].object;
  while(hit && !placed3D.includes(hit)) hit = hit.parent;
  if(!hit) return;

  if(editMode==='delete'){
    scene.remove(hit);
    placed3D = placed3D.filter(o=>o!==hit);
    if(hit.userData?.id) document.dispatchEvent(new CustomEvent('edit:delete', { detail:{ id: hit.userData.id }}));
    if(selected===hit){ clearSelected(); if (tControls) tControls.detach(); }
    return;
  }

  markSelected(hit);
  if(editMode==='move' && tControls) tControls.attach(hit);
});

/* ========= 公開API ========= */
window.city3D = {
  place3D, clear3D,
  setEditMode,
  getSelected: ()=>selected
};
</script>



</body>
</html>











































