<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>江戸カードで町づくり！（年表拡張＋クイズ＋ふりがな／〇〇維持）</title>

<!-- AdSense（自動広告） -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4922140858632050" crossorigin="anonymous"></script>

<style>
  :root{
    --edo-yellow:#FCD34D; --edo-info:#FFF8DC; --edo-border:#999;
    --bg:#FFF6E3; --shadow:rgba(0,0,0,.12); --ink:#222; --adbg:#f1f1f1;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
      "Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;}
  .wrap{display:flex;flex-direction:column;min-height:100svh;}
  header{position:sticky;top:0;z-index:3;background:var(--edo-yellow);
    padding:10px 12px;display:flex;gap:8px;align-items:center;justify-content:space-between;
    box-shadow:0 1px 4px var(--shadow);}
  header h1{font-size:18px;margin:0;font-weight:700}
  header .controls{display:flex;gap:8px}
  header button, header select{border:0;border-radius:10px;background:#fff;padding:6px 12px;
    font-weight:700;box-shadow:0 1px 3px var(--shadow);cursor:pointer}
  #info{padding:10px;background:var(--edo-info);border-bottom:1px solid #ccc;
    font-size:15px;min-height:40px}
  #town{position:relative;width:100%;height:44vh;min-height:260px;background:#fff;
    border-top:2px solid var(--edo-border);border-bottom:2px solid var(--edo-border);
    overflow:hidden}
  #cards{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:10px}
  .card{width:28vw;max-width:110px;min-width:86px;height:120px;border-radius:12px;background:#ddd;
    display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;
    cursor:pointer;box-shadow:0 2px 6px var(--shadow);user-select:none;text-align:center;padding:6px}
  .card.done{background:#cdeccd; color:#1a5e1a}
  .building{position:absolute;font-size:34px;opacity:0;transform:scale(.8);
    transition:opacity .7s, transform .7s}
  .show{opacity:1;transform:scale(1.2)}
  .villager{position:absolute;font-size:20px;animation:walk 8s linear infinite}
  @keyframes walk{0%{left:2%}50%{left:90%}100%{left:2%}}
  #zukanPanel{position:fixed;inset:0 0 auto 0;height:72%;top:-100%;background:#fff;
    border-bottom:3px solid #333;box-shadow:0 4px 16px var(--shadow);
    transition:top .45s ease;z-index:5;overflow:auto}
  #zukanPanel.active{top:0}
  #zukanHead{position:sticky;top:0;background:#fff;padding:10px;border-bottom:1px solid #eee;
    display:flex;align-items:center;gap:8px}
  #zukanHead h2{margin:0;font-size:18px}
  #closeZukan{margin-left:auto;border:0;background:#eee;border-radius:8px;padding:6px 12px;cursor:pointer}
  .zukanSec{padding:10px}
  .zukanSec h3{margin:8px 0}
  .zCard{display:inline-flex;align-items:center;justify-content:center;width:96px;height:116px;margin:4px;
    border:1px solid #ccc;border-radius:8px;box-shadow:0 1px 3px var(--shadow);white-space:pre-line;text-align:center;padding:6px}
  .locked{background:#eee;color:#999}
  #completeMsg{font-size:18px;font-weight:800;color:green;text-align:center;padding:10px}
  .petal{position:fixed;top:-10px;font-size:20px;animation:fall linear forwards;pointer-events:none}
  @keyframes fall{to{transform:translateY(110vh) rotate(360deg);opacity:0}}
  .adbar{position:sticky;bottom:0;background:var(--adbg);border-top:1px solid #ddd;
    padding:4px 8px; display:flex; justify-content:center; align-items:center; min-height:52px}
  .adslot{width:100%; max-width:728px; height:50px; background:
    repeating-linear-gradient(45deg,#eee,#eee 8px,#e2e2e2 8px,#e2e2e2 16px);
    border:1px dashed #bbb;border-radius:8px; display:flex; align-items:center; justify-content:center;
    font-size:12px; color:#666}
  footer{height:8px}
  .landscapeWarn{position:fixed;inset:0;background:rgba(0,0,0,.65);color:#fff;display:none;
    align-items:center;justify-content:center;z-index:20;text-align:center;padding:20px}
  @media (orientation:landscape){ .landscapeWarn{display:flex} }
  ruby rt{font-size:.7em;color:#444}
  .yr{font-weight:800;margin-right:2px}
</style>
</head>
<body>
<div class="wrap" role="application" aria-label="江戸カードで町づくり（〇〇維持）">
  <header>
    <h1>江戸カードで町づくり！</h1>
    <div class="controls">
      <select id="chapterFilter" title="章をえらぶ">
        <option value="ALL">章：ぜんぶ</option>
        <option value="初期">章：初期（1603〜）</option>
        <option value="中期">章：中期</option>
        <option value="幕末">章：幕末</option>
      </select>
      <button id="zukanBtn" aria-controls="zukanPanel" aria-expanded="false">図鑑</button>
    </div>
  </header>

  <div id="info">カードをめくって江戸の町を発展させよう！（クイズにひらがなで正解すると開くよ）</div>
  <div id="town" role="img" aria-label="江戸の町エリア"></div>

  <div id="cards" aria-label="カードエリア"></div>

  <section id="zukanPanel" aria-hidden="true">
    <div id="zukanHead">
      <h2>江戸カード図鑑（章ごと）</h2>
      <button id="closeZukan" aria-label="図鑑をとじる">とじる</button>
    </div>
    <div id="zukanList"></div>
    <div id="completeMsg"></div>
  </section>

  <!-- 下部の固定バナー枠（必要なら中身を ad ユニットに差し替え） -->
  <div class="adbar" aria-label="広告枠">
    <div class="adslot">広告スペース（<ins class="adsbygoogle">…</ins> を入れる場所）</div>
  </div>
  <footer aria-hidden="true"></footer>
</div>

<div class="landscapeWarn">縦向きで遊んでね🔄</div>

<script>
  // ===== データ（タイトルは〇〇つきのまま） =====
  const chapters = {
    "初期": {
      "1603 〇〇幕府がはじまる": { text: "家康が将軍になり、江戸で国の中心が動き出す。", icon: "🏯", year: 1603 },
      "1615 〇〇の陣": { text: "大きなたたかいが終わり、豊臣の時代に幕。", icon: "⚔️", year: 1615 },
      "1635 〇〇交代": { text: "大名は国と江戸を行き来するきまりに。", icon: "🚶", year: 1635 },
      "1637 島〇・天〇の乱": { text: "九州で大きな一揆が起きる。", icon: "🔥", year: 1637 },
      "1639 〇〇〇〇〇船の来航禁止": { text: "外国船の出入りをしめて、交流をせいげん。", icon: "⛵", year: 1639 },
      "1641 〇〇での貿易": { text: "オランダ商館が長崎の出島へ。", icon: "🏝️", year: 1641 },
      "1657 〇〇の大火": { text: "江戸の町が大火事。町づくりを立て直す。", icon: "🔥", year: 1657 },
      "1657 〇〇〇へ移転": { text: "遊郭が浅草千束の新しい場所へ。", icon: "🏮", year: 1657 }
    },
    "中期": {
      "1688 〇〇文化がさかえる": { text: "町人の文化が花ひらく。歌舞伎や浮世絵が人気。", icon: "🎭", year: 1688 },
      "1716 〇〇の改革": { text: "吉宗がくらしと財政を立て直す工夫をはじめる。", icon: "📜", year: 1716 },
      "1720 〇〇をとりいれる": { text: "海外の学びが広がり、知識がふえる。", icon: "📚", year: 1720 },
      "1720 〇〇のしくみ": { text: "火事にそなえる町人の組ができる。", icon: "🚒", year: 1720 },
      "1730 〇のながれを整える": { text: "商いのきまりをととのえ、町を元気に。", icon: "🧺", year: 1730 },
      "1775 〇〇の時代": { text: "商いを活かす政治でお金の流れをよくする試み。", icon: "💹", year: 1775 },
      "1783 〇〇のききん": { text: "寒さや不作で食べ物がたりなくなる。", icon: "🌾", year: 1783 }
    },
    "幕末": {
      "1787 〇〇の改革": { text: "くらしをひきしめ、教育も大切にする方針。", icon: "📝", year: 1787 },
      "1825 〇〇〇打払令": { text: "近づく外国船を追いはらうきまり。", icon: "📣", year: 1825 },
      "1837 〇〇〇〇〇の乱": { text: "大阪で人びとの苦しさが爆発。", icon: "⚠️", year: 1837 },
      "1841 〇〇の改革": { text: "町の決まりを見直し、ぜいたくをおさえる。", icon: "📏", year: 1841 },
      "1853 〇〇が来る": { text: "アメリカの船が浦賀に来航。", icon: "⛴️", year: 1853 },
      "1854 〇〇条約": { text: "日本は港を開き、交流をはじめる。", icon: "🤝", year: 1854 },
      "1858 〇〇の条約": { text: "いくつかの国とむすび、貿易が広がる。", icon: "🌐", year: 1858 },
      "1858 〇〇の大獄": { text: "意見のちがいで多くの人が処罰される。", icon: "⚖️", year: 1858 },
      "1860 〇〇〇〇の変": { text: "政治の対立が事件に。", icon: "🗡️", year: 1860 },
      "1867 〇〇奉還": { text: "政（まつりごと）を朝廷にお返し。", icon: "🗝️", year: 1867 },
      "1868 〇〇へ": { text: "新しい時代のスタート！", icon: "🌸", year: 1868 }
    }
  };

  // ===== クイズ正解（ひらがな／本来の読み）※キーは「〇〇付きのタイトル＋年」 =====
  const hiraAnswers = {
    "1603 〇〇幕府がはじまる": "えどばくふがはじまる",
    "1615 〇〇の陣": "おおさかのじん",
    "1635 〇〇交代": "さんきんこうたい",
    "1637 島〇・天〇の乱": "しまばらあまくさのらん",
    "1639 〇〇〇〇〇船の来航禁止": "ぽるとがるせんのらいこうきんし",
    "1641 〇〇での貿易": "でじまでのぼうえき",
    "1657 〇〇の大火": "めいれきのたいか",
    "1657 〇〇〇へ移転": "しんよしわらへいてん",
    "1688 〇〇文化がさかえる": "げんろくぶんかがさかえる",
    "1716 〇〇の改革": "きょうほうのかいかく",
    "1720 〇〇をとりいれる": "ようしょをとりいれる",
    "1720 〇〇のしくみ": "まちびけしのしくみ",
    "1730 〇のながれを整える": "もののながれをととのえる",
    "1775 〇〇の時代": "たぬまのじだい",
    "1783 〇〇のききん": "てんめいのききん",
    "1787 〇〇の改革": "かんせいのかいかく",
    "1825 〇〇〇打払令": "いこくせんうちはらいれい",
    "1837 〇〇〇〇〇の乱": "おおしおへいはちろうのらん",
    "1841 〇〇の改革": "てんぽうのかいかく",
    "1853 〇〇が来る": "くろふねがくる",
    "1854 〇〇条約": "わしんじょうやく",
    "1858 〇〇の条約": "あんせいのじょうやく",
    "1858 〇〇の大獄": "あんせいのたいごく",
    "1860 〇〇〇〇の変": "さくらだもんがいのへん",
    "1867 〇〇奉還": "たいせいほうかん",
    "1868 〇〇へ": "めいじへ"
  };

  // ===== ふりがな表示（見えている漢字だけに ruby。〇〇はそのまま） =====
  const rubyMasked = {
    "1603 〇〇幕府がはじまる": "〇〇<ruby>幕府<rt>ばくふ</rt></ruby>がはじまる",
    "1615 〇〇の陣": "〇〇の<ruby>陣<rt>じん</rt></ruby>",
    "1635 〇〇交代": "〇〇<ruby>交代<rt>こうたい</rt></ruby>",
    "1637 島〇・天〇の乱": "島〇・天〇の<ruby>乱<rt>らん</rt></ruby>",
    "1639 〇〇〇〇〇船の来航禁止": "〇〇〇〇〇<ruby>船<rt>せん</rt></ruby>の<ruby>来航<rt>らいこう</rt></ruby><ruby>禁止<rt>きんし</rt></ruby>",
    "1641 〇〇での貿易": "〇〇での<ruby>貿易<rt>ぼうえき</rt></ruby>",
    "1657 〇〇の大火": "〇〇の<ruby>大火<rt>たいか</rt></ruby>",
    "1657 〇〇〇へ移転": "〇〇〇へ<ruby>移転<rt>いてん</rt></ruby>",
    "1688 〇〇文化がさかえる": "〇〇<ruby>文化<rt>ぶんか</rt></ruby>がさかえる",
    "1716 〇〇の改革": "〇〇の<ruby>改革<rt>かいかく</rt></ruby>",
    "1720 〇〇をとりいれる": "〇〇をとりいれる",
    "1720 〇〇のしくみ": "〇〇のしくみ",
    "1730 〇のながれを整える": "〇のながれを<ruby>整える<rt>ととのえる</rt></ruby>",
    "1775 〇〇の時代": "〇〇の<ruby>時代<rt>じだい</rt></ruby>",
    "1783 〇〇のききん": "〇〇のききん",
    "1787 〇〇の改革": "〇〇の<ruby>改革<rt>かいかく</rt></ruby>",
    "1825 〇〇〇打払令": "〇〇〇<ruby>打払令<rt>うちはらいれい</rt></ruby>",
    "1837 〇〇〇〇〇の乱": "〇〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
    "1841 〇〇の改革": "〇〇の<ruby>改革<rt>かいかく</rt></ruby>",
    "1853 〇〇が来る": "〇〇が<ruby>来る<rt>くる</rt></ruby>",
    "1854 〇〇条約": "〇〇<ruby>条約<rt>じょうやく</rt></ruby>",
    "1858 〇〇の条約": "〇〇の<ruby>条約<rt>じょうやく</rt></ruby>",
    "1858 〇〇の大獄": "〇〇の<ruby>大獄<rt>たいごく</rt></ruby>",
    "1860 〇〇〇〇の変": "〇〇〇〇の<ruby>変<rt>へん</rt></ruby>",
    "1867 〇〇奉還": "〇〇<ruby>奉還<rt>ほうかん</rt></ruby>",
    "1868 〇〇へ": "〇〇へ"
  };
  // 〇〇部分だけの正解（ひらがな）。複数空欄は配列で順番どおり。
const blanksMap = {
  "1603 〇〇幕府がはじまる": ["えど"],
  "1615 〇〇の陣": ["おおさか"],
  "1635 〇〇交代": ["さんきん"],
  "1637 島〇・天〇の乱": ["ばら","くさ"],
  "1639 〇〇〇〇〇船の来航禁止": ["ぽるとがる"],
  "1641 〇〇での貿易": ["でじま"],
  "1657 〇〇の大火": ["めいれき"],
  "1657 〇〇〇へ移転": ["しんよしわら"],
  "1688 〇〇文化がさかえる": ["げんろく"],
  "1716 〇〇の改革": ["きょうほう"],
  "1720 〇〇をとりいれる": ["ようしょ"],
  "1720 〇〇のしくみ": ["まちびけし"],
  "1730 〇のながれを整える": ["もの"],
  "1775 〇〇の時代": ["たぬま"],
  "1783 〇〇のききん": ["てんめい"],
  "1787 〇〇の改革": ["かんせい"],
  "1825 〇〇〇打払令": ["いこくせん"],
  "1837 〇〇〇〇〇の乱": ["おおしおへいはちろう"],
  "1841 〇〇の改革": ["てんぽう"],
  "1853 〇〇が来る": ["くろふね"],
  "1854 〇〇条約": ["わしん"],
  "1858 〇〇の条約": ["あんせい"],
  "1858 〇〇の大獄": ["あんせい"],
  "1860 〇〇〇〇の変": ["さくらだもんがい"],
  "1867 〇〇奉還": ["たいせい"],
  "1868 〇〇へ": ["めいじ"]
};


  function withRubyMasked(fullName){
    const sp = fullName.indexOf(" ");
    const year = fullName.slice(0, sp);
    const body = rubyMasked[fullName] || fullName.slice(sp+1);
    return `<span class="yr">${year}</span> ${body}`;
  }

  const infoBox = document.getElementById("info");
  const town = document.getElementById("town");
  const zukanPanel = document.getElementById("zukanPanel");
  const zukanList = document.getElementById("zukanList");
  const completeMsg = document.getElementById("completeMsg");
  const zukanBtn = document.getElementById("zukanBtn");
  const closeZukan = document.getElementById("closeZukan");
  const chapterFilter = document.getElementById("chapterFilter");

  const LS_KEY = "edoTown_cards_quiz_furigana_masked_v1";
  const gotCards = {};
  try { Object.assign(gotCards, JSON.parse(localStorage.getItem(LS_KEY) || "{}")); } catch(e){}

  // ===== カード生成 =====
  function buildCards(){
    const wrap = document.getElementById("cards");
    wrap.innerHTML = "";
    const sel = chapterFilter.value;
    Object.keys(chapters).forEach(ch=>{
      if(sel!=="ALL" && sel!==ch) return;
      for(const name in chapters[ch]){
        const el = document.createElement("div");
        el.className = "card";
        el.dataset.card = name;
        if(gotCards[name]) { el.innerHTML = withRubyMasked(name); el.classList.add("done"); }
        else { el.textContent = "？\n"+name.split(" ")[0]; }
        el.addEventListener("click", ()=>onCardClick(el, name, ch));
        wrap.appendChild(el);
      }
    });
  }

  function persist(){ try { localStorage.setItem(LS_KEY, JSON.stringify(gotCards)); } catch(e){} }
  function isHiraganaOnly(s){ return /^[\u3041-\u3096\s]+$/.test(s); }

// ひらがな & 区切り（スペース/・/、,/／）だけ許可
function onlyHiraAndSep(s){
  return /^[\u3041-\u3096\s・,，、/／]+$/.test(s);
}
function splitTokens(ans){
  // 区切りをスペースに寄せて分割
  let s = ans.replace(/[・,，、/／]+/g, ' ');
  s = s.replace(/\s+/g, ' ').trim();
  return s ? s.split(' ') : [];
}

function onCardClick(card, name, ch){
  if(card.classList.contains("done")) return;
  const data = chapters[ch][name]; if(!data) return;

  const expected = blanksMap[name];
  if(!expected){ alert("このカードの空欄答えが未登録です"); return; }

  const hint = expected.length >= 2 ? "（空欄が2つ以上あるときは スペース や ・ で区切ってね）" : "";
  const msg =
`${name}

〇〇の部分だけを ひらがな でこたえてね！
例：島〇・天〇の乱 → ばら くさ
${hint}`;
  const userAnswer = prompt(msg);
  if(userAnswer === null) return;

  const raw = userAnswer.trim();
  if(!onlyHiraAndSep(raw)){ alert("ひらがな だけで入力してね（区切りは スペース/・/、/，/／ だけOK）"); return; }

  const tokens = splitTokens(raw);             // ["ばら","くさ"] など
  const joined = tokens.join("");              // "ばらくさ"
  const expectJoined = expected.join("");      // "ばらくさ"

  let ok = false;
  if(tokens.length === expected.length){
    ok = tokens.every((t,i)=>t === expected[i]);
  }else if(tokens.length === 1){
    ok = joined === expectJoined;              // まとめて入力でもOK
  }

  if(ok){
    // 正解：カード開放（表示は 〇〇 を残したまま、見えている漢字にふりがな）
    card.innerHTML = withRubyMasked(name);
    card.classList.add("done");
    infoBox.textContent = data.text;

    const b = document.createElement("div");
    b.className = "building";
    b.textContent = data.icon;
    b.style.left = (Math.random()*80 + 5) + "%";
    b.style.top = (Math.random()*70 + 5) + "%";
    town.appendChild(b);
    setTimeout(()=>b.classList.add("show"),50);

    const v = document.createElement("div");
    v.className = "villager";
    v.textContent = Math.random()>0.5 ? "😊" : "👘";
    v.style.top = Math.floor(Math.random()* (town.clientHeight-40)) + "px";
    town.appendChild(v);

    gotCards[name] = true;
    persist();
    renderZukan();
  } else {
    // 不正解：正解を 〇〇部分だけ で表示
    const right = expected.join(" ・ ");
    alert(`ざんねん！せいかいは「${right}」だよ（〇〇の部分だけ）`);
  }
}


  // ===== 図鑑（解放済みだけふりがな表示／〇〇維持） =====
  function renderZukan(){
    zukanList.innerHTML = "";
    let allComplete = true;
    for(const ch in chapters){
      const section = document.createElement("div");
      section.className = "zukanSec";
      section.innerHTML = `<h3>${ch}</h3>`;
      for(const name in chapters[ch]){
        const div = document.createElement("div");
        div.className = "zCard";
        if(gotCards[name]){
          div.innerHTML = withRubyMasked(name);
        }else{
          div.textContent = "？？？";
          div.classList.add("locked");
          allComplete = false;
        }
        section.appendChild(div);
      }
      zukanList.appendChild(section);
    }
    if(allComplete){
      completeMsg.textContent = "🎉 江戸コンプリート！おめでとう！ 🎉";
      launchPetals();
    }else{
      completeMsg.textContent = "";
    }
  }

  function launchPetals(){
    for(let i=0;i<24;i++){
      const p=document.createElement("div");
      p.className="petal";
      p.textContent="🌸";
      p.style.left = Math.random()*100 + "vw";
      p.style.animationDuration = (3 + Math.random()*3) + "s";
      document.body.appendChild(p);
      setTimeout(()=>p.remove(), 7000);
    }
  }

  // ===== 初期化 =====
  zukanBtn.addEventListener("click", ()=>{
    const active = !zukanPanel.classList.contains("active");
    zukanPanel.classList.toggle("active");
    zukanPanel.setAttribute("aria-hidden", active ? "false" : "true");
    zukanBtn.setAttribute("aria-expanded", String(active));
  });
  closeZukan.addEventListener("click", ()=>{
    zukanPanel.classList.remove("active");
    zukanPanel.setAttribute("aria-hidden","true");
    zukanBtn.setAttribute("aria-expanded","false");
  });
  chapterFilter.addEventListener("change", buildCards);

  buildCards();
  renderZukan();

  // 保存復元（建物＆住人）
  for(const ch in chapters){
    for(const name in chapters[ch]){
      if(!gotCards[name]) continue;
      const item = chapters[ch][name];
      const b = document.createElement("div");
      b.className = "building show";
      b.textContent = item.icon;
      b.style.left = (Math.random()*80 + 5) + "%";
      b.style.top = (Math.random()*70 + 5) + "%";
      town.appendChild(b);
      const v = document.createElement("div");
      v.className = "villager";
      v.textContent = Math.random()>0.5 ? "😊" : "👘";
      v.style.top = Math.floor(Math.random()* (town.clientHeight-40)) + "px";
      town.appendChild(v);
    }
  }
</script>

<!--
  固定のバナー広告を使う場合は、.adslot の中身をあなたの広告ユニットに置換し、
  直後で (adsbygoogle = window.adsbygoogle || []).push({}); を呼び出してください。
-->

</body>
</html>

