  <!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />
  <meta name="theme-color" content="#FCD34D" />
  <meta name="format-detection" content="telephone=no,email=no,address=no" />

  <!-- DNS Prefetch / Preconnect（計測・広告の初速改善） -->
  <link rel="dns-prefetch" href="//www.googletagmanager.com">
  <link rel="dns-prefetch" href="//pagead2.googlesyndication.com">
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin>

  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32"   href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="48x48"   href="/favicon-48x48.png">
  <link rel="apple-touch-icon"      sizes="180x180" href="/favicon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon-512x512.png">

  <!-- hreflang（将来の多言語展開を見越して） -->
  <link rel="alternate" hreflang="ja" href="https://historykids.github.io/">
  <link rel="alternate" hreflang="x-default" href="https://historykids.github.io/">
<!-- SEO -->
  <title>歴史キッズ｜3Dで街づくり！小学生・中学生・高校生向け 歴史クイズ・年表・図鑑で楽しく学ぶ（江戸・戦国・室町・鎌倉）</title>
  <meta name="description" content="歴史キッズは小学生・中学生・高校生向けの歴史学習サイト。江戸・戦国・室町・鎌倉の出来事を、ひらがなクイズ／年表（図鑑）／カード集め＆3D街づくりで楽しく勉強できます。スマホ最適化・無料。自由研究や受験対策にも役立ちます。" />
  <meta name="keywords" content="歴史,小学生,中学生,高校生,クイズ,年表,図鑑,江戸,戦国,室町,鎌倉,自由研究,社会,日本史,歴史人物" />
  <link rel="canonical" href="https://historykids.github.io/">

  <!-- OGP -->
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="ja_JP" />
  <meta property="og:url" content="https://historykids.github.io/" />
  <meta property="og:title" content="楽しく学べる！小中学生、高校生向け歴史学習サイト｜歴史キッズ" />
  <meta property="og:description" content="江戸・戦国・室町・鎌倉の出来事をカード収集と3D街づくりで学べる、子ども向け歴史勉強サイト。クイズ／年表／図鑑でテスト・受験にも。" />
  <meta property="og:image" content="https://historykids.github.io/thumbnail.png" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="楽しく学べる！小中学生・高校生向け歴史学習サイト｜歴史キッズ" />
  <meta name="twitter:description" content="江戸・戦国・室町・鎌倉の出来事をカード収集と3D街づくりで学べる歴史サイト。" />
  <meta name="twitter:image" content="https://historykids.github.io/thumbnail.png" />

  <!-- Google tag (gtag.js) ※1回のみ -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EZP12GC8W1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-EZP12GC8W1');
    gtag('config', 'G-6Z9WN4HFK5');
  </script>

  <!-- AdSense（1回だけ） -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4922140858632050" crossorigin="anonymous"></script>

  <!-- 構造化データ（WebSite + SitelinksSearchBox） -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebSite",
    "name":"歴史キッズ",
    "url":"https://historykids.github.io/",
    "inLanguage":"ja",
    "potentialAction":{
      "@type":"SearchAction",
      "target":"https://historykids.github.io/?q={search_term_string}#cards",
      "query-input":"required name=search_term_string"
    }
  }
  </script>

  <!-- 構造化データ（WebPage） -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebPage",
    "name":"歴史キッズ｜歴史クイズ・年表・図鑑",
    "url":"https://historykids.github.io/",
    "description":"江戸・戦国・室町・鎌倉を、クイズ／年表（図鑑）／カード集め＆3D街づくりで勉強できるサイト。自由研究にもおすすめ！小学生・中学生向けにスマホ最適化。"
  }
  </script>

  <!-- 構造化データ（FAQ） -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"FAQPage",
    "inLanguage":"ja",
    "mainEntity":[
      {"@type":"Question","name":"対象は小学生ですか？","acceptedAnswer":{"@type":"Answer","text":"はい。年少〜小学校低学年、中学生でも遊びながら歴史に親しめるように、ひらがなクイズや図鑑（年表）でやさしく学べます。"}},
      {"@type":"Question","name":"無料で使えますか？","acceptedAnswer":{"@type":"Answer","text":"無料で利用できます。サイト下部に広告が表示されます。"}},
      {"@type":"Question","name":"どんな学習内容がありますか？","acceptedAnswer":{"@type":"Answer","text":"江戸・戦国・室町・鎌倉の出来事を、年と出来事を結びつけるクイズ、年表の拡張表示、カード収集と3Dの街づくり演出で学べます。"}},
      {"@type":"Question","name":"自由研究に使えますか？","acceptedAnswer":{"@type":"Answer","text":"はい。歴史人物や年表をまとめて自由研究や調べ学習に活用できます。"}},
      {"@type":"Question","name":"スマホやタブレットでも使えますか？","acceptedAnswer":{"@type":"Answer","text":"はい。縦画面・1画面で遊べるよう最適化しています。"}}
    ]
  }
  </script>

  <!-- 構造化データ（BreadcrumbList） -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {"@type":"ListItem","position":1,"name":"ホーム","item":"https://historykids.github.io/"},
      {"@type":"ListItem","position":2,"name":"学習コンテンツ","item":"https://historykids.github.io/#cards"}
    ]
  }
  </script>

  <!-- 構造化データ（運営者） -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Person",
    "name":"しろながす",
    "jobTitle":"歴史キッズ 運営者",
    "url":"https://historykids.github.io/",
    "image":"https://historykids.github.io/歴史のキャラクターの紹介.png",
    "sameAs":[
      "https://x.com/your_handle",
      "https://github.com/your_github"
    ],
    "inLanguage":"ja"
  }
  </script>

  <!-- Search Console 所有権 -->
  <meta name="google-site-verification" content="bgJFyYeBgPsces8Rz5ONG_d-nj8ZEH_fHddcwAXMX0U" />

  <!-- ===== Styles ===== -->
  <style>
  :root{
    --edo-yellow:#FCD34D; --edo-info:#FFF8DC; --edo-border:#999;
    --bg:#FFF6E3; --shadow:rgba(0,0,0,.12); --ink:#222; --adbg:#f1f1f1;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
      "Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;
  }
  h2{ font-size:clamp(18px,3.5vw,22px); line-height:1.3; }

  .wrap{display:flex;flex-direction:column;min-height:100svh;}
  header{
    position:sticky;top:0;z-index:3;
    background:linear-gradient(180deg,var(--edo-yellow),#fde68a);
    padding:10px 12px;display:flex;gap:8px;align-items:center;justify-content:space-between;
    box-shadow:0 1px 4px var(--shadow);flex-wrap:wrap;
  }
  header h1.siteTitle{
    flex:1 1 100%;font-size:clamp(16px,2.6vw,22px);line-height:1.2;margin:0 0 6px 0;
    overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
  }
  header .controls{width:100%;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  header button, header select{
    border:0;border-radius:10px;background:#fff;padding:6px 12px;
    font-weight:700;box-shadow:0 1px 3px var(--shadow);cursor:pointer
  }
  #resetBtn{background:#ffeaea}
  .moneybox{margin-left:auto;background:#fff;border-radius:10px;padding:6px 10px;
    box-shadow:0 1px 3px rgba(0,0,0,.1);font-weight:700}
  #openShopBtn{background:#ffe28a;border:0;border-radius:10px;padding:6px 12px;font-weight:700;
    box-shadow:0 1px 3px rgba(0,0,0,.12);cursor:pointer}

  #intro{padding:10px 12px;background:#fff;}
  #info{
    padding:10px;background:var(--edo-info);border-bottom:1px solid #ccc;
    font-size:15px;min-height:40px
  }

  /* ====== 3Dエリア ====== */
  #town{ position:relative;width:100%;height:clamp(260px, 44vh, 520px); background:#fff;
         border-top:2px solid var(--edo-border); border-bottom:2px solid var(--edo-border); overflow:hidden }
  @media (min-width: 1024px){ #town{ height:clamp(320px, 50vh, 640px); } }
  #town > canvas{ display:block;width:100%;height:100%; touch-action:none;
    background-image: radial-gradient(rgba(0,0,0,.04) 1px, transparent 1px);
    background-size: 20px 20px; }

  .place-hud{
    position: fixed; right: 12px; bottom: 12px; z-index: 200;
    display: flex; gap: 8px; padding: 8px; border-radius: 10px;
    background: rgba(255,255,255,.92); box-shadow: 0 4px 16px rgba(0,0,0,.15);
  }
  .place-hud button{
    border: 0; border-radius: 10px; padding: 10px 12px; font-weight: 700;
    box-shadow: 0 1px 3px rgba(0,0,0,.1); cursor: pointer;
  }
  .place-hud #btnRotate{ background:#e0f2fe; }
  .place-hud #btnCancel{ background:#fee2e2; }

  #cards{
    display:grid;gap:10px;padding:10px;
    grid-template-columns:repeat(auto-fill, minmax(92px, 1fr));
  }
  @media (min-width: 768px){
    #cards{ grid-template-columns:repeat(auto-fill, minmax(120px, 1fr)); }
  }
  .card{
    height:120px;border-radius:12px;background:#ddd;
    display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;
    cursor:pointer;box-shadow:0 2px 6px var(--shadow);user-select:none;text-align:center;padding:6px;
    transition:transform .2s, box-shadow .2s
  }
  .card:hover{transform:scale(1.03);box-shadow:0 4px 12px var(--shadow)}
  .card.done{background:#cdeccd;color:#1a5e1a}

  .villager{position:absolute;font-size:20px;animation:walk 8s linear infinite}
  @keyframes walk{0%{left:2%}50%{left:90%}100%{left:2%}}

  #zukanPanel{position:fixed;inset:0 0 auto 0;height:72%;top:-100%;background:#fff;
    border-bottom:3px solid #333;box-shadow:0 4px 16px var(--shadow);
    transition:top .45s ease;z-index:5;overflow:auto}
  #zukanPanel.active{top:0}
  #zukanHead{position:sticky;top:0;background:#fff;padding:10px;border-bottom:1px solid #eee;
    display:flex;align-items:center;gap:8px}
  #zukanHead h2{margin:0;font-size:18px}
  #closeZukan{margin-left:auto;border:0;background:#eee;border-radius:8px;padding:6px 12px;cursor:pointer}
  .zukanSec{padding:10px}
  .zukanSec h3{margin:8px 0}
  .zCard{display:inline-flex;align-items:center;justify-content:center;width:96px;height:116px;margin:4px;
    border:1px solid #ccc;border-radius:8px;box-shadow:0 1px 3px var(--shadow);white-space:pre-line;text-align:center;padding:6px}
  .locked{background:#eee;color:#999}
  #completeMsg{font-size:18px;font-weight:800;color:green;text-align:center;padding:10px}

  .petal{position:fixed;top:-10px;font-size:20px;animation:fall linear forwards;pointer-events:none}
  @keyframes fall{to{transform:translateY(110vh) rotate(360deg);opacity:0}}

  .adbar{position:sticky;bottom:0;background:var(--adbg);border-top:1px solid #ddd;
    padding:4px 8px;display:flex;justify-content:center;align-items:center;min-height:52px}
  .adslot{width:100%;max-width:728px;height:50px;background:
    repeating-linear-gradient(45deg,#eee,#eee 8px,#e2e2e2 8px,#e2e2e2 16px);
    border:1px dashed #bbb;border-radius:8px;display:flex;align-items:center;justify-content:center;
    font-size:12px;color:#666}
  footer{height:8px}

  .landscapeWarn{
    position:fixed;inset:0;background:rgba(0,0,0,.65);color:#fff;display:none;
    align-items:center;justify-content:center;z-index:20;text-align:center;padding:20px
  }
  @media (orientation:landscape) and (max-width: 768px){ .landscapeWarn{display:flex} }

  ruby rt{font-size:.7em;color:#444}
  .yr{font-weight:800;margin-right:2px}

  /* モーダル共通 */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:100; }
  .modal-overlay.active { display:flex; }
  .modal-box { background:#fff; border-radius:12px; max-width:640px; width:92%; max-height:90vh; overflow:auto; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.2); position:relative; }
  .modal-box h2 { margin-top:0; font-size:18px; }
  .modal-close { position:absolute; top:10px; right:10px; border:0; background:#eee; border-radius:50%; width:32px; height:32px; cursor:pointer; font-weight:800; }

  /* ショップモーダル */
  .shop-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;
    align-items:center;justify-content:center;z-index:120}
  .shop-overlay.active{display:flex}
  .shop-box{background:#fff;border-radius:12px;max-width:760px;width:94%;max-height:90vh;
    overflow:auto;padding:14px 14px 6px;box-shadow:0 6px 24px rgba(0,0,0,.25);position:relative}
  .shop-close{position:absolute;top:10px;right:10px;border:0;background:#eee;border-radius:50%;
    width:32px;height:32px;cursor:pointer;font-weight:800}
  .shop-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
  .shop-card{border:1px solid #ddd;border-radius:10px;padding:10px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
  .shop-card h4{margin:0 0 6px 0;font-size:15px}
  .shop-card .preview{font-size:28px;height:36px}
  .shop-card .buyrow{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:6px}
  .shop-card button{border:0;border-radius:8px;padding:6px 10px;font-weight:700;cursor:pointer;
    box-shadow:0 1px 3px rgba(0,0,0,.1)}
  .shop-card .price{color:#444}
  .shop-tip{font-size:13px;color:#444;margin:8px 0 0}
  .toolrow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .toolrow .toolbtn{border:1px solid #ddd;background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
  .toolrow .toolbtn.active{background:#e6f4ff;border-color:#8ecbff}


    /* ===== ジョイスティック ===== */
.joypad{
  position: fixed; left: 12px; bottom: 12px; z-index: 220;
  width: 120px; height: 120px; touch-action: none; user-select: none;
}
.joypad .joy-base{
  position: absolute; inset: 0;
  border-radius: 999px; background: rgba(255,255,255,.9);
  box-shadow: 0 4px 16px rgba(0,0,0,.18), inset 0 0 0 2px rgba(0,0,0,.08);
}
.joypad .joy-stick{
  position: absolute; left: 50%; top: 50%; width: 56px; height: 56px;
  margin-left: -28px; margin-top: -28px; border-radius: 999px;
  background: rgba(0,0,0,.18); backdrop-filter: blur(2px);
  box-shadow: 0 2px 10px rgba(0,0,0,.22);
  transition: transform .05s linear;
}

  </style>
</head>

<body>
<!-- admax -->
<!-- admax -->

<div class="wrap">
  <header>
    <h1 class="siteTitle">歴史キッズ｜楽しく学べる！小学生・中学生向け歴史学習サイト</h1>

    <div class="controls">
      <label for="eraSelect" style="font-size:12px">時代：</label>
      <select id="eraSelect" title="時代をえらぶ">
        <option value="edo">江戸時代</option>
        <option value="muromachi">室町時代</option>
        <option value="kamakura">鎌倉時代</option>
        <option value="sengoku">戦国時代</option>
      </select>

      <select id="chapterFilter" title="章をえらぶ">
        <option value="ALL">章：ぜんぶ</option>
      </select>

      <button id="zukanBtn" aria-controls="zukanPanel" aria-expanded="false">図鑑</button>
      <button id="resetBtn" title="進捗を全部消して最初から">リセット</button>

      <!-- 所持金とショップ -->
      <div class="moneybox" aria-live="polite">
        💰 <b id="moneyValue">0</b> 両
      </div>
      <button id="openShopBtn" title="ショップを開く">ショップ</button>
    </div>
  </header>

  <section id="intro">
    <p style="margin:0 0 8px;">
      小学生・中学生向けの<span style="font-weight:700;">歴史学習サイト</span>です。<br>
      <b>江戸・戦国・室町・鎌倉</b>の出来事を、<b>クイズ</b>と<b>年表</b>、<b>カード集め</b>で楽しく学べます（スマホ対応・無料）。
    </p>
    <h2>戦国時代の歴史を勉強できるクイズ</h2>
    <h2>江戸時代の歴史を勉強できるクイズ</h2>
    <h2>室町時代の歴史を勉強できるクイズ</h2>
    <h2>鎌倉時代の歴史を勉強できるクイズ</h2>
    <h2>年表・図鑑で歴史人物をチェック</h2>
    <h2>自由研究やテスト勉強にも役立つ</h2>

    <nav style="display:flex;gap:8px;flex-wrap:wrap;">
      <a href="#cards" id="playEdo" style="display:inline-block;background:#fcd34d;padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none;color:#222;">江戸時代で遊ぶ</a>
      <a href="#cards" id="playSengoku" style="display:inline-block;background:#f6d5a4;padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none;color:#222;">戦国時代で遊ぶ</a>
      <a href="#cards" id="playMuromachi" style="display:inline-block;background:#fde68a;padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none;color:#222;">室町時代で遊ぶ</a>
      <a href="#cards" id="playKamakura" style="display:inline-block;background:#f9e2af;padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none;color:#222;">鎌倉時代で遊ぶ</a>
      <a href="#zukanPanel" id="openZukan" style="display:inline-block;background:#e5e7eb;padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none;color:#111;">図鑑（年表）を見る</a>
      <a href="#" id="openProfile" style="display:inline-block;background:#e0f2fe;padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none;color:#111;">プロフィール</a>
      <a href="#" id="openContact" style="display:inline-block;background:#dcfce7;padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none;color:#111;">お問い合わせ</a>
    </nav>
  </section>

  <!-- PR -->
  <div class="promoBar" role="note" aria-label="おすすめの本（PR）" style="background:#fffbe6;border-bottom:1px solid #e6d400;padding:8px 12px;display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap;box-shadow:0 1px 3px rgba(0,0,0,.08);">
    <b style="color:#b58900;">PR</b>
    <span class="title" style="font-weight:700;">歴史入門にぴったり！<strong>ドラえもんの社会科おもしろ攻略 日本の歴史</strong>（小学館）</span>
    <a id="promoLink" class="button" href="https://amzn.asia/d/bu7qdsv" target="_blank" rel="noopener sponsored nofollow"
       style="display:inline-block;background:#ffd814;color:#111;padding:8px 12px;border-radius:8px;font-weight:700;text-decoration:none;box-shadow:0 1px 3px rgba(0,0,0,.15);">
       Amazonで見る
    </a>
    <small style="color:#666;">※当サイトはアフィリエイト広告を利用しています</small>
  </div>

  <!-- プロフィール / お問い合わせ モーダル -->
  <div id="profileModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
    <div class="modal-box">
      <button class="modal-close" data-close>×</button>
      <h2 id="profileTitle">プロフィール</h2>
      <div class="profile-card" style="display:flex;gap:12px;align-items:center;">
        <img src="https://historykids.github.io/かわいい青いクジラ.png" alt="サイト管理人のアイコン" class="profile-avatar" width="176" height="176" loading="lazy" decoding="async" />
        <div class="profile-meta">
          <div class="profile-name">サイト管理人：<b>しろながす</b></div>
          <p style="margin:0;color:#444">小学生〜中学生が <b>クイズ・年表・カード</b>で歴史に親しめるサイトを目指して開発・運営しています。</p>
          <ul class="profile-list">
            <li>こどもでも<b>スマホ１台</b>で学べるUIに</li>
            <li>読みやすい <b>ふりがな</b> と <b>ひらがな回答</b>に対応</li>
            <li>学校の <b>自由研究</b>や <b>テスト対策</b>にも活用</li>
          </ul>
          <div class="socials" aria-label="SNSリンク">
            <a class="chip" href="mailto:you@example.com">メール</a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="contactModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="contactTitle">
    <div class="modal-box">
      <button class="modal-close" data-close>×</button>
      <h2 id="contactTitle">お問い合わせ</h2>
      <p style="margin:0 0 8px;color:#444">ご意見・ご要望・誤字のご指摘など、お気軽にお知らせください。</p>
      <p><a href="https://docs.google.com/forms/d/e/1FAIpQLSdHvqKAszs5j860tNIeesVlE83pMpP_qP9QrNLuJJaZ9g3h5Q/viewform" target="_blank" rel="noopener" style="display:inline-block;background:#fcd34d;padding:10px 14px;border-radius:8px;font-weight:700;color:#111;text-decoration:none;">Googleフォームを開く</a></p>
    </div>
  </div>

  <!-- ===== ショップ モーダル ===== -->
  <div id="shopOverlay" class="shop-overlay" role="dialog" aria-modal="true" aria-labelledby="shopTitle">
    <div class="shop-box">
      <button id="shopClose" class="shop-close" aria-label="ショップをとじる">×</button>
      <h2 id="shopTitle" style="margin:0 0 8px 0;font-size:18px;">ショップ</h2>
      <div class="toolrow">
        <button class="toolbtn" data-filter="ALL">すべて</button>
        <button class="toolbtn" data-filter="building">建物</button>
        <button class="toolbtn" data-filter="nature">自然</button>
        <button class="toolbtn" data-filter="infrastructure">インフラ</button>
      </div>
      <div id="shopGrid" class="shop-grid" aria-live="polite"></div>
      <p class="shop-tip">クイズに正解すると💰がふえます。買った建物は好きな場所に置けます。</p>
    </div>
  </div>

  <div id="info" role="status" aria-live="polite">時代をえらんでカードをめくろう！ 〇の部分だけを「ひらがな」で答えると開くよ。</div>

  <!-- ======== ここが街（3D） ======== -->
  <div id="town" role="img" aria-label="町エリア"></div>

  <!-- 配置モード用のスマホHUD -->
  <div id="placeHud" class="place-hud" hidden>
    <button id="btnRotate" type="button" aria-label="回転">回転 ↻</button>
    <button id="btnOK"     type="button" aria-label="決定">決定 ✅</button><!-- ★追加 -->
    <button id="btnCancel" type="button" aria-label="キャンセル">キャンセル</button>
  </div>

  <div id="cards" aria-label="カードエリア"></div>

  <section id="zukanPanel" aria-hidden="true">
    <div id="zukanHead">
      <h2>カード図鑑（章ごと）</h2>
      <button id="closeZukan" aria-label="図鑑をとじる">とじる</button>
    </div>
    <div id="zukanList"></div>
    <div id="completeMsg"></div>
  </section>

  <!-- 広告枠 -->
  <div class="adbar" aria-label="広告枠">
    <div class="adslot">広告スペース</div>
  </div>
  <footer aria-hidden="true"></footer>
</div>

<div class="landscapeWarn">縦向きで遊んでね🔄</div>

<!-- クイズ用モーダル -->
<div id="quizModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:30">
  <div class="modal-bg" id="quizBg" style="position:absolute;inset:0;background:rgba(0,0,0,.5)"></div>
  <div class="modal-box" style="position:relative;z-index:1;width:min(92vw,560px);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:14px">
    <div id="quizTitle" class="quiz-title" style="font-weight:800;font-size:16px;margin:0 0 6px 0"></div>
    <p class="quiz-instruction" style="font-size:14px;margin:6px 0 10px 0;color:#444">
      〇のところだけを <b>ひらがな</b> でこたえてね。<br>
      空欄がいくつかあるときは <b>スペース / ・ / 、 / ／</b> で区切ってOK。
      <span id="quizHint" style="color:#666"></span>
    </p>
    <input id="quizInput" type="text" inputmode="text" autocomplete="off"
           placeholder="ここに ひらがな を入力（例：てんぽう）"
           style="width:100%;padding:10px 12px;font-size:16px;border:1px solid #ccc;border-radius:10px" />
    <div class="quiz-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="quizCancel" style="border:0;border-radius:10px;padding:8px 14px;background:#eee;cursor:pointer;box-shadow:0 1px 3px var(--shadow);">やめる</button>
      <button id="quizOk" style="border:0;border-radius:10px;padding:8px 14px;background:#cdeccd;color:#145f14;font-weight:700;cursor:pointer;box-shadow:0 1px 3px var(--shadow);">決定</button>
    </div>
  </div>
</div>

  <!-- スティック（ジョイスティック） -->
<div id="joypad" class="joypad" aria-label="スティック" hidden>
  <div class="joy-base"></div>
  <div class="joy-stick"></div>
</div>


<script>
/* ========== モーダル開閉（プロフィール/お問い合わせ） ========== */
(function(){
  const modals = document.querySelectorAll('.modal-overlay');
  document.getElementById('openProfile')?.addEventListener('click', e=>{ e.preventDefault(); document.getElementById('profileModal').classList.add('active'); });
  document.getElementById('openContact')?.addEventListener('click', e=>{ e.preventDefault(); document.getElementById('contactModal').classList.add('active'); });
  modals.forEach(m=>{
    m.addEventListener('click', e=>{ if(e.target===m) m.classList.remove('active'); });
    m.querySelectorAll('[data-close]').forEach(btn=>btn.addEventListener('click', ()=>m.classList.remove('active')));
  });
})();
</script>

<script>
/* =========================================================
   データセット（江戸／室町／鎌倉／戦国）
   ========================================================= */
const dataSets = {
  /* ---------- 江戸時代 ---------- */
  edo: {
    title: "江戸時代",
    LS_KEY: "cards_edo_complete_v1",
    chapters: {
      "初期": {
        "1603 〇〇幕府がはじまる": { text: "家康が将軍になり、江戸で国の中心が動き出す。", icon: "🏯", year: 1603 },
        "1615 〇〇〇〇の陣":       { text: "大きなたたかいが終わり、豊臣の時代に幕。", icon: "⚔️", year: 1615 },
        "1635 〇〇〇〇交代":          { text: "大名は国と江戸を行き来するきまりに。", icon: "🚶", year: 1635 },
        "1637 島〇〇・天〇〇の乱":  { text: "九州で大きな一揆が起きる。", icon: "🔥", year: 1637 },
        "1639 〇〇〇〇〇船の来航禁止": { text: "外国船の出入りをしめて、交流をせいげん。", icon: "⛵", year: 1639 },
        "1641 〇〇〇での貿易":      { text: "オランダ商館が長崎の出島へ。", icon: "🏝️", year: 1641 },
        "1657 〇〇〇〇の大火":      { text: "江戸の町が大火事。町づくりを立て直す。", icon: "🔥", year: 1657 },
        "1657 〇〇〇〇〇〇へ移転":  { text: "遊郭が浅草千束の新しい場所へ。", icon: "🏮", year: 1657 }
      },
      "中期": {
        "1688 〇〇〇〇文化がさかえる": { text: "町人の文化が花ひらく。歌舞伎や浮世絵が人気。", icon: "🎭", year: 1688 },
        "1716 〇〇〇〇〇の改革":         { text: "吉宗がくらしと財政を立て直す工夫をはじめる。", icon: "📜", year: 1716 },
        "1720 〇〇〇〇をとりいれる":   { text: "海外の学びが広がり、知識がふえる。", icon: "📚", year: 1720 },
        "1720 〇〇〇〇〇のしくみ":     { text: "火事にそなえる町人の組ができる。", icon: "🚒", year: 1720 },
        "1730 〇〇のながれを整える":   { text: "商いのきまりをととのえ、町を元気に。", icon: "🧺", year: 1730 },
        "1775 〇〇〇の時代":           { text: "商いを活かす政治でお金の流れをよくする試み。", icon: "💹", year: 1775 },
        "1783 〇〇〇〇のききん":       { text: "寒さや不作で食べ物がたりなくなる。", icon: "🌾", year: 1783 }
      },
      "幕末": {
        "1787 〇〇〇〇の改革":         { text: "くらしをひきしめ、教育も大切にする方針。", icon: "📝", year: 1787 },
        "1825 〇〇〇〇〇打払令":       { text: "近づく外国船を追いはらうきまり。", icon: "📣", year: 1825 },
        "1837 〇〇〇〇〇〇〇〇〇〇の乱": { text: "大阪で人びとの苦しさが爆発。", icon: "⚠️", year: 1837 },
        "1841 〇〇〇〇の改革":           { text: "町の決まりを見直し、ぜいたくをおさえる。", icon: "📏", year: 1841 },
        "1853 〇〇〇〇が来る":         { text: "アメリカの船が浦賀に来航。", icon: "⛴️", year: 1853 },
        "1854 〇〇〇条約":             { text: "日本は港を開き、交流をはじめる。", icon: "🤝", year: 1854 },
        "1858 〇〇〇〇の条約":         { text: "いくつかの国とむすび、貿易が広がる。", icon: "🌐", year: 1858 },
        "1858 〇〇〇〇の大獄":         { text: "意見のちがいで多くの人が処罰される。", icon: "⚖️", year: 1858 },
        "1860 〇〇〇〇〇〇〇〇の変":   { text: "政治の対立が事件に。", icon: "🗡️", year: 1860 },
        "1867 〇〇〇〇奉還":           { text: "政（まつりごと）を朝廷にお返し。", icon: "🗝️", year: 1867 },
        "1868 〇〇〇へ":               { text: "新しい時代のスタート！", icon: "🌸", year: 1868 }
      }
    },
    ruby: {
      "1603 〇〇幕府がはじまる": "〇〇<ruby>幕府<rt>ばくふ</rt></ruby>がはじまる",
      "1615 〇〇〇〇の陣": "〇〇〇〇の<ruby>陣<rt>じん</rt></ruby>",
      "1635 〇〇〇〇交代": "〇〇〇〇<ruby>交代<rt>こうたい</rt></ruby>",
      "1637 島〇〇・天〇〇の乱": "島〇〇・天〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1639 〇〇〇〇〇船の来航禁止": "〇〇〇〇〇<ruby>船<rt>せん</rt></ruby>の<ruby>来航<rt>らいこう</rt></ruby><ruby>禁止<rt>きんし</rt></ruby>",
      "1641 〇〇〇での貿易": "〇〇〇での<ruby>貿易<rt>ぼうえき</rt></ruby>",
      "1657 〇〇〇〇の大火": "〇〇〇〇の<ruby>大火<rt>たいか</rt></ruby>",
      "1657 〇〇〇〇〇〇へ移転": "〇〇〇〇〇〇へ<ruby>移転<rt>いてん</rt></ruby>",
      "1688 〇〇〇〇文化がさかえる": "〇〇〇〇<ruby>文化<rt>ぶんか</rt></ruby>がさかえる",
      "1716 〇〇〇〇〇の改革": "〇〇〇〇〇の<ruby>改革<rt>かいかく</rt></ruby>",
      "1720 〇〇〇〇をとりいれる": "〇〇〇〇をとりいれる",
      "1720 〇〇〇〇〇のしくみ": "〇〇〇〇〇のしくみ",
      "1730 〇〇のながれを整える": "〇〇のながれを<ruby>整える<rt>ととのえる</rt></ruby>",
      "1775 〇〇〇の時代": "〇〇〇の<ruby>時代<rt>じだい</rt></ruby>",
      "1783 〇〇〇〇のききん": "〇〇〇〇のききん",
      "1787 〇〇〇〇の改革": "〇〇〇〇の<ruby>改革<rt>かいかく</rt></ruby>",
      "1825 〇〇〇〇〇打払令": "〇〇〇〇〇<ruby>打払令<rt>うちはらいれい</rt></ruby>",
      "1837 〇〇〇〇〇〇〇〇〇〇の乱": "〇〇〇〇〇〇〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1841 〇〇〇〇の改革": "〇〇〇〇の<ruby>改革<rt>かいかく</rt></ruby>",
      "1853 〇〇〇〇が来る": "〇〇〇〇が<ruby>来<rt>く</rt></ruby>る",
      "1854 〇〇〇条約": "〇〇〇<ruby>条約<rt>じょうやく</rt></ruby>",
      "1858 〇〇〇〇の条約": "〇〇〇〇の<ruby>条約<rt>じょうやく</rt></ruby>",
      "1858 〇〇〇〇の大獄": "〇〇〇〇の<ruby>大獄<rt>たいごく</rt></ruby>",
      "1860 〇〇〇〇〇〇〇〇の変": "〇〇〇〇〇〇〇〇の<ruby>変<rt>へん</rt></ruby>",
      "1867 〇〇〇〇奉還": "〇〇〇〇<ruby>奉還<rt>ほうかん</rt></ruby>",
      "1868 〇〇〇へ": "〇〇〇へ"
    },
    blanks: {
      "1603 〇〇幕府がはじまる": ["えど"],
      "1615 〇〇〇〇の陣": ["おおさか"],
      "1635 〇〇〇〇交代": ["さんきん"],
      "1637 島〇〇・天〇〇の乱": ["ばら","くさ"],
      "1639 〇〇〇〇〇船の来航禁止": ["ぽるとがる"],
      "1641 〇〇〇での貿易": ["でじま"],
      "1657 〇〇〇〇の大火": ["めいれき"],
      "1657 〇〇〇〇〇〇へ移転": ["しんよしわら"],
      "1688 〇〇〇〇文化がさかえる": ["げんろく"],
      "1716 〇〇〇〇〇の改革": ["きょうほう"],
      "1720 〇〇〇〇をとりいれる": ["ようしょ"],
      "1720 〇〇〇〇〇のしくみ": ["まちびけし"],
      "1730 〇〇のながれを整える": ["もの"],
      "1775 〇〇〇の時代": ["たぬま"],
      "1783 〇〇〇〇のききん": ["てんめい"],
      "1787 〇〇〇〇の改革": ["かんせい"],
      "1825 〇〇〇〇〇打払令": ["いこくせん"],
      "1837 〇〇〇〇〇〇〇〇〇〇の乱": ["おおしおへいはちろう"],
      "1841 〇〇〇〇の改革": ["てんぽう"],
      "1853 〇〇〇〇が来る": ["くろふね"],
      "1854 〇〇〇条約": ["わしん"],
      "1858 〇〇〇〇の条約": ["あんせい"],
      "1858 〇〇〇〇の大獄": ["あんせい"],
      "1860 〇〇〇〇〇〇〇〇の変": ["さくらだもんがい"],
      "1867 〇〇〇〇奉還": ["たいせい"],
      "1868 〇〇〇へ": ["めいじ"]
    }
  },

  /* ---------- 室町時代 ---------- */
  muromachi: {
    title: "室町時代",
    LS_KEY: "cards_muromachi_complete_v1",
    chapters: {
      "初期（南北朝〜）": {
        "1336 〇〇〇〇幕府がはじまる": { text: "足利氏の幕府が京都で始まる。", icon: "🏯", year: 1336 },
        "1392 〇〇〇〇〇〇〇統一":       { text: "南朝と北朝がひとつになる。", icon: "🤝", year: 1392 },
        "1397 〇〇〇〇が建てられる":   { text: "きらびやかな建物（鹿苑寺）。", icon: "🏯", year: 1397 },
        "1390 〇〇〇〇文化がさかえる": { text: "能や茶の湯など都の文化が発展。", icon: "🎭", year: 1390 },
        "1401 〇〇〇〇貿易がはじまる": { text: "明との勘合（証明）を用いた貿易。", icon: "🛶", year: 1401 }
      },
      "中期（文化と争い）": {
        "1439 〇〇〇〇〇の乱":         { text: "関東で大きな戦い（将軍側と対立）。", icon: "⚔️", year: 1439 },
        "1441 〇〇〇の乱":             { text: "将軍が討たれる事件（赤松氏ら）。", icon: "⚠️", year: 1441 },
        "1467 〇〇〇〇の乱":           { text: "京都が荒廃、のちの戦国時代へ。", icon: "🔥", year: 1467 },
        "1485 〇〇〇〇国一揆":         { text: "人びとが協力して自治（山城国）。", icon: "🛡️", year: 1485 },
        "1489 〇〇〇〇が建てられる":   { text: "静かな美（慈照寺・銀閣）。", icon: "🏯", year: 1489 },
        "1493 〇〇〇〇の政変":         { text: "細川氏の政変で権力が移る。", icon: "🌀", year: 1493 }
      },
      "後期（戦国の入口）": {
        "1543 〇〇〇〇伝来":           { text: "新しい道具が日本へ（鉄砲）。", icon: "🔫", year: 1543 },
        "1549 〇〇〇〇教伝来":         { text: "キリスト教が日本に広がる。", icon: "⛪", year: 1549 },
        "1555 〇〇〇〇〇の戦い":       { text: "厳島の戦い、武将が勢力拡大。", icon: "🗺️", year: 1555 },
        "1573 〇〇〇〇幕府がおわる":   { text: "将軍追放で幕府が終わりへ。", icon: "🌅", year: 1573 }
      }
    },
    ruby: {
      "1336 〇〇〇〇幕府がはじまる": "〇〇〇〇<ruby>幕府<rt>ばくふ</rt></ruby>がはじまる",
      "1392 〇〇〇〇〇〇〇統一":       "〇〇〇〇〇〇〇<ruby>統一<rt>とういつ</rt></ruby>",
      "1397 〇〇〇〇が建てられる":   "〇〇〇〇が<ruby>建<rt>た</rt></ruby>てられる",
      "1390 〇〇〇〇文化がさかえる": "〇〇〇〇<ruby>文化<rt>ぶんか</rt></ruby>がさかえる",
      "1401 〇〇〇〇貿易がはじまる": "〇〇〇〇<ruby>貿易<rt>ぼうえき</rt></ruby>がはじまる",
      "1439 〇〇〇〇〇の乱":         "〇〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1441 〇〇〇の乱":             "〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1467 〇〇〇〇の乱":           "〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1485 〇〇〇〇国一揆":         "〇〇〇〇<ruby>国<rt>くに</rt></ruby><ruby>一揆<rt>いっき</rt></ruby>",
      "1489 〇〇〇〇が建てられる":   "〇〇〇〇が<ruby>建<rt>た</rt></ruby>てられる",
      "1493 〇〇〇〇の政変":         "〇〇〇〇の<ruby>政変<rt>せいへん</rt></ruby>",
      "1543 〇〇〇〇伝来":           "〇〇〇〇<ruby>伝来<rt>でんらい</rt></ruby>",
      "1549 〇〇〇〇教伝来":         "〇〇〇〇<ruby>教<rt>きょう</rt></ruby><ruby>伝来<rt>でんらい</rt></ruby>",
      "1555 〇〇〇〇〇の戦い":       "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1573 〇〇〇〇幕府がおわる":   "〇〇〇〇<ruby>幕府<rt>ばくふ</rt></ruby>が<ruby>終<rt>お</rt></ruby>わる"
    },
    blanks: {
      "1336 〇〇〇〇幕府がはじまる": ["むろまち"],
      "1392 〇〇〇〇〇〇〇統一":       ["なんぼくちょう"],
      "1397 〇〇〇〇が建てられる":   ["きんかく"],
      "1390 〇〇〇〇文化がさかえる": ["きたやま"],
      "1401 〇〇〇〇貿易がはじまる": ["かんごう"],
      "1439 〇〇〇〇〇の乱":         ["えいきょう"],
      "1441 〇〇〇の乱":             ["かきつ"],
      "1467 〇〇〇〇の乱":           ["おうにん"],
      "1485 〇〇〇〇国一揆":         ["やましろ"],
      "1489 〇〇〇〇が建てられる":   ["ぎんかく"],
      "1493 〇〇〇〇の政変":         ["めいおう"],
      "1543 〇〇〇〇伝来":           ["てっぽう"],
      "1549 〇〇〇〇教伝来":         ["きりすと"],
      "1555 〇〇〇〇〇の戦い":       ["いつくしま"],
      "1573 〇〇〇〇幕府がおわる":   ["むろまち"]
    }
  },

  /* ---------- 鎌倉時代 ---------- */
  kamakura: {
    title: "鎌倉時代",
    LS_KEY: "cards_kamakura_complete_v1",
    chapters: {
      "初期（源平〜創設）": {
        "1180 〇〇〇〇合戦がはじまる": { text: "源氏と平氏の大きなたたかいが始まる。", icon: "⚔️", year: 1180 },
        "1185 〇〇〇〇〇の戦い":       { text: "壇ノ浦で勝敗が決まる。", icon: "🚩", year: 1185 },
        "1185 〇〇〇・〇〇〇の設置":   { text: "国ごとに守る人・土地をおさめる人が置かれる。", icon: "🛡️", year: 1185 },
        "1185 〇〇〇〇幕府がはじまる": { text: "武士の政治が本格スタート。", icon: "🏯", year: 1185 },
        "1192 〇〇〇〇が将軍に":       { text: "よりともが将軍になる。", icon: "👑", year: 1192 }
      },
      "中期（執権政治）": {
        "1203 〇〇〇〇政治がはじまる": { text: "北条氏がまとめる政治（執権政治）。", icon: "📜", year: 1203 },
        "1213 〇〇合戦":               { text: "和田氏とのたたかい。", icon: "⚔️", year: 1213 },
        "1221 〇〇〇〇の乱":           { text: "朝廷との大きな対立（承久の乱）。", icon: "⚠️", year: 1221 },
        "1232 〇〇〇〇〇〇〇〇〇が定まる": { text: "武士のルール（御成敗式目）ができる。", icon: "📖", year: 1232 },
        "1247 〇〇〇合戦":             { text: "有力武士のあらそい（宝治合戦）。", icon: "🛡️", year: 1247 },
        "1252 〇〇〇〇ができる":       { text: "鎌倉大仏がつくられる。", icon: "🗿", year: 1252 }
      },
      "後期（元寇〜滅亡）": {
        "1274 〇〇〇〇の役":           { text: "元が攻めてくる（文永の役）。", icon: "⛴️", year: 1274 },
        "1281 〇〇〇〇の役":           { text: "ふたたび元が攻める（弘安の役）。", icon: "⛴️", year: 1281 },
        "1297 〇〇〇〇〇〇が出る":     { text: "借金をゆるす命令（徳政令）。", icon: "📢", year: 1297 },
        "1305 〇〇〇〇騒動":           { text: "有力者どうしの対立（霜月騒動）。", icon: "🌪️", year: 1305 },
        "1331 〇〇〇〇の乱":           { text: "朝廷がたちあがる（元弘の乱）。", icon: "⚠️", year: 1331 },
        "1333 〇〇〇〇幕府がほろぶ":   { text: "鎌倉幕府が終わる。", icon: "🌅", year: 1333 }
      },
      "文化（新しい仏教）": {
        "1175 〇〇〇〇宗が広まる":     { text: "法然の教え（浄土宗）。", icon: "🙏", year: 1175 },
        "1191 〇〇〇〇宗が伝わる":     { text: "栄西の教え（臨済宗）。", icon: "🧘", year: 1191 },
        "1224 〇〇〇〇真宗が広まる":   { text: "親鸞の教え（浄土真宗）。", icon: "🙏", year: 1224 },
        "1227 〇〇〇宗が広まる":       { text: "一遍の教え（時宗）。", icon: "🙏", year: 1227 },
        "1247 〇〇〇〇宗が広まる":     { text: "道元の教え（曹洞宗）。", icon: "🧘", year: 1247 },
        "1253 〇〇〇〇宗が広まる":     { text: "日蓮の教え（日蓮宗）。", icon: "🕊️", year: 1253 }
      }
    },
    ruby: {
      "1180 〇〇〇〇合戦がはじまる": "〇〇〇〇<ruby>合戦<rt>かっせん</rt></ruby>がはじまる",
      "1185 〇〇〇〇〇の戦い":       "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1185 〇〇〇・〇〇〇の設置":   "〇〇〇・〇〇〇の<ruby>設置<rt>せっち</rt></ruby>",
      "1185 〇〇〇〇幕府がはじまる": "〇〇〇〇<ruby>幕府<rt>ばくふ</rt></ruby>がはじまる",
      "1192 〇〇〇〇が将軍に":       "〇〇〇〇が<ruby>将軍<rt>しょうぐん</rt></ruby>に",
      "1203 〇〇〇〇政治がはじまる": "〇〇〇〇<ruby>政治<rt>せいじ</rt></ruby>がはじまる",
      "1213 〇〇合戦":               "〇〇<ruby>合戦<rt>かっせん</rt></ruby>",
      "1221 〇〇〇〇の乱":           "〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1232 〇〇〇〇〇〇〇〇〇が定まる": "〇〇〇〇〇〇〇〇〇が<ruby>定<rt>さだ</rt></ruby>まる",
      "1247 〇〇〇合戦":             "〇〇〇<ruby>合戦<rt>かっせん</rt></ruby>",
      "1252 〇〇〇〇ができる":       "〇〇〇〇ができる",
      "1274 〇〇〇〇の役":           "〇〇〇〇の<ruby>役<rt>えき</rt></ruby>",
      "1281 〇〇〇〇の役":           "〇〇〇〇の<ruby>役<rt>えき</rt></ruby>",
      "1297 〇〇〇〇〇〇が出る":     "〇〇〇〇〇〇が<ruby>出<rt>で</rt></ruby>る",
      "1305 〇〇〇〇騒動":           "〇〇〇〇<ruby>騒動<rt>そうどう</rt></ruby>",
      "1331 〇〇〇〇の乱":           "〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1333 〇〇〇〇幕府がほろぶ":   "〇〇〇〇<ruby>幕府<rt>ばくふ</rt></ruby>がほろぶ",
      "1175 〇〇〇〇宗が広まる":     "〇〇〇〇<ruby>宗<rt>しゅう</rt></ruby>が広まる",
      "1191 〇〇〇〇宗が伝わる":     "〇〇〇〇<ruby>宗<rt>しゅう</rt></ruby>が<ruby>伝<rt>つた</rt></ruby>わる",
      "1224 〇〇〇〇真宗が広まる":   "〇〇〇〇<ruby>真宗<rt>しんしゅう</rt></ruby>が広まる",
      "1227 〇〇〇宗が広まる":       "〇〇〇<ruby>宗<rt>しゅう</rt></ruby>が広まる",
      "1247 〇〇〇〇宗が広まる":     "〇〇〇〇<ruby>宗<rt>しゅう</rt></ruby>が広まる",
      "1253 〇〇〇〇宗が広まる":     "〇〇〇〇<ruby>宗<rt>しゅう</rt></ruby>が広まる"
    },
    blanks: {
      "1180 〇〇〇〇合戦がはじまる": ["げんぺい"],
      "1185 〇〇〇〇〇の戦い":       ["たんのうら"],
      "1185 〇〇〇・〇〇〇の設置":   ["しゅご","じとう"],
      "1185 〇〇〇〇幕府がはじまる": ["かまくら"],
      "1192 〇〇〇〇が将軍に":       ["よりとも"],
      "1203 〇〇〇〇政治がはじまる": ["しっけん"],
      "1213 〇〇合戦":               ["わだ"],
      "1221 〇〇〇〇の乱":           ["じょうきゅう"],
      "1232 〇〇〇〇〇〇〇〇〇が定まる": ["ごせいばいしきもく"],
      "1247 〇〇〇合戦":             ["ほうじ"],
      "1252 〇〇〇〇ができる":       ["だいぶつ"],
      "1274 〇〇〇〇の役":           ["ぶんえい"],
      "1281 〇〇〇〇の役":           ["こうあん"],
      "1297 〇〇〇〇〇〇が出る":     ["とくせいれい"],
      "1305 〇〇〇〇騒動":           ["しもつき"],
      "1331 〇〇〇〇の乱":           ["げんこう"],
      "1333 〇〇〇〇幕府がほろぶ":   ["かまくら"],
      "1175 〇〇〇〇宗が広まる":     ["じょうど"],
      "1191 〇〇〇〇宗が伝わる":     ["りんざい"],
      "1224 〇〇〇〇真宗が広まる":   ["じょうど"],
      "1227 〇〇〇宗が広まる":       ["じしゅう"],
      "1247 〇〇〇〇宗が広まる":     ["そうとう"],
      "1253 〇〇〇〇宗が広まる":     ["にちれん"]
    }
  },

  /* ---------- 戦国時代 ---------- */
  sengoku: {
    title: "戦国時代",
    LS_KEY: "cards_sengoku_complete_v1",
    chapters: {
      "前期（戦乱のはじまり）": {
        "1467 〇〇〇〇の乱":                { text: "京都で大きな戦いがはじまり、全国に広がる。", icon: "🔥", year: 1467 },
        "1485 〇〇〇〇国一揆":              { text: "人びとが協力して自治（山城国）。", icon: "🛡️", year: 1485 }
      },
      "群雄割拠": {
        "1543 〇〇〇〇伝来":                { text: "新しい武器が伝わる（鉄砲）。", icon: "🔫", year: 1543 },
        "1549 〇〇〇〇教伝来":              { text: "キリスト教が日本に広がる。", icon: "⛪", year: 1549 },
        "1555 〇〇〇〇〇の戦い":            { text: "厳島の戦い、武将が勢力拡大。", icon: "🗺️", year: 1555 },
        "1560 〇〇〇〇〇の戦い":            { text: "桶狭間の戦い、奇襲でかつ。", icon: "⚔️", year: 1560 },
        "1561 〇〇〇〇〇〇の戦い":          { text: "川中島の戦い、名将どうしが激突。", icon: "⚔️", year: 1561 },
        "1567 〇〇に改名（稲葉山→〜）":    { text: "城下町の名をあらためる（岐阜）。", icon: "🏯", year: 1567 },
        "1568 〇〇〇〇が京都に入る":        { text: "都をおさえて天下へ進む。", icon: "🏯", year: 1568 }
      },
      "統一へ": {
        "1570 〇〇〇〇の戦い":              { text: "姉川の戦い。", icon: "⚔️", year: 1570 },
        "1571 〇〇〇〇〇焼き討ち":          { text: "比叡山を攻める。", icon: "🔥", year: 1571 },
        "1573 〇〇〇〇幕府がおわる":        { text: "室町幕府の終わり。", icon: "🌅", year: 1573 },
        "1575 〇〇〇〇の戦い":              { text: "長篠の戦い、鉄砲で勝つ。", icon: "🔫", year: 1575 },
        "1576 〇〇〇城を築く":              { text: "安土城をつくる。", icon: "🏰", year: 1576 },
        "1582 〇〇〇〇〇の変":              { text: "本能寺の変。", icon: "🗡️", year: 1582 },
        "1582 〇〇〇〇の戦い":              { text: "山崎の戦い。", icon: "⚔️", year: 1582 },
        "1583 〇〇〇〇〇の戦い":            { text: "賤ヶ岳の戦い。", icon: "⚔️", year: 1583 },
        "1584 〇〇〇・〇〇〇〇の戦い":      { text: "小牧・長久手の戦い。", icon: "⚔️", year: 1584 },
        "1585 〇〇〇〇になる":              { text: "関白になる。", icon: "🎖️", year: 1585 },
        "1587 〇〇〇〇〇〇を平定":          { text: "九州をおさめる。", icon: "🗾", year: 1587 },
        "1588 〇〇〇〇〇〇〇令":            { text: "刀狩令を出す。", icon: "📢", year: 1588 },
        "1590 〇〇〇〇の戦い":              { text: "小田原の戦い。", icon: "⚔️", year: 1590 },
        "1591 〇〇〇〇〇〇〇〇が出る":      { text: "身分統制令を出す。", icon: "📜", year: 1591 },
        "1592 〇〇〇〇〇〇〇の役":          { text: "朝鮮へ出兵（文禄の役）。", icon: "⛴️", year: 1592 },
        "1597 〇〇〇〇〇〇〇〇の役":        { text: "ふたたび出兵（慶長の役）。", icon: "⛴️", year: 1597 },
        "1598 〇〇〇〇がなくなる":          { text: "秀吉が亡くなる。", icon: "🕊️", year: 1598 },
        "1600 〇〇〇〇〇の戦い":            { text: "関ヶ原の戦い。", icon: "⚔️", year: 1600 }
      },
      "政策と町づくり": {
        "1577 〇〇〇〇・〇〇〇をすすめる":  { text: "楽市・楽座をすすめ、商いが活発に。", icon: "🛍️", year: 1577 },
        "1582 〇〇〇〇検地がすすむ":        { text: "田んぼの広さをはかり、税を決める（太閤検地）。", icon: "📏", year: 1582 },
        "1583 〇〇〇〇城を築く":            { text: "大阪城を築く。", icon: "🏯", year: 1583 }
      }
    },
    ruby: {
      "1467 〇〇〇〇の乱":                 "〇〇〇〇の<ruby>乱<rt>らん</rt></ruby>",
      "1485 〇〇〇〇国一揆":               "〇〇〇〇<ruby>国<rt>くに</rt></ruby><ruby>一揆<rt>いっき</rt></ruby>",
      "1543 〇〇〇〇伝来":                 "〇〇〇〇<ruby>伝来<rt>でんらい</rt></ruby>",
      "1549 〇〇〇〇教伝来":               "〇〇〇〇<ruby>教<rt>きょう</rt></ruby><ruby>伝来<rt>でんらい</rt></ruby>",
      "1555 〇〇〇〇〇の戦い":             "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1560 〇〇〇〇〇の戦い":             "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1561 〇〇〇〇〇〇の戦い":           "〇〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1567 〇〇に改名（稲葉山→〜）":     "〇〇に<ruby>改名<rt>かいめい</rt></ruby>（<ruby>稲葉山<rt>いなばやま</rt></ruby>→〜）",
      "1568 〇〇〇〇が京都に入る":         "〇〇〇〇が<ruby>京都<rt>きょうと</rt></ruby>に<ruby>入<rt>はい</rt></ruby>る",
      "1570 〇〇〇〇の戦い":               "〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1571 〇〇〇〇〇焼き討ち":           "〇〇〇〇〇<ruby>焼<rt>や</rt></ruby>き<ruby>討<rt>う</rt></ruby>ち",
      "1573 〇〇〇〇幕府がおわる":         "〇〇〇〇<ruby>幕府<rt>ばくふ</rt></ruby>が<ruby>終<rt>お</rt></ruby>わる",
      "1575 〇〇〇〇の戦い":               "〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1576 〇〇〇城を築く":               "〇〇〇<ruby>城<rt>じょう</rt></ruby>を<ruby>築<rt>きず</rt></ruby>く",
      "1582 〇〇〇〇〇の変":               "〇〇〇〇〇の<ruby>変<rt>へん</rt></ruby>",
      "1582 〇〇〇〇の戦い":               "〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1583 〇〇〇〇〇の戦い":             "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1584 〇〇〇・〇〇〇〇の戦い":       "〇〇〇・〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1585 〇〇〇〇になる":               "〇〇〇〇に<ruby>成<rt>な</rt></ruby>る",
      "1587 〇〇〇〇〇〇を平定":           "〇〇〇〇〇〇を<ruby>平定<rt>へいてい</rt></ruby>",
      "1588 〇〇〇〇〇〇〇令":             "〇〇〇〇〇〇〇<ruby>令<rt>れい</rt></ruby>",
      "1590 〇〇〇〇の戦い":               "〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1591 〇〇〇〇〇〇〇〇が出る":       "〇〇〇〇〇〇〇〇が<ruby>出<rt>で</rt></ruby>る",
      "1592 〇〇〇〇〇〇〇の役":           "〇〇〇〇〇〇〇の<ruby>役<rt>えき</rt></ruby>",
      "1597 〇〇〇〇〇〇〇〇の役":         "〇〇〇〇〇〇〇〇の<ruby>役<rt>えき</rt></ruby>",
      "1598 〇〇〇〇がなくなる":           "〇〇〇〇が<ruby>亡<rt>な</rt></ruby>くなる",
      "1600 〇〇〇〇〇の戦い":             "〇〇〇〇〇の<ruby>戦<rt>たたか</rt></ruby>い",
      "1577 〇〇〇〇・〇〇〇をすすめる":   "〇〇〇〇・〇〇〇を<ruby>勧<rt>すす</rt></ruby>める",
      "1582 〇〇〇〇検地がすすむ":         "〇〇〇〇<ruby>検地<rt>けんち</rt></ruby>がすすむ",
      "1583 〇〇〇〇城を築く":             "〇〇〇〇<ruby>城<rt>じょう</rt></ruby>を<ruby>築<rt>きず</rt></ruby>く"
    },
    blanks: {
      "1467 〇〇〇〇の乱":                ["おうにん"],
      "1485 〇〇〇〇国一揆":              ["やましろ"],
      "1543 〇〇〇〇伝来":                ["てっぽう"],
      "1549 〇〇〇〇教伝来":              ["きりすと"],
      "1555 〇〇〇〇〇の戦い":            ["いつくしま"],
      "1560 〇〇〇〇〇の戦い":            ["おけはざま"],
      "1561 〇〇〇〇〇〇の戦い":          ["かわなかじま"],
      "1567 〇〇に改名（稲葉山→〜）":    ["ぎふ"],
      "1568 〇〇〇〇が京都に入る":        ["のぶなが"],
      "1570 〇〇〇〇の戦い":              ["あねがわ"],
      "1571 〇〇〇〇〇焼き討ち":          ["ひえいざん"],
      "1573 〇〇〇〇幕府がおわる":        ["むろまち"],
      "1575 〇〇〇〇の戦い":              ["ながしの"],
      "1576 〇〇〇城を築く":              ["あづち"],
      "1582 〇〇〇〇〇の変":              ["ほんのうじ"],
      "1582 〇〇〇〇の戦い":              ["やまざき"],
      "1583 〇〇〇〇〇の戦い":            ["しずがたけ"],
      "1584 〇〇〇・〇〇〇〇の戦い":      ["こまき","ながくて"],
      "1585 〇〇〇〇になる":              ["かんぱく"],
      "1587 〇〇〇〇〇〇を平定":          ["きゅうしゅう"],
      "1588 〇〇〇〇〇〇〇令":            ["かたながりれい"],
      "1590 〇〇〇〇の戦い":              ["おだわら"],
      "1591 〇〇〇〇〇〇〇〇が出る":      ["みぶんとうせいれい"],
      "1592 〇〇〇〇〇〇〇の役":          ["ぶんろくのえき"],
      "1597 〇〇〇〇〇〇〇〇の役":        ["けいちょうのえき"],
      "1598 〇〇〇〇がなくなる":          ["ひでよし"],
      "1600 〇〇〇〇〇の戦い":            ["せきがはら"],
      "1577 〇〇〇〇・〇〇〇をすすめる":  ["らくいち","らくざ"],
      "1582 〇〇〇〇検地がすすむ":        ["たいこう"],
      "1583 〇〇〇〇城を築く":            ["おおさか"]
    }
  }
};
</script>

<script>
/* ========= メインロジック（UI/状態管理） ========= */
function onlyHiraAndSep(s){ return /^[\u3041-\u3096\s・,，、/／]+$/.test(s); }
function splitTokens(ans){ let s=ans.replace(/[・,，、/／]+/g,' ').replace(/\s+/g,' ').trim();return s? s.split(' '):[]; }
function normalizeTokens(arr){ return arr.map(s=>s.replace(/\s+/g,'').trim()); }

const eraSelectEl     = document.getElementById("eraSelect");
const chapterFilterEl = document.getElementById("chapterFilter");
const cardsWrap       = document.getElementById("cards");
const infoBoxEl       = document.getElementById("info");
const moneyEl         = document.getElementById("moneyValue");
const zukanPanelEl    = document.getElementById("zukanPanel");
const zukanBtnEl      = document.getElementById("zukanBtn");
const closeZukanEl    = document.getElementById("closeZukan");
const resetBtnEl      = document.getElementById("resetBtn");
const openShopBtnEl   = document.getElementById("openShopBtn");
const shopOverlayEl   = document.getElementById("shopOverlay");
const shopCloseEl     = document.getElementById("shopClose");
const shopGridEl      = document.getElementById("shopGrid");

/* スマホHUD */
const placeHud  = document.getElementById("placeHud");
const btnRotate = document.getElementById("btnRotate");
const btnCancel = document.getElementById("btnCancel");

/* 進捗＆所持金 */
const COLS = 30, ROWS = 18;
let currentEra = eraSelectEl ? eraSelectEl.value : "edo";
let gotCards   = {};
let money      = 0;
let cityBuildings = []; // [{id,type,x,y,rot}...]

function persist(){
  try{
    localStorage.setItem(dataSets[currentEra].LS_KEY, JSON.stringify(gotCards));
    localStorage.setItem("money_v1", String(money));
    localStorage.setItem("city_v1", JSON.stringify(cityBuildings));
  }catch(e){}
}
function loadProgress(){
  try{ gotCards = JSON.parse(localStorage.getItem(dataSets[currentEra].LS_KEY) || "{}"); }catch{ gotCards = {}; }
  money = Number(localStorage.getItem("money_v1") || "0");
  try{ cityBuildings = JSON.parse(localStorage.getItem("city_v1") || "[]"); }catch{ cityBuildings = []; }
  moneyEl.textContent = money;
  sync3DLayer();
}

/* 図鑑 */
zukanBtnEl?.addEventListener("click", ()=>{ zukanPanelEl.classList.add("active"); zukanPanelEl.setAttribute("aria-hidden","false"); });
closeZukanEl?.addEventListener("click", ()=>{ zukanPanelEl.classList.remove("active"); zukanPanelEl.setAttribute("aria-hidden","true"); });

/* 章プルダウン */
function buildChapterFilter(){
  if(!chapterFilterEl) return;
  chapterFilterEl.innerHTML = `<option value="ALL">章：ぜんぶ</option>`;
  const chapters = dataSets[currentEra].chapters;
  Object.keys(chapters).forEach(ch=>{
    const opt = document.createElement("option");
    opt.value = ch; opt.textContent = ch;
    chapterFilterEl.appendChild(opt);
  });
}

  function pickOnGround(ev){
  setPointerFromEvent(ev);
  raycaster.setFromCamera(pointer, camera);

  const hit = raycaster.intersectObject(ground, false)[0];
  if (hit) return { cell: worldToGrid(hit.point.x, hit.point.z), hit };

  // 予備: y=0 の平面
  const plane = new THREE.Plane(new THREE.Vector3(0,1,0), 0);
  const p3 = new THREE.Vector3();
  if (raycaster.ray.intersectPlane(plane, p3)) {
    return { cell: worldToGrid(p3.x, p3.z), hit: null };
  }
  return null;
}

  function openQuiz(name){
  currentQuizName = name;
  quizTitleEl.textContent = name;
  quizHintEl.textContent  = "（例：てんぽう／わしん など ひらがなで）";
  quizHintEl.style.color = "#666"; // ★追加：色を毎回リセット
  quizInputEl.value = "";
  quizModalEl.style.display = "flex";
  setTimeout(()=>quizInputEl.focus(), 0);
}


/* ルビ表記 */
function withRubyMasked(fullName){
  const m = dataSets[currentEra].ruby[fullName];
  if(m){
    const sp = fullName.indexOf(" ");
    const year = fullName.slice(0, sp);
    return `<span class="yr">${year}</span> ${m}`;
  }
  return fullName;
}

/* カード生成 */
function buildCards(){
  if(!cardsWrap) return;
  cardsWrap.innerHTML = "";
  const sel = chapterFilterEl ? chapterFilterEl.value : "ALL";
  const chapters = dataSets[currentEra].chapters;

  Object.keys(chapters).forEach(ch=>{
    if(sel !== "ALL" && sel !== ch) return;
    Object.keys(chapters[ch]).forEach(name=>{
      const el = document.createElement("div");
      el.className = "card";
      el.dataset.card = name;
      el.setAttribute("role","button");
      el.setAttribute("tabindex","0");

      if(gotCards[name]){
        el.innerHTML = withRubyMasked(name);
        el.classList.add("done");
      }else{
        el.textContent = "？\n" + name.split(" ")[0];
      }
      el.addEventListener("click", ()=>onCardClick(el, name));
      el.addEventListener("keydown", (e)=>{ if(e.key==="Enter" || e.key===" "){ e.preventDefault(); onCardClick(el, name); }});
      cardsWrap.appendChild(el);
    });
  });
}

/* クイズ処理 */
const quizModalEl = document.getElementById("quizModal");
const quizTitleEl = document.getElementById("quizTitle");
const quizHintEl  = document.getElementById("quizHint");
const quizInputEl = document.getElementById("quizInput");
const quizOkEl    = document.getElementById("quizOk");
const quizCancelEl= document.getElementById("quizCancel");
const quizBgEl    = document.getElementById("quizBg");
let currentQuizName = null;

function openQuiz(name){
  currentQuizName = name;
  quizTitleEl.textContent = name;
  quizHintEl.textContent  = "（例：てんぽう／わしん など ひらがなで）";
  quizInputEl.value = "";
  quizModalEl.style.display = "flex";
  setTimeout(()=>quizInputEl.focus(), 0);
}
function closeQuiz(){ quizModalEl.style.display = "none"; currentQuizName = null; }
function onCardClick(_el, name){ if(gotCards[name]) return; openQuiz(name); }

quizOkEl?.addEventListener("click", ()=>{
  if(!currentQuizName) return;
  const blanks = dataSets[currentEra].blanks[currentQuizName] || [];
  const ansRaw = quizInputEl.value || "";
  if(!onlyHiraAndSep(ansRaw)){ alert("ひらがなで入力してね（区切りは スペース / ・ / 、 / ／ でもOK）"); return; }
  const userTokens = normalizeTokens(splitTokens(ansRaw));
  const needTokens = normalizeTokens(blanks);
  const ok = needTokens.length>0 && needTokens.every(tok => userTokens.includes(tok));
  if(ok){
    gotCards[currentQuizName] = true;
    money += 10;
    moneyEl.textContent = money;
    persist();
    buildCards();
    closeQuiz();
    infoBoxEl.textContent = "正解！💰がふえたよ。ショップで好きな場所に建物を置いてみよう！";
 }else{
  const ans = needTokens.join("・");
  // 画面下のインフォに出す
  infoBoxEl.textContent = "ざんねん！正解は「" + ans + "」だよ。";
  // モーダル内にも出す（赤字）
  quizHintEl.textContent = "→ 正解：" + ans + "（ひらがな）";
  quizHintEl.style.color = "#c62828";
  // モーダルは開いたまま（やり直し可能）
}
});
quizCancelEl?.addEventListener("click", closeQuiz);
quizBgEl?.addEventListener("click", closeQuiz);

/* ショップ */
const SHOP_ITEMS = [
  { id:"house",   name:"家",        price:30,  cat:"building",      preview:"🏠" },
  { id:"shop",    name:"商家",      price:40,  cat:"building",      preview:"🏪" },
  { id:"castle",  name:"城",        price:120, cat:"building",      preview:"🏯" },
  { id:"temple",  name:"寺社",      price:70,  cat:"building",      preview:"⛩️" },
  { id:"tree",    name:"木",        price:8,   cat:"nature",        preview:"🌳" },
  { id:"field",   name:"畑",        price:12,  cat:"nature",        preview:"🌾" },
  { id:"water",   name:"水辺",      price:15,  cat:"nature",        preview:"🌊" },
  { id:"road",    name:"道路",      price:10,  cat:"infrastructure",preview:"🛣️" },
  { id:"bridge",  name:"橋",        price:25,  cat:"infrastructure",preview:"🌉" },
  { id:"school",  name:"学校",      price:80,  cat:"building",      preview:"🏫" }
];

let shopFilter = "ALL";
function renderShop(){
  if(!shopGridEl) return;
  shopGridEl.innerHTML = "";
  SHOP_ITEMS
    .filter(it => shopFilter === "ALL" || it.cat === shopFilter)
    .forEach(it => {
      const card = document.createElement("div");
      card.className = "shop-card";
      card.innerHTML = `
        <h4>${it.name}</h4>
        <div class="preview">${it.preview}</div>
        <div class="buyrow">
          <span class="price">💰${it.price} 両</span>
          <button data-buy="${it.id}">買う</button>
        </div>`;
      shopGridEl.appendChild(card);
    });

  shopGridEl.querySelectorAll("[data-buy]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-buy");
      const item = SHOP_ITEMS.find(s => s.id === id);
      if(!item) return;
      startPlacementFlow(item); // 位置選択モードへ
    });
  });
}
openShopBtnEl?.addEventListener("click", ()=>{ shopOverlayEl.classList.add("active"); renderShop(); });
shopCloseEl?.addEventListener("click", ()=> shopOverlayEl.classList.remove("active"));
shopOverlayEl?.addEventListener("click", (e)=>{ if(e.target===shopOverlayEl) shopOverlayEl.classList.remove("active"); });
document.querySelectorAll(".toolrow .toolbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".toolrow .toolbtn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    shopFilter = btn.getAttribute("data-filter") || "ALL";
    renderShop();
  });
});

/* 配置フロー */
let pendingPurchase = null; // {type, price, rot}
function occupiedKey(x,y){ return `${x},${y}`; }
function occupiedSet(){ return new Set(cityBuildings.map(b=>occupiedKey(b.x,b.y))); }

function startPlacementFlow(item){
 if(money < item.price){
    alert("お金が足りないよ！クイズで💰を増やしてからもう一度ためしてね。");
    return;
  }
  pendingPurchase = { type: item.id, price: item.price, rot: 0 };
  infoBoxEl.textContent = "置く場所をえらんでね（タップ/クリックで確定、右クリック/Escでキャンセル、R/↻で回転）";
  shopOverlayEl.classList.remove("active");

  // 3Dレイヤーへ開始通知（占有マスと盤面サイズを渡す）
  const occ = Array.from(occupiedSet()).map(s=>s.split(',').map(n=>Number(n)));
  document.dispatchEvent(new CustomEvent("placement:start", {
    detail: { type: item.id, cols: COLS, rows: ROWS, occupied: occ }
  }));
}

/* 3Dからの配置確定/キャンセル通知 */
document.addEventListener("placement:confirm", (ev)=>{
  if(!pendingPurchase) return;
  const { x, y, rot=0, type } = ev.detail || {};
  if(x<0 || y<0 || x>=COLS || y>=ROWS){ infoBoxEl.textContent="はみ出してるよ！別の場所に置いてね。"; return; }
  if(occupiedSet().has(occupiedKey(x,y))){ infoBoxEl.textContent="その場所は使えないよ！"; return; }
  if(money < pendingPurchase.price){ alert("お金が足りないよ！"); document.dispatchEvent(new Event("placement:end")); pendingPurchase=null; return; }

  money -= pendingPurchase.price;
  moneyEl.textContent = money;
  placeBuildingAt(type, x, y, rot);
  infoBoxEl.textContent = "設置したよ！";
  pendingPurchase = null;
  persist();
  document.dispatchEvent(new Event("placement:end"));
  sparkle();
});
document.addEventListener("placement:cancel", ()=>{ pendingPurchase = null; infoBoxEl.textContent = "キャンセルしたよ。"; });

/* 実配置（保存→3Dへ通知） */
function placeBuildingAt(type, x, y, rot=0){
  const id = Date.now().toString(36) + Math.random().toString(36).slice(2,7);
  const placed = { id, type, x, y, rot };
  cityBuildings.push(placed);
  persist();
  document.dispatchEvent(new CustomEvent("city:add", { detail: placed }));
}

/* 設置後の回転：Three側から保存更新 */
document.addEventListener("edit:rotate", (ev)=>{
  const { id, rot } = ev.detail || {};
  const t = cityBuildings.find(b => b.id === id);
  if(!t) return;
  t.rot = rot % 360;
  persist();
});

/* 全体を3Dへ同期（読込・リセット時） */
function sync3DLayer(){
  document.dispatchEvent(new CustomEvent("city:reset"));
  cityBuildings.forEach(b=> document.dispatchEvent(new CustomEvent("city:add", { detail: b })));
}

/* きらきら演出 */
function sparkle(){
  for(let i=0;i<8;i++){
    const p=document.createElement("div");
    p.className="petal"; p.textContent="✨";
    p.style.left = (20+Math.random()*60) + "vw";
    p.style.animationDuration = (2 + Math.random()*1.5) + "s";
    document.body.appendChild(p);
    setTimeout(()=>p.remove(), 4000);
  }
}

/* リセット */
resetBtnEl?.addEventListener("click", ()=>{
  if(!confirm("進捗と所持金をリセットしますか？")) return;
  gotCards = {}; money = 0; cityBuildings = [];
  persist(); buildCards(); moneyEl.textContent = money;
  infoBoxEl.textContent = "リセットしました。カードをめくって学ぼう！";
  sync3DLayer();
});

/* セレクト変更 */
eraSelectEl?.addEventListener("change", ()=>{
  currentEra = eraSelectEl.value;
  loadProgress();
  buildChapterFilter();
  buildCards();
});
chapterFilterEl?.addEventListener("change", buildCards);

/* ナビのショートカット */
document.getElementById("playEdo")?.addEventListener("click", ()=>{ eraSelectEl.value="edo";      eraSelectEl.dispatchEvent(new Event("change")); });
document.getElementById("playSengoku")?.addEventListener("click", ()=>{ eraSelectEl.value="sengoku"; eraSelectEl.dispatchEvent(new Event("change")); });
document.getElementById("playMuromachi")?.addEventListener("click", ()=>{ eraSelectEl.value="muromachi";eraSelectEl.dispatchEvent(new Event("change")); });
document.getElementById("playKamakura")?.addEventListener("click", ()=>{ eraSelectEl.value="kamakura"; eraSelectEl.dispatchEvent(new Event("change")); });

/* スマホHUD連携 */
document.addEventListener("placement:start", ()=>{ placeHud.hidden = false; });
document.addEventListener("placement:end",   ()=>{ placeHud.hidden = true;  });
document.addEventListener("placement:cancel",()=>{ placeHud.hidden = true;  });
btnRotate?.addEventListener("click", ()=>{ document.dispatchEvent(new Event("placement:rotate")); });
btnCancel?.addEventListener("click", ()=>{ document.dispatchEvent(new Event("placement:cancel")); });

/* 起動 */
function init(){
  currentEra = eraSelectEl ? eraSelectEl.value : "edo";
  loadProgress();
  buildChapterFilter();
  buildCards();
  document.querySelector('.toolrow .toolbtn[data-filter="ALL"]')?.classList.add("active");
}
document.addEventListener("DOMContentLoaded", init);


  /* ========== スティック操作（ジョイスティック） ========== */
const joypadEl  = document.getElementById("joypad");
const joyStick  = joypadEl?.querySelector(".joy-stick");

let joyActive = false, joyRAF = null, joyDir = {dx:0, dy:0}, joyLastStepAt = 0;

function joyShow(){ if(joypadEl) joypadEl.hidden = false; }
function joyHide(){ if(joypadEl) joypadEl.hidden = true; }

function quantizeDir(vx, vy){
  // vx: 右+, vy: 上+（後でy反転する）
  const mag = Math.hypot(vx, vy);
  if (mag < 0.15) return {dx:0, dy:0, speed:0}; // デッドゾーン

  // 角度を8方向に量子化
  const ang = Math.atan2(vy, vx); // -PI..PI
  const sector = Math.round(ang / (Math.PI/4)); // -4..4
  const dir8 = (sector + 8) % 8;

  // 8方向 → (dx,dy)
  const table = [
    {dx:1, dy:0},   // 0: →
    {dx:1, dy:1},   // 1: ↗
    {dx:0, dy:1},   // 2: ↑
    {dx:-1,dy:1},   // 3: ↖
    {dx:-1,dy:0},   // 4: ←
    {dx:-1,dy:-1},  // 5: ↙
    {dx:0, dy:-1},  // 6: ↓
    {dx:1, dy:-1}   // 7: ↘
  ];
  const {dx, dy} = table[dir8];

  // 速度（外周ほど速い）
  let speed;
  if (mag > 0.85) speed = 60;     // ms/step
  else if (mag > 0.55) speed = 90;
  else speed = 130;

  // 画面上では上がマイナスに進むので、yはそのまま（THREE側で減少が上）
  // ここでは {dx,dy} をそのまま渡す（dy:-1が下、+1が上になるよう THREE側で扱う）
  return {dx, dy, speed};
}

function joyStepLoop(ts){
  if(!joyActive){ joyRAF = null; return; }
  if(!joyDir.speed){ joyRAF = requestAnimationFrame(joyStepLoop); return; }

  if(ts - joyLastStepAt >= joyDir.speed){
    document.dispatchEvent(new CustomEvent("placement:nudge", { detail: { dx: joyDir.dx, dy: -joyDir.dy }}));
    // ↑ dy を反転：画面の上方向ドラッグで「手前→上（y-1）」へ
    joyLastStepAt = ts;
  }
  joyRAF = requestAnimationFrame(joyStepLoop);
}

function joyStart(x, y){
  joyActive = true; joyLastStepAt = 0;
  // スティック位置を動かす
  joyMove(x, y);
  if(!joyRAF) joyRAF = requestAnimationFrame(joyStepLoop);
}
function joyMove(x, y){
  const rect = joypadEl.getBoundingClientRect();
  const cx = rect.left + rect.width/2;
  const cy = rect.top  + rect.height/2;
  let dx = (x - cx) / (rect.width/2);   // -1..1
  let dy = (y - cy) / (rect.height/2);  // -1..1
  const mag = Math.hypot(dx, dy);
  if(mag > 1){ dx/=mag; dy/=mag; }

  // ノブ見た目
  if(joyStick){
    const px = dx * 28, py = dy * 28; // 半径 ~28px
    joyStick.style.transform = `translate(${px}px, ${py}px)`;
  }

  joyDir = quantizeDir(dx, -dy); // 画面座標→上が正に見えるよう反転して量子化
}
function joyEnd(){
  joyActive = false; joyDir = {dx:0, dy:0, speed:0};
  if(joyRAF){ cancelAnimationFrame(joyRAF); joyRAF = null; }
  if(joyStick){ joyStick.style.transform = "translate(0,0)"; }
}

// 入力イベント
if(joypadEl){
  const onDown = (e)=>{ const p = e.touches ? e.touches[0] : e; joyStart(p.clientX, p.clientY); };
  const onMove = (e)=>{ if(!joyActive) return; const p = e.touches ? e.touches[0] : e; joyMove(p.clientX, p.clientY); };
  const onUp   = ()=> joyEnd();

  joypadEl.addEventListener("pointerdown", onDown);
  joypadEl.addEventListener("pointermove", onMove);
  window.addEventListener("pointerup", onUp);
  joypadEl.addEventListener("touchstart", onDown, {passive:false});
  joypadEl.addEventListener("touchmove",  onMove, {passive:false});
  window.addEventListener("touchend", onUp);
}

// 配置フローと連動（表示/非表示）
document.addEventListener("placement:start", ()=>{ joyShow(); });
document.addEventListener("placement:end",   ()=>{ joyHide(); joyEnd(); });
document.addEventListener("placement:cancel",()=>{ joyHide(); joyEnd(); });

// 「決定」ボタン → THREE 側にOKシグナル
document.getElementById("btnOK")?.addEventListener("click", ()=>{
  document.dispatchEvent(new Event("placement:ok"));
});


  </script>

  <script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

  

<!-- ===== Three.js レイヤー（モジュール） ===== -->
<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';



const townEl = document.getElementById("town");
let renderer, scene, camera, controls, loader, ground, grid;
let placed3D = [];
let COLS = 30, ROWS = 18;
const WORLD_SCALE = 1.0;
const clamp = (v, min, max) => Math.max(min, Math.min(max, v)); // ←ここに常駐させる
function gridToWorld(x, y){
  const ox = Math.floor(COLS/2), oy = Math.floor(ROWS/2);
  return new THREE.Vector3((x-ox)*WORLD_SCALE, 0, (y-oy)*WORLD_SCALE);
}
function worldToGrid(X,Z){
  const ox = Math.floor(COLS/2), oy = Math.floor(ROWS/2);
  return { x: Math.round(X/WORLD_SCALE)+ox, y: Math.round(Z/WORLD_SCALE)+oy };
}
// ★ 1) 追加：地面に載せるユーティリティ（Three.js モジュール内の上の方に）
const EPS_Y = 0.01; // ごくわずか持ち上げて z-fighting 回避
function snapBaseY(obj, targetY = 0){
  obj.updateWorldMatrix(true, true);
  const box = new THREE.Box3().setFromObject(obj);
  const dy  = (targetY + EPS_Y) - box.min.y; // 底面を targetY に合わせる
  obj.position.y += dy;
  obj.updateWorldMatrix(true, true);
}

function ensureRenderer(){
  if(renderer) return;
  const w = townEl.clientWidth, h = townEl.clientHeight;

  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
  renderer.setSize(w, h);
  renderer.domElement.style.position = "absolute";
  renderer.domElement.style.inset = "0";
  townEl.style.position = "relative";
  townEl.appendChild(renderer.domElement);

  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(50, w/h, 0.1, 1000);

  controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.06;
  // ★ 4) 既存設定のすぐ下あたりに追記（ensureRenderer 内）
controls.maxPolarAngle = Math.PI / 2 - 0.01; // 水平ちょい上まで
controls.minPolarAngle = 0.1;
controls.screenSpacePanning = false;          // 画面座標ではなく世界座標でパン

// ターゲット/Y位置のクランプ：地面より下に行かせない
controls.addEventListener('change', () => {
  const minTargetY = 0.1;
  if (controls.target.y < minTargetY) {
    const dy = minTargetY - controls.target.y;
    controls.target.y += dy;
    camera.position.y = Math.max(camera.position.y + dy, minTargetY + 0.01);
  }
});


  // ★ 盤面中央を注視（最重要）
  const center = gridToWorld(Math.floor(COLS/2), Math.floor(ROWS/2));
  controls.target.copy(center);
  camera.position.set(center.x + 15, 18, center.z + 22);

  scene.add(new THREE.AmbientLight(0xffffff, 1.0));
  const dir = new THREE.DirectionalLight(0xffffff, 1.2);
  dir.position.set(10, 20, 10);
  scene.add(dir);

  const plane = new THREE.PlaneGeometry(100, 100);
  const pm = new THREE.MeshBasicMaterial({ color: 0xd7f4d2, side: THREE.FrontSide }); // ★裏面は描画しない
  ground = new THREE.Mesh(plane, pm);
  ground.rotation.x = -Math.PI/2;
  ground.name = "ground";
  scene.add(ground);

  grid = new THREE.GridHelper(100, 100, 0x000000, 0x000000);
  grid.material.opacity = 0.08;
  grid.material.transparent = true;
  scene.add(grid);

  loader = new GLTFLoader();

  renderer.setAnimationLoop(()=>{ controls.update(); renderer.render(scene, camera); });

  controls.minPolarAngle = 0.1;                 // 真上までは行かない
controls.maxPolarAngle = Math.PI / 2.02;      // 地面より下に潜らない
// controls.enablePan = false; // 必要ならパン無効（任意）

  new ResizeObserver(()=>{
    const w2 = townEl.clientWidth, h2 = townEl.clientHeight;
    renderer.setSize(w2, h2);
    camera.aspect = w2/h2;
    camera.updateProjectionMatrix();
  }).observe(townEl);
}
ensureRenderer();

// 任意のモデルURL（なくてもOK）
const MODEL_URLS = {
  house:"models/japanese_house.glb",   shop:"models/shop.glb",   castle:"models/castle.glb",
   temple:"models/japanese_torii_gate.glb", tree:"models/anime_nature_tree_01.glb",   field:"models/field.glb",
   water:"models/water.glb",   road:"models/road.glb",   bridge:"models/bridge.glb",
   school:"models/school.glb",
  
};

// ★ 見逃しようがないデカめフォールバック
function fallbackMesh(type, big=false){
  const s = big ? 1.6 : 0.9;
  const g = new THREE.BoxGeometry(s, s, s);
  const m = new THREE.MeshStandardMaterial({ color: 0x2ecc71, emissive: 0x0, metalness:0.1, roughness:0.8 });
  const mesh = new THREE.Mesh(g, m);
  mesh.position.y = s/2;
  return mesh;
}

// ★place3D 
async function place3D({id, type, x, y, rot=0}){
  const pos = gridToWorld(x, y);
  let obj; const url = MODEL_URLS[type];
  if(url){
    try { const gltf = await loader.loadAsync(url); obj = gltf.scene; obj.scale.set(0.8,0.8,0.8); }
    catch { obj = fallbackMesh(type); }
  }else{
    obj = fallbackMesh(type);
  }
  obj.position.copy(pos);
  obj.rotation.y = (rot/90) * Math.PI/2;

  // ▼ここが重要：必ず底面を地面にスナップ
  snapBaseY(obj, 0);

  obj.userData.id = id || null;
  obj.userData.rot = rot || 0;
  scene.add(obj);
  placed3D.push(obj);
}


function clear3D(){ placed3D.forEach(o=>scene.remove(o)); placed3D = []; }

// ========= 配置モード =========
let placing=false, preview=null, placeType=null, placeRot=0;
let occSet = new Set();
const raycaster=new THREE.Raycaster(), pointer=new THREE.Vector2();
let hoverCell = {x:-1,y:-1};
const okMat=new THREE.MeshBasicMaterial({ color:0x2e7d32, transparent:true, opacity:0.5 });
const ngMat=new THREE.MeshBasicMaterial({ color:0xc62828, transparent:true, opacity:0.5 });

function setPointerFromEvent(ev){
  const rect = renderer.domElement.getBoundingClientRect();
  const cx = ((ev.clientX ?? (ev.touches?.[0]?.clientX || 0)) - rect.left) / rect.width;
  const cy = ((ev.clientY ?? (ev.touches?.[0]?.clientY || 0)) - rect.top) / rect.height;
  pointer.x = cx * 2 - 1; pointer.y = -(cy * 2 - 1);
}
function pickOnGround(ev){
  setPointerFromEvent(ev);
  raycaster.setFromCamera(pointer, camera);
  const hit = raycaster.intersectObject(ground, false)[0];
  if(!hit) return null;
  return { cell: worldToGrid(hit.point.x, hit.point.z) };
}
function cellValid(x,y){ return (x>=0 && y>=0 && x<COLS && y<ROWS) && !occSet.has(`${x},${y}`); }

function applyTint(obj,mat){
  obj.traverse?.(n=>{
    if(n.isMesh){
      if(!n.userData._origMat) n.userData._origMat = n.material;
      n.material = mat;
    }
  });
}
function restoreTint(obj){
  obj.traverse?.(n=>{
    if(n.isMesh && n.userData._origMat){ n.material = n.userData._origMat; delete n.userData._origMat; }
  });
}

// ★ 3) 修正：ensurePreview 内（プレビューも沈まないように）
async function ensurePreview(){
  if (preview) return preview;
  preview = fallbackMesh(placeType, true);
  scene.add(preview);
  snapBaseY(preview, 0); // まずはフォールバックを地面に載せる

  const url = MODEL_URLS[placeType];
  if (url) {
    try{
      const gltf = await loader.loadAsync(url);
      const real = gltf.scene;
      real.scale.set(0.8,0.8,0.8);
      real.position.copy(preview.position);
      real.rotation.copy(preview.rotation);
      scene.add(real);
      scene.remove(preview);
      preview = real;

      snapBaseY(preview, 0); // 本物に差し替え後も必ずスナップ
    }catch(e){}
  }
  return preview;
}

function setPreviewAtCell(cell){
  hoverCell = cell;
  const pos = gridToWorld(cell.x, cell.y);
  preview.position.copy(pos);
  preview.rotation.y = (placeRot/90) * Math.PI/2;
  const valid = cellValid(cell.x, cell.y);
  restoreTint(preview);
  applyTint(preview, valid ? okMat : ngMat);
}

function endPlacement(){
  placing=false; placeType=null; placeRot=0; occSet.clear();
  if(preview){ scene.remove(preview); preview=null; }
  renderer.domElement.style.cursor="default";
  controls.enabled = true;
}

// ========= Main ↔ Three.js 連携 =========
document.addEventListener("city:add",   (ev)=>{ place3D(ev.detail); });
document.addEventListener("city:reset", ()=>{ clear3D(); });


  // スティック操作：1ステップ移動
document.addEventListener("placement:nudge", (ev)=>{
  if(!placing || !hoverCell) return;
  const {dx=0, dy=0} = ev.detail || {};
  const nx = clamp(hoverCell.x + dx, 0, COLS-1);
  const ny = clamp(hoverCell.y + dy, 0, ROWS-1);
  setPreviewAtCell({x:nx, y:ny});
});
// 決定ボタン → 座標が有効なら確定
document.addEventListener("placement:ok", ()=>{
  if(!placing || !hoverCell) return;
  const {x,y} = hoverCell;
  if(!cellValid(x,y)) return; // NGの色のときは置かない
  document.dispatchEvent(new CustomEvent("placement:confirm", {
    detail: { type: placeType, x, y, rot: placeRot }
  }));
  endPlacement();
});


// 配置開始
document.addEventListener("placement:start", async (ev)=>{
  const { type, cols, rows, occupied=[] } = ev.detail || {};
  COLS = cols ?? COLS; ROWS = rows ?? ROWS;

  placing = true; placeType = type; placeRot = 0;
  occSet = new Set(occupied.map(([x,y]) => `${x},${y}`));

  controls.enabled = false;
  renderer.domElement.style.cursor = "crosshair";

  await ensurePreview();

  // 中央 or 近傍の空きマスを必ず見つける
  const center = { x: Math.floor(COLS/2), y: Math.floor(ROWS/2) };
  const isFree = (c)=> c.x>=0 && c.y>=0 && c.x<COLS && c.y<ROWS && !occSet.has(`${c.x},${c.y}`);
  let init = center;
  if (!isFree(init)) {
    outer: for (let r=1; r<Math.max(COLS,ROWS); r++){
      for (let dx=-r; dx<=r; dx++){
        for (let dy=-r; dy<=r; dy++){
          const c = { x: center.x+dx, y: center.y+dy };
          if (isFree(c)){ init=c; break outer; }
        }
      }
    }
  }
  setPreviewAtCell(init);

  // ★ カメラをプレビューに寄せる（ここがキモ）
  const t = gridToWorld(init.x, init.y);
  controls.target.copy(t);
  camera.position.set(t.x + 15, 18, t.z + 22);
  controls.update();
});

// 配置終了/キャンセル/回転
document.addEventListener("placement:end",   ()=> endPlacement());
document.addEventListener("placement:cancel",()=> endPlacement());
document.addEventListener("placement:rotate",()=>{ if(!placing) return; placeRot=(placeRot+90)%360; if(preview && hoverCell){ setPreviewAtCell(hoverCell); } });

// 入力
renderer.domElement.addEventListener("pointermove", (ev)=>{
  if(!placing) return;
  const r = pickOnGround(ev); if(!r) return;
  setPreviewAtCell(r.cell);
}, { passive:true });

function tryPlace(ev){
  if(!placing) return;
  const r = pickOnGround(ev); if(!r) return;
  const {x,y}=r.cell;
  if(!cellValid(x,y)) return;
  document.dispatchEvent(new CustomEvent("placement:confirm",{ detail:{ type:placeType, x, y, rot:placeRot }}));
  endPlacement();
}
renderer.domElement.addEventListener("pointerdown", (ev)=>{
  if(placing && ev.button===2){ ev.preventDefault(); document.dispatchEvent(new Event("placement:cancel")); endPlacement(); }
});
renderer.domElement.addEventListener("click", tryPlace, { passive:false });
renderer.domElement.addEventListener("touchstart", (e)=>{ tryPlace(e); }, { passive:false });
renderer.domElement.addEventListener("contextmenu", (e)=>{ if(placing){ e.preventDefault(); } });

// 設置後の回転（ダブルクリック/ダブルタップ）
let lastTap=0; const dblTapGap=300;
renderer.domElement.addEventListener("pointerdown", (ev)=>{
  if(placing) return;
  const now=performance.now(); const isDouble=(now-lastTap)<dblTapGap; lastTap=now;
  if(!isDouble) return;

  const ray=new THREE.Raycaster();
  const rect = renderer.domElement.getBoundingClientRect();
  const cx = ((ev.clientX ?? (ev.touches?.[0]?.clientX || 0)) - rect.left) / rect.width;
  const cy = ((ev.clientY ?? (ev.touches?.[0]?.clientY || 0)) - rect.top) / rect.height;
  const p = new THREE.Vector2(cx*2-1, -(cy*2-1));
  ray.setFromCamera(p, camera);

  const hits = ray.intersectObjects(placed3D, true); if(!hits.length) return;
  let hit = hits[0].object; while(hit && !placed3D.includes(hit)) hit = hit.parent; if(!hit) return;

  const cur = (hit.userData.rot || 0); const next=(cur+90)%360;
  hit.userData.rot = next; hit.rotation.y = (next/90) * Math.PI/2;
  if(hit.userData.id){ document.dispatchEvent(new CustomEvent("edit:rotate",{ detail:{ id: hit.userData.id, rot: next }})); }
});
</script>

</body>
</html>








