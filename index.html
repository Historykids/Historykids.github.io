<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>æ±Ÿæˆ¸ã‚«ãƒ¼ãƒ‰ã§ç”ºã¥ãã‚Šï¼ï¼ˆå¹´è¡¨æ‹¡å¼µï¼‹ã‚¯ã‚¤ã‚ºï¼‹ãµã‚ŠãŒãªï¼æ‰‹å‹•ã€‡æ•°ï¼‹ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰</title>

<!-- AdSenseï¼ˆè‡ªå‹•åºƒå‘Šï¼‰ -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4922140858632050" crossorigin="anonymous"></script>

<style>
  :root{
    --edo-yellow:#FCD34D; --edo-info:#FFF8DC; --edo-border:#999; /* OK */
    --bg:#FFF6E3; --shadow:rgba(0,0,0,.12); --ink:#222; --adbg:#f1f1f1;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
      "Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;}
  .wrap{display:flex;flex-direction:column;min-height:100svh;}
  header{position:sticky;top:0;z-index:3;background:var(--edo-yellow);
    padding:10px 12px;display:flex;gap:8px;align-items:center;justify-content:space-between;
    box-shadow:0 1px 4px var(--shadow);}
  header h1{font-size:18px;margin:0;font-weight:700}
  header .controls{display:flex;gap:8px}
  header button, header select{border:0;border-radius:10px;background:#fff;padding:6px 12px;
    font-weight:700;box-shadow:0 1px 3px var(--shadow);cursor:pointer}
  #resetBtn{background:#ffeaea}
  #info{padding:10px;background:var(--edo-info);border-bottom:1px solid #ccc;
    font-size:15px;min-height:40px}
  #town{position:relative;width:100%;height:44vh;min-height:260px;background:#fff;
    border-top:2px solid var(--edo-border);border-bottom:2px solid var(--edo-border);
    overflow:hidden}
  #cards{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:10px}
  .card{width:28vw;max-width:110px;min-width:86px;height:120px;border-radius:12px;background:#ddd;
    display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;
    cursor:pointer;box-shadow:0 2px 6px var(--shadow);user-select:none;text-align:center;padding:6px}
  .card.done{background:#cdeccd; color:#1a5e1a}
  .building{position:absolute;font-size:34px;opacity:0;transform:scale(.8);
    transition:opacity .7s, transform .7s}
  .show{opacity:1;transform:scale(1.2)}
  .villager{position:absolute;font-size:20px;animation:walk 8s linear infinite}
  @keyframes walk{0%{left:2%}50%{left:90%}100%{left:2%}}
  #zukanPanel{position:fixed;inset:0 0 auto 0;height:72%;top:-100%;background:#fff;
    border-bottom:3px solid #333;box-shadow:0 4px 16px var(--shadow);
    transition:top .45s ease;z-index:5;overflow:auto}
  #zukanPanel.active{top:0}
  #zukanHead{position:sticky;top:0;background:#fff;padding:10px;border-bottom:1px solid #eee;
    display:flex;align-items:center;gap:8px}
  #zukanHead h2{margin:0;font-size:18px}
  #closeZukan{margin-left:auto;border:0;background:#eee;border-radius:8px;padding:6px 12px;cursor:pointer}
  .zukanSec{padding:10px}
  .zukanSec h3{margin:8px 0}
  .zCard{display:inline-flex;align-items:center;justify-content:center;width:96px;height:116px;margin:4px;
    border:1px solid #ccc;border-radius:8px;box-shadow:0 1px 3px var(--shadow);white-space:pre-line;text-align:center;padding:6px}
  .locked{background:#eee;color:#999}
  #completeMsg{font-size:18px;font-weight:800;color:green;text-align:center;padding:10px}
  .petal{position:fixed;top:-10px;font-size:20px;animation:fall linear forwards;pointer-events:none}
  @keyframes fall{to{transform:translateY(110vh) rotate(360deg);opacity:0}}
  .adbar{position:sticky;bottom:0;background:var(--adbg);border-top:1px solid #ddd;
    padding:4px 8px; display:flex; justify-content:center; align-items:center; min-height:52px}
  .adslot{width:100%; max-width:728px; height:50px; background:
    repeating-linear-gradient(45deg,#eee,#eee 8px,#e2e2e2 8px,#e2e2e2 16px);
    border:1px dashed #bbb;border-radius:8px; display:flex; align-items:center; justify-content:center;
    font-size:12px; color:#666}
  footer{height:8px}
  .landscapeWarn{position:fixed;inset:0;background:rgba(0,0,0,.65);color:#fff;display:none;
    align-items:center;justify-content:center;z-index:20;text-align:center;padding:20px}
  @media (orientation:landscape){ .landscapeWarn{display:flex} }
  ruby rt{font-size:.7em;color:#444}
  .yr{font-weight:800;margin-right:2px}

  /* === ã‚¯ã‚¤ã‚ºç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« === */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:30}
  .modal.active{display:flex}
  .modal-bg{position:absolute;inset:0;background:rgba(0,0,0,.5)}
  .modal-box{position:relative;z-index:1;width:min(92vw,560px);background:#fff;border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.2);padding:14px}
  .quiz-title{font-weight:800;font-size:16px;margin:0 0 6px 0}
  .quiz-instruction{font-size:14px;margin:6px 0 10px 0;color:#444}
  #quizInput{width:100%;padding:10px 12px;font-size:16px;border:1px solid #ccc;border-radius:10px}
  .quiz-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .quiz-actions button{border:0;border-radius:10px;padding:8px 14px;background:#eee;cursor:pointer}
  .quiz-actions #quizOk{background:#cdeccd;color:#145f14;font-weight:700}
</style>
</head>
<body>
<div class="wrap" role="application" aria-label="æ±Ÿæˆ¸ã‚«ãƒ¼ãƒ‰ã§ç”ºã¥ãã‚Šï¼ˆæ‰‹å‹•ã€‡æ•°ï¼‹ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰">
  <header>
    <h1>æ±Ÿæˆ¸ã‚«ãƒ¼ãƒ‰ã§ç”ºã¥ãã‚Šï¼</h1>
    <div class="controls">
      <select id="chapterFilter" title="ç« ã‚’ãˆã‚‰ã¶">
        <option value="ALL">ç« ï¼šãœã‚“ã¶</option>
        <option value="åˆæœŸ">ç« ï¼šåˆæœŸï¼ˆ1603ã€œï¼‰</option>
        <option value="ä¸­æœŸ">ç« ï¼šä¸­æœŸ</option>
        <option value="å¹•æœ«">ç« ï¼šå¹•æœ«</option>
      </select>
      <button id="zukanBtn" aria-controls="zukanPanel" aria-expanded="false">å›³é‘‘</button>
      <button id="resetBtn" title="é€²æ—ã‚’å…¨éƒ¨æ¶ˆã—ã¦æœ€åˆã‹ã‚‰">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </header>

  <div id="info">ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã£ã¦æ±Ÿæˆ¸ã®ç”ºã‚’ç™ºå±•ã•ã›ã‚ˆã†ï¼ï¼ˆã‚¯ã‚¤ã‚ºã«ã²ã‚‰ãŒãªã§æ­£è§£ã™ã‚‹ã¨é–‹ãã‚ˆï¼‰</div>
  <div id="town" role="img" aria-label="æ±Ÿæˆ¸ã®ç”ºã‚¨ãƒªã‚¢"></div>
  <div id="cards" aria-label="ã‚«ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢"></div>

  <section id="zukanPanel" aria-hidden="true">
    <div id="zukanHead">
      <h2>æ±Ÿæˆ¸ã‚«ãƒ¼ãƒ‰å›³é‘‘ï¼ˆç« ã”ã¨ï¼‰</h2>
      <button id="closeZukan" aria-label="å›³é‘‘ã‚’ã¨ã˜ã‚‹">ã¨ã˜ã‚‹</button>
    </div>
    <div id="zukanList"></div>
    <div id="completeMsg"></div>
  </section>

  <!-- ä¸‹éƒ¨ã®å›ºå®šãƒãƒŠãƒ¼æ ï¼ˆå¿…è¦ãªã‚‰ä¸­èº«ã‚’ ad ãƒ¦ãƒ‹ãƒƒãƒˆã«å·®ã—æ›¿ãˆï¼‰ -->
  <div class="adbar" aria-label="åºƒå‘Šæ ">
    <div class="adslot">åºƒå‘Šã‚¹ãƒšãƒ¼ã‚¹ï¼ˆ<ins class="adsbygoogle">â€¦</ins> ã‚’å…¥ã‚Œã‚‹å ´æ‰€ï¼‰</div>
  </div>
  <footer aria-hidden="true"></footer>
</div>

<div class="landscapeWarn">ç¸¦å‘ãã§éŠã‚“ã§ã­ğŸ”„</div>

<!-- ã‚¯ã‚¤ã‚ºç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ¼¢å­—ã«ãµã‚ŠãŒãªè¡¨ç¤ºï¼ã€‡ã¯æ‰‹å‹•è¨­å®šã®ã¾ã¾ï¼‰ -->
<div id="quizModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-bg" id="quizBg"></div>
  <div class="modal-box">
    <div id="quizTitle" class="quiz-title"></div>
    <p class="quiz-instruction">
      ã€‡ã®ã¨ã“ã‚ã ã‘ã‚’ <b>ã²ã‚‰ãŒãª</b> ã§ã“ãŸãˆã¦ã­ã€‚<br>
      ç©ºæ¬„ãŒã„ãã¤ã‹ã‚ã‚‹ã¨ãã¯ <b>ã‚¹ãƒšãƒ¼ã‚¹ / ãƒ» / ã€ / ï¼</b> ã§åŒºåˆ‡ã£ã¦OKã€‚
      <span id="quizHint" style="color:#666"></span>
    </p>
    <input id="quizInput" type="text" inputmode="kana" autocomplete="off"
           placeholder="ã“ã“ã« ã²ã‚‰ãŒãª ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šã°ã‚‰ ãã•ï¼‰" />
    <div class="quiz-actions">
      <button id="quizCancel">ã‚„ã‚ã‚‹</button>
      <button id="quizOk">æ±ºå®š</button>
    </div>
  </div>
</div>

<script>
  // ===== ãƒ‡ãƒ¼ã‚¿ï¼ˆã€‡ã®æ•°ã¯æ‰‹å‹•ã§æ•´ãˆæ¸ˆã¿ï¼šä¾‹ å¤©ä¿â†’ã¦ã‚“ã½â†’ã€Œã€‡ã€‡ã€‡ã®æ”¹é©ã€ï¼‰ =====
  const chapters = {
    "åˆæœŸ": {
      "1603 ã€‡ã€‡å¹•åºœãŒã¯ã˜ã¾ã‚‹": { text: "å®¶åº·ãŒå°†è»ã«ãªã‚Šã€æ±Ÿæˆ¸ã§å›½ã®ä¸­å¿ƒãŒå‹•ãå‡ºã™ã€‚", icon: "ğŸ¯", year: 1603 },
      "1615 ã€‡ã€‡ã€‡ã€‡ã®é™£": { text: "å¤§ããªãŸãŸã‹ã„ãŒçµ‚ã‚ã‚Šã€è±Šè‡£ã®æ™‚ä»£ã«å¹•ã€‚", icon: "âš”ï¸", year: 1615 },
      "1635 ã€‡ã€‡ã€‡ã€‡äº¤ä»£": { text: "å¤§åã¯å›½ã¨æ±Ÿæˆ¸ã‚’è¡Œãæ¥ã™ã‚‹ãã¾ã‚Šã«ã€‚", icon: "ğŸš¶", year: 1635 },
      "1637 å³¶ã€‡ã€‡ãƒ»å¤©ã€‡ã€‡ã®ä¹±": { text: "ä¹å·ã§å¤§ããªä¸€æ†ãŒèµ·ãã‚‹ã€‚", icon: "ğŸ”¥", year: 1637 },
      "1639 ã€‡ã€‡ã€‡ã€‡ã€‡èˆ¹ã®æ¥èˆªç¦æ­¢": { text: "å¤–å›½èˆ¹ã®å‡ºå…¥ã‚Šã‚’ã—ã‚ã¦ã€äº¤æµã‚’ã›ã„ã’ã‚“ã€‚", icon: "â›µ", year: 1639 },
      "1641 ã€‡ã€‡ã€‡ã§ã®è²¿æ˜“": { text: "ã‚ªãƒ©ãƒ³ãƒ€å•†é¤¨ãŒé•·å´ã®å‡ºå³¶ã¸ã€‚", icon: "ğŸï¸", year: 1641 },
      "1657 ã€‡ã€‡ã€‡ã€‡ã®å¤§ç«": { text: "æ±Ÿæˆ¸ã®ç”ºãŒå¤§ç«äº‹ã€‚ç”ºã¥ãã‚Šã‚’ç«‹ã¦ç›´ã™ã€‚", icon: "ğŸ”¥", year: 1657 },
      "1657 ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã¸ç§»è»¢": { text: "éŠéƒ­ãŒæµ…è‰åƒæŸã®æ–°ã—ã„å ´æ‰€ã¸ã€‚", icon: "ğŸ®", year: 1657 }
    },
    "ä¸­æœŸ": {
      "1688 ã€‡ã€‡ã€‡ã€‡æ–‡åŒ–ãŒã•ã‹ãˆã‚‹": { text: "ç”ºäººã®æ–‡åŒ–ãŒèŠ±ã²ã‚‰ãã€‚æ­Œèˆä¼ã‚„æµ®ä¸–çµµãŒäººæ°—ã€‚", icon: "ğŸ­", year: 1688 },
      "1716 ã€‡ã€‡ã€‡ã€‡ã®æ”¹é©": { text: "å‰å®—ãŒãã‚‰ã—ã¨è²¡æ”¿ã‚’ç«‹ã¦ç›´ã™å·¥å¤«ã‚’ã¯ã˜ã‚ã‚‹ã€‚", icon: "ğŸ“œ", year: 1716 },
      "1720 ã€‡ã€‡ã€‡ã€‡ã‚’ã¨ã‚Šã„ã‚Œã‚‹": { text: "æµ·å¤–ã®å­¦ã³ãŒåºƒãŒã‚Šã€çŸ¥è­˜ãŒãµãˆã‚‹ã€‚", icon: "ğŸ“š", year: 1720 },
      "1720 ã€‡ã€‡ã€‡ã€‡ã€‡ã®ã—ãã¿": { text: "ç«äº‹ã«ããªãˆã‚‹ç”ºäººã®çµ„ãŒã§ãã‚‹ã€‚", icon: "ğŸš’", year: 1720 },
      "1730 ã€‡ã€‡ã®ãªãŒã‚Œã‚’æ•´ãˆã‚‹": { text: "å•†ã„ã®ãã¾ã‚Šã‚’ã¨ã¨ã®ãˆã€ç”ºã‚’å…ƒæ°—ã«ã€‚", icon: "ğŸ§º", year: 1730 },
      "1775 ã€‡ã€‡ã€‡ã®æ™‚ä»£": { text: "å•†ã„ã‚’æ´»ã‹ã™æ”¿æ²»ã§ãŠé‡‘ã®æµã‚Œã‚’ã‚ˆãã™ã‚‹è©¦ã¿ã€‚", icon: "ğŸ’¹", year: 1775 },
      "1783 ã€‡ã€‡ã€‡ã€‡ã®ããã‚“": { text: "å¯’ã•ã‚„ä¸ä½œã§é£Ÿã¹ç‰©ãŒãŸã‚Šãªããªã‚‹ã€‚", icon: "ğŸŒ¾", year: 1783 }
    },
    "å¹•æœ«": {
      "1787 ã€‡ã€‡ã€‡ã€‡ã®æ”¹é©": { text: "ãã‚‰ã—ã‚’ã²ãã—ã‚ã€æ•™è‚²ã‚‚å¤§åˆ‡ã«ã™ã‚‹æ–¹é‡ã€‚", icon: "ğŸ“", year: 1787 },
      "1825 ã€‡ã€‡ã€‡ã€‡ã€‡æ‰“æ‰•ä»¤": { text: "è¿‘ã¥ãå¤–å›½èˆ¹ã‚’è¿½ã„ã¯ã‚‰ã†ãã¾ã‚Šã€‚", icon: "ğŸ“£", year: 1825 },
      "1837 ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã®ä¹±": { text: "å¤§é˜ªã§äººã³ã¨ã®è‹¦ã—ã•ãŒçˆ†ç™ºã€‚", icon: "âš ï¸", year: 1837 },
      "1841 ã€‡ã€‡ã€‡ã®æ”¹é©": { text: "ç”ºã®æ±ºã¾ã‚Šã‚’è¦‹ç›´ã—ã€ãœã„ãŸãã‚’ãŠã•ãˆã‚‹ã€‚", icon: "ğŸ“", year: 1841 },
      "1853 ã€‡ã€‡ã€‡ã€‡ãŒæ¥ã‚‹": { text: "ã‚¢ãƒ¡ãƒªã‚«ã®èˆ¹ãŒæµ¦è³€ã«æ¥èˆªã€‚", icon: "â›´ï¸", year: 1853 },
      "1854 ã€‡ã€‡ã€‡æ¡ç´„": { text: "æ—¥æœ¬ã¯æ¸¯ã‚’é–‹ãã€äº¤æµã‚’ã¯ã˜ã‚ã‚‹ã€‚", icon: "ğŸ¤", year: 1854 },
      "1858 ã€‡ã€‡ã€‡ã€‡ã®æ¡ç´„": { text: "ã„ãã¤ã‹ã®å›½ã¨ã‚€ã™ã³ã€è²¿æ˜“ãŒåºƒãŒã‚‹ã€‚", icon: "ğŸŒ", year: 1858 },
      "1858 ã€‡ã€‡ã€‡ã€‡ã®å¤§ç„": { text: "æ„è¦‹ã®ã¡ãŒã„ã§å¤šãã®äººãŒå‡¦ç½°ã•ã‚Œã‚‹ã€‚", icon: "âš–ï¸", year: 1858 },
      "1860 ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã®å¤‰": { text: "æ”¿æ²»ã®å¯¾ç«‹ãŒäº‹ä»¶ã«ã€‚", icon: "ğŸ—¡ï¸", year: 1860 },
      "1867 ã€‡ã€‡ã€‡ã€‡å¥‰é‚„": { text: "æ”¿ï¼ˆã¾ã¤ã‚Šã”ã¨ï¼‰ã‚’æœå»·ã«ãŠè¿”ã—ã€‚", icon: "ğŸ—ï¸", year: 1867 },
      "1868 ã€‡ã€‡ã€‡ã¸": { text: "æ–°ã—ã„æ™‚ä»£ã®ã‚¹ã‚¿ãƒ¼ãƒˆï¼", icon: "ğŸŒ¸", year: 1868 }
    }
  };

  // ===== ãµã‚ŠãŒãªè¡¨ç¤ºï¼ˆè¦‹ãˆã¦ã„ã‚‹æ¼¢å­—ã ã‘ã« rubyã€‚ã€‡ã¯æ‰‹å‹•è¨­å®šã®ã¾ã¾ï¼‰ =====
  const rubyMasked = {
    "1603 ã€‡ã€‡å¹•åºœãŒã¯ã˜ã¾ã‚‹": "ã€‡ã€‡<ruby>å¹•åºœ<rt>ã°ããµ</rt></ruby>ãŒã¯ã˜ã¾ã‚‹",
    "1615 ã€‡ã€‡ã€‡ã€‡ã®é™£": "ã€‡ã€‡ã€‡ã€‡ã®<ruby>é™£<rt>ã˜ã‚“</rt></ruby>",
    "1635 ã€‡ã€‡ã€‡ã€‡äº¤ä»£": "ã€‡ã€‡ã€‡ã€‡<ruby>äº¤ä»£<rt>ã“ã†ãŸã„</rt></ruby>",
    "1637 å³¶ã€‡ã€‡ãƒ»å¤©ã€‡ã€‡ã®ä¹±": "å³¶ã€‡ã€‡ãƒ»å¤©ã€‡ã€‡ã®<ruby>ä¹±<rt>ã‚‰ã‚“</rt></ruby>",
    "1639 ã€‡ã€‡ã€‡ã€‡ã€‡èˆ¹ã®æ¥èˆªç¦æ­¢": "ã€‡ã€‡ã€‡ã€‡ã€‡<ruby>èˆ¹<rt>ã›ã‚“</rt></ruby>ã®<ruby>æ¥èˆª<rt>ã‚‰ã„ã“ã†</rt></ruby><ruby>ç¦æ­¢<rt>ãã‚“ã—</rt></ruby>",
    "1641 ã€‡ã€‡ã€‡ã§ã®è²¿æ˜“": "ã€‡ã€‡ã€‡ã§ã®<ruby>è²¿æ˜“<rt>ã¼ã†ãˆã</rt></ruby>",
    "1657 ã€‡ã€‡ã€‡ã€‡ã®å¤§ç«": "ã€‡ã€‡ã€‡ã€‡ã®<ruby>å¤§ç«<rt>ãŸã„ã‹</rt></ruby>",
    "1657 ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã¸ç§»è»¢": "ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã¸<ruby>ç§»è»¢<rt>ã„ã¦ã‚“</rt></ruby>",
    "1688 ã€‡ã€‡ã€‡ã€‡æ–‡åŒ–ãŒã•ã‹ãˆã‚‹": "ã€‡ã€‡ã€‡ã€‡<ruby>æ–‡åŒ–<rt>ã¶ã‚“ã‹</rt></ruby>ãŒã•ã‹ãˆã‚‹",
    "1716 ã€‡ã€‡ã€‡ã€‡ã®æ”¹é©": "ã€‡ã€‡ã€‡ã€‡ã®<ruby>æ”¹é©<rt>ã‹ã„ã‹ã</rt></ruby>",
    "1720 ã€‡ã€‡ã€‡ã€‡ã‚’ã¨ã‚Šã„ã‚Œã‚‹": "ã€‡ã€‡ã€‡ã€‡ã‚’ã¨ã‚Šã„ã‚Œã‚‹",
    "1720 ã€‡ã€‡ã€‡ã€‡ã€‡ã®ã—ãã¿": "ã€‡ã€‡ã€‡ã€‡ã€‡ã®ã—ãã¿",
    "1730 ã€‡ã€‡ã®ãªãŒã‚Œã‚’æ•´ãˆã‚‹": "ã€‡ã€‡ã®ãªãŒã‚Œã‚’<ruby>æ•´ãˆã‚‹<rt>ã¨ã¨ã®ãˆã‚‹</rt></ruby>",
    "1775 ã€‡ã€‡ã€‡ã®æ™‚ä»£": "ã€‡ã€‡ã€‡ã®<ruby>æ™‚ä»£<rt>ã˜ã ã„</rt></ruby>",
    "1783 ã€‡ã€‡ã€‡ã€‡ã®ããã‚“": "ã€‡ã€‡ã€‡ã€‡ã®ããã‚“",
    "1787 ã€‡ã€‡ã€‡ã€‡ã®æ”¹é©": "ã€‡ã€‡ã€‡ã€‡ã®<ruby>æ”¹é©<rt>ã‹ã„ã‹ã</rt></ruby>",
    "1825 ã€‡ã€‡ã€‡ã€‡ã€‡æ‰“æ‰•ä»¤": "ã€‡ã€‡ã€‡ã€‡ã€‡<ruby>æ‰“æ‰•ä»¤<rt>ã†ã¡ã¯ã‚‰ã„ã‚Œã„</rt></ruby>",
    "1837 ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã®ä¹±": "ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã®<ruby>ä¹±<rt>ã‚‰ã‚“</rt></ruby>",
    "1841 ã€‡ã€‡ã€‡ã®æ”¹é©": "ã€‡ã€‡ã€‡ã®<ruby>æ”¹é©<rt>ã‹ã„ã‹ã</rt></ruby>",
    "1853 ã€‡ã€‡ã€‡ã€‡ãŒæ¥ã‚‹": "ã€‡ã€‡ã€‡ã€‡ãŒ<ruby>æ¥ã‚‹<rt>ãã‚‹</rt></ruby>",
    "1854 ã€‡ã€‡ã€‡æ¡ç´„": "ã€‡ã€‡ã€‡<ruby>æ¡ç´„<rt>ã˜ã‚‡ã†ã‚„ã</rt></ruby>",
    "1858 ã€‡ã€‡ã€‡ã€‡ã®æ¡ç´„": "ã€‡ã€‡ã€‡ã€‡ã®<ruby>æ¡ç´„<rt>ã˜ã‚‡ã†ã‚„ã</rt></ruby>",
    "1858 ã€‡ã€‡ã€‡ã€‡ã®å¤§ç„": "ã€‡ã€‡ã€‡ã€‡ã®<ruby>å¤§ç„<rt>ãŸã„ã”ã</rt></ruby>",
    "1860 ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã®å¤‰": "ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã®<ruby>å¤‰<rt>ã¸ã‚“</rt></ruby>",
    "1867 ã€‡ã€‡ã€‡ã€‡å¥‰é‚„": "ã€‡ã€‡ã€‡ã€‡<ruby>å¥‰é‚„<rt>ã»ã†ã‹ã‚“</rt></ruby>",
    "1868 ã€‡ã€‡ã€‡ã¸": "ã€‡ã€‡ã€‡ã¸"
  };

  // ===== ã€‡ã®æ­£è§£ï¼ˆã²ã‚‰ãŒãªï¼‰â€” ã€‡ã®æ•°ã¯ä¸Šã®ã‚­ãƒ¼ã¨å¯¾å¿œï¼ˆå¤©ä¿â†’ã¦ã‚“ã½=3ã€äº«ä¿â†’ãã‚‡ã†ã»=4ï¼‰ =====
  const blanksMap = {
    "1603 ã€‡ã€‡å¹•åºœãŒã¯ã˜ã¾ã‚‹": ["ãˆã©"],
    "1615 ã€‡ã€‡ã€‡ã€‡ã®é™£": ["ãŠãŠã•ã‹"],
    "1635 ã€‡ã€‡ã€‡ã€‡äº¤ä»£": ["ã•ã‚“ãã‚“"],
    "1637 å³¶ã€‡ã€‡ãƒ»å¤©ã€‡ã€‡ã®ä¹±": ["ã°ã‚‰","ãã•"],
    "1639 ã€‡ã€‡ã€‡ã€‡ã€‡èˆ¹ã®æ¥èˆªç¦æ­¢": ["ã½ã‚‹ã¨ãŒã‚‹"],
    "1641 ã€‡ã€‡ã€‡ã§ã®è²¿æ˜“": ["ã§ã˜ã¾"],
    "1657 ã€‡ã€‡ã€‡ã€‡ã®å¤§ç«": ["ã‚ã„ã‚Œã"],
    "1657 ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã¸ç§»è»¢": ["ã—ã‚“ã‚ˆã—ã‚ã‚‰"],
    "1688 ã€‡ã€‡ã€‡ã€‡æ–‡åŒ–ãŒã•ã‹ãˆã‚‹": ["ã’ã‚“ã‚ã"],
    "1716 ã€‡ã€‡ã€‡ã€‡ã®æ”¹é©": ["ãã‚‡ã†ã»"],   // äº«ä¿
    "1720 ã€‡ã€‡ã€‡ã€‡ã‚’ã¨ã‚Šã„ã‚Œã‚‹": ["ã‚ˆã†ã—ã‚‡"],
    "1720 ã€‡ã€‡ã€‡ã€‡ã€‡ã®ã—ãã¿": ["ã¾ã¡ã³ã‘ã—"],
    "1730 ã€‡ã€‡ã®ãªãŒã‚Œã‚’æ•´ãˆã‚‹": ["ã‚‚ã®"],
    "1775 ã€‡ã€‡ã€‡ã®æ™‚ä»£": ["ãŸã¬ã¾"],
    "1783 ã€‡ã€‡ã€‡ã€‡ã®ããã‚“": ["ã¦ã‚“ã‚ã„"],
    "1787 ã€‡ã€‡ã€‡ã€‡ã®æ”¹é©": ["ã‹ã‚“ã›ã„"],
    "1825 ã€‡ã€‡ã€‡ã€‡ã€‡æ‰“æ‰•ä»¤": ["ã„ã“ãã›ã‚“"],
    "1837 ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã®ä¹±": ["ãŠãŠã—ãŠã¸ã„ã¯ã¡ã‚ã†"],
    "1841 ã€‡ã€‡ã€‡ã®æ”¹é©": ["ã¦ã‚“ã½"],       // å¤©ä¿
    "1853 ã€‡ã€‡ã€‡ã€‡ãŒæ¥ã‚‹": ["ãã‚ãµã­"],
    "1854 ã€‡ã€‡ã€‡æ¡ç´„": ["ã‚ã—ã‚“"],
    "1858 ã€‡ã€‡ã€‡ã€‡ã®æ¡ç´„": ["ã‚ã‚“ã›ã„"],
    "1858 ã€‡ã€‡ã€‡ã€‡ã®å¤§ç„": ["ã‚ã‚“ã›ã„"],
    "1860 ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã®å¤‰": ["ã•ãã‚‰ã ã‚‚ã‚“ãŒã„"],
    "1867 ã€‡ã€‡ã€‡ã€‡å¥‰é‚„": ["ãŸã„ã›ã„"],
    "1868 ã€‡ã€‡ã€‡ã¸": ["ã‚ã„ã˜"]
  };

  function withRubyMasked(fullName){
    const sp = fullName.indexOf(" ");
    const year = fullName.slice(0, sp);
    const body = rubyMasked[fullName] || fullName.slice(sp+1);
    return `<span class="yr">${year}</span> ${body}`;
  }

  const infoBox = document.getElementById("info");
  const town = document.getElementById("town");
  const zukanPanel = document.getElementById("zukanPanel");
  const zukanList = document.getElementById("zukanList");
  const completeMsg = document.getElementById("completeMsg");
  const zukanBtn = document.getElementById("zukanBtn");
  const closeZukan = document.getElementById("closeZukan");
  const chapterFilter = document.getElementById("chapterFilter");
  const resetBtn = document.getElementById("resetBtn");

  // ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ 
  const quizModal  = document.getElementById("quizModal");
  const quizTitle  = document.getElementById("quizTitle");
  const quizHint   = document.getElementById("quizHint");
  const quizInput  = document.getElementById("quizInput");
  const quizOk     = document.getElementById("quizOk");
  const quizCancel = document.getElementById("quizCancel");
  const quizBg     = document.getElementById("quizBg");

  const LS_KEY = "edoTown_cards_quiz_furigana_masked_manualO_v1";
  const gotCards = {};
  try { Object.assign(gotCards, JSON.parse(localStorage.getItem(LS_KEY) || "{}")); } catch(e){}

  // ===== ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ =====
  function buildCards(){
    const wrap = document.getElementById("cards");
    wrap.innerHTML = "";
    const sel = chapterFilter.value;
    Object.keys(chapters).forEach(ch=>{
      if(sel!=="ALL" && sel!==ch) return;
      for(const name in chapters[ch]){
        const el = document.createElement("div");
        el.className = "card";
        el.dataset.card = name;
        if(gotCards[name]) { el.innerHTML = withRubyMasked(name); el.classList.add("done"); }
        else { el.textContent = "ï¼Ÿ\n"+name.split(" ")[0]; }
        el.addEventListener("click", ()=>onCardClick(el, name, ch));
        wrap.appendChild(el);
      }
    });
  }

  function persist(){ try { localStorage.setItem(LS_KEY, JSON.stringify(gotCards)); } catch(e){} }

  // ã²ã‚‰ãŒãª & åŒºåˆ‡ã‚Šï¼ˆã‚¹ãƒšãƒ¼ã‚¹/ãƒ»/ã€,/ï¼ï¼‰ã ã‘è¨±å¯
  function onlyHiraAndSep(s){
    return /^[\u3041-\u3096\sãƒ»,ï¼Œã€/ï¼]+$/.test(s);
  }
  function splitTokens(ans){
    let s = ans.replace(/[ãƒ»,ï¼Œã€/ï¼]+/g, ' ');
    s = s.replace(/\s+/g, ' ').trim();
    return s ? s.split(' ') : [];
  }

  // ===== ã‚¯ã‚¤ã‚ºï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ =====
  let quizCtx = { card:null, name:"", ch:"", expected:[] };

  function openQuiz(card, name, ch){
    const expected = blanksMap[name];
    if(!expected){ alert("ã“ã®ã‚«ãƒ¼ãƒ‰ã®ç©ºæ¬„ç­”ãˆãŒæœªç™»éŒ²ã§ã™"); return; }
    quizCtx = { card, name, ch, expected };

    // ã‚¿ã‚¤ãƒˆãƒ«ã¯ãµã‚ŠãŒãªä»˜ãï¼‹æ‰‹å‹•ã€‡æ•°ã®ã¾ã¾
    quizTitle.innerHTML = withRubyMasked(name);
    quizHint.textContent = expected.length >= 2
      ? `ç©ºæ¬„ã¯ ${expected.length} ã“ã€‚é †ç•ªã«å…¥åŠ›ã—ã¦ã­ï¼ˆä¾‹ï¼šã°ã‚‰ ãã•ï¼‰`
      : `ç©ºæ¬„ã¯ 1 ã“ã€‚ä¾‹ï¼šãˆã©`;

    quizModal.classList.add("active");
    quizModal.setAttribute("aria-hidden","false");
    quizInput.value = "";
    setTimeout(()=>quizInput.focus(), 50);
  }
  function closeQuiz(){
    quizModal.classList.remove("active");
    quizModal.setAttribute("aria-hidden","true");
  }

  function submitQuiz(){
    const { card, name, ch, expected } = quizCtx;
    if(!card) return;
    const raw = quizInput.value.trim();
    if(!onlyHiraAndSep(raw)){
      alert("ã²ã‚‰ãŒãª ã ã‘ã§å…¥åŠ›ã—ã¦ã­ï¼ˆåŒºåˆ‡ã‚Šã¯ ã‚¹ãƒšãƒ¼ã‚¹/ãƒ»/ã€/ï¼Œ/ï¼ ã ã‘OKï¼‰");
      quizInput.focus(); return;
    }
    const tokens = splitTokens(raw);
    const joined = tokens.join("");
    const expectJoined = expected.join("");

    let ok = false;
    if(tokens.length === expected.length){
      ok = tokens.every((t,i)=>t === expected[i]);
    }else if(tokens.length === 1){
      ok = joined === expectJoined; // ã¾ã¨ã‚å…¥åŠ›OK
    }

    if(!ok){
      const right = expected.join(" ãƒ» ");
      alert(`ã–ã‚“ã­ã‚“ï¼ã›ã„ã‹ã„ã¯ã€Œ${right}ã€ã ã‚ˆï¼ˆã€‡ã®éƒ¨åˆ†ã ã‘ï¼‰`);
      quizInput.focus();
      return;
    }

    // æ­£è§£å‡¦ç†
    closeQuiz();
    const data = chapters[ch][name];
    card.innerHTML = withRubyMasked(name);
    card.classList.add("done");
    infoBox.textContent = data.text;

    const b = document.createElement("div");
    b.className = "building";
    b.textContent = data.icon;
    b.style.left = (Math.random()*80 + 5) + "%";
    b.style.top  = (Math.random()*70 + 5) + "%";
    town.appendChild(b);
    setTimeout(()=>b.classList.add("show"),50);

    const v = document.createElement("div");
    v.className = "villager";
    v.textContent = Math.random()>0.5 ? "ğŸ˜Š" : "ğŸ‘˜";
    v.style.top = Math.floor(Math.random()*(town.clientHeight-40)) + "px";
    town.appendChild(v);

    gotCards[name] = true;
    persist();
    renderZukan();
  }

  function onCardClick(card, name, ch){
    if(card.classList.contains("done")) return;
    openQuiz(card, name, ch);
  }

  // ===== å›³é‘‘ =====
  function renderZukan(){
    zukanList.innerHTML = "";
    let allComplete = true;
    for(const ch in chapters){
      const section = document.createElement("div");
      section.className = "zukanSec";
      section.innerHTML = `<h3>${ch}</h3>`;
      for(const name in chapters[ch]){
        const div = document.createElement("div");
        div.className = "zCard";
        if(gotCards[name]){
          div.innerHTML = withRubyMasked(name);
        }else{
          div.textContent = "ï¼Ÿï¼Ÿï¼Ÿ";
          div.classList.add("locked");
          allComplete = false;
        }
        section.appendChild(div);
      }
      zukanList.appendChild(section);
    }
    if(allComplete){
      completeMsg.textContent = "ğŸ‰ æ±Ÿæˆ¸ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼ãŠã‚ã§ã¨ã†ï¼ ğŸ‰";
      launchPetals();
    }else{
      completeMsg.textContent = "";
    }
  }

  function launchPetals(){
    for(let i=0;i<24;i++){
      const p=document.createElement("div");
      p.className="petal";
      p.textContent="ğŸŒ¸";
      p.style.left = Math.random()*100 + "vw";
      p.style.animationDuration = (3 + Math.random()*3) + "s";
      document.body.appendChild(p);
      setTimeout(()=>p.remove(), 7000);
    }
  }

  // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
  zukanBtn.addEventListener("click", ()=>{
    const active = !zukanPanel.classList.contains("active");
    zukanPanel.classList.toggle("active");
    zukanPanel.setAttribute("aria-hidden", active ? "false" : "true");
    zukanBtn.setAttribute("aria-expanded", String(active));
  });
  closeZukan.addEventListener("click", ()=>{
    zukanPanel.classList.remove("active");
    zukanPanel.setAttribute("aria-hidden","true");
    zukanBtn.setAttribute("aria-expanded","false");
  });
  chapterFilter.addEventListener("change", buildCards);

  // ãƒªã‚»ãƒƒãƒˆ
  resetBtn.addEventListener("click", ()=>{
    if(!confirm("é€²æ—ï¼ˆé–‹ã„ãŸã‚«ãƒ¼ãƒ‰ãƒ»ç”ºã¥ãã‚Šï¼‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    localStorage.removeItem(LS_KEY);
    for(const k in gotCards) delete gotCards[k];
    document.querySelectorAll("#town .building, #town .villager").forEach(el=>el.remove());
    infoBox.textContent = "ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã£ã¦æ±Ÿæˆ¸ã®ç”ºã‚’ç™ºå±•ã•ã›ã‚ˆã†ï¼ï¼ˆã‚¯ã‚¤ã‚ºã«ã²ã‚‰ãŒãªã§æ­£è§£ã™ã‚‹ã¨é–‹ãã‚ˆï¼‰";
    zukanPanel.classList.remove("active");
    zukanPanel.setAttribute("aria-hidden","true");
    zukanBtn.setAttribute("aria-expanded","false");
    buildCards();
    renderZukan();
    alert("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼");
  });

  // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
  quizOk.addEventListener("click", submitQuiz);
  quizCancel.addEventListener("click", closeQuiz);
  quizBg.addEventListener("click", closeQuiz);
  quizInput.addEventListener("keydown", (e)=>{
    if(e.key === "Enter") submitQuiz();
    if(e.key === "Escape") closeQuiz();
  });

  // ===== åˆæœŸæç”» =====
  buildCards();
  renderZukan();

  // ä¿å­˜å¾©å…ƒï¼ˆå»ºç‰©ï¼†ä½äººï¼‰
  for(const ch in chapters){
    for(const name in chapters[ch]){
      if(!gotCards[name]) continue;
      const item = chapters[ch][name];
      const b = document.createElement("div");
      b.className = "building show";
      b.textContent = item.icon;
      b.style.left = (Math.random()*80 + 5) + "%";
      b.style.top = (Math.random()*70 + 5) + "%";
      town.appendChild(b);
      const v = document.createElement("div");
      v.className = "villager";
      v.textContent = Math.random()>0.5 ? "ğŸ˜Š" : "ğŸ‘˜";
      v.style.top = Math.floor(Math.random()* (town.clientHeight-40)) + "px";
      town.appendChild(v);
    }
  }
</script>

<!--
  å›ºå®šã®ãƒãƒŠãƒ¼åºƒå‘Šã‚’ä½¿ã†å ´åˆã¯ã€.adslot ã®ä¸­èº«ã‚’ã‚ãªãŸã®åºƒå‘Šãƒ¦ãƒ‹ãƒƒãƒˆã«ç½®æ›ã—ã€
  ç›´å¾Œã§ (adsbygoogle = window.adsbygoogle || []).push({}); ã‚’å‘¼ã³å‡ºã—ã¦ãã ã•ã„ã€‚
-->

</body>
</html>
