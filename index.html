<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>連打ゲーム（通常）</title>
<style>
  :root { --bg:#0f1220; --fg:#fff; --accent:#5dd6ff; --card:#171b30; --muted:#9aa3b2; }
  * { -webkit-tap-highlight-color: rgba(0,0,0,0); }
  html, body { height:100%; -webkit-text-size-adjust:100%; overscroll-behavior:none; }
  body {
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;
    color:var(--fg); background:radial-gradient(1200px 800px at 50% -10%, #1b2040, var(--bg));
    display:grid; place-items:center; padding:16px;
  }
  body.lock { position:fixed; inset:0; width:100%; height:100%; overflow:hidden; -webkit-overflow-scrolling:auto; }
  .wrap { width:min(720px,100%); }
  header { text-align:center; margin-bottom:12px; }
  header h1 { margin:0 0 8px; font-size:clamp(20px,4vw,28px); }
  header p { margin:0; color:var(--muted); }
  .topbar { display:grid; grid-template-columns:1fr; gap:8px; margin-top:8px; }
  .namebox { background:var(--card); border-radius:12px; padding:10px 12px; display:flex; gap:8px; align-items:center; }
  .namebox label { color:var(--muted); font-size:14px; }
  .namebox input { flex:1; border:0; outline:none; background:#0f1426; color:#e9f4ff; border-radius:8px; padding:10px 12px; }
  .hud { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin:12px 0; }
  .card { background:var(--card); border-radius:16px; padding:12px 16px; display:flex; align-items:center; justify-content:center; min-height:58px;
    box-shadow:0 10px 30px rgba(0,0,0,.35); }
  .label { color:var(--muted); margin-right:8px; }
  .value { font-size:clamp(20px,6vw,36px); font-weight:700; letter-spacing:.5px; }
  .bigzone {
    position:relative; display:grid; place-items:center; width:100%; height:clamp(300px,68vh,620px);
    background:#111626; border-radius:24px; user-select:none; touch-action:none;
    box-shadow:inset 0 0 0 2px rgba(93,214,255,.15), 0 20px 50px rgba(0,0,0,.45);
  }
  .tap-btn { pointer-events:none; width:min(70vw,420px); height:min(70vw,420px); border-radius:9999px; background:linear-gradient(180deg,#2a315a,#1b2147);
    display:grid; place-items:center; box-shadow:0 16px 40px rgba(0,0,0,.5), inset 0 0 0 6px rgba(93,214,255,.25);
    transform:translateZ(0); transition:transform .06s ease; }
  .tap-btn span { font-size:clamp(20px,6vw,36px); font-weight:800; letter-spacing:.08em; color:var(--accent); }
  .bigzone.active .tap-btn { transform:scale(.98); }
  .controls { display:flex; gap:8px; margin:12px 0 0; flex-wrap:wrap; }
  .btn { appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:700; background:#283056; color:#e9f4ff; cursor:pointer; }
  .btn.accent { background:#2b9ed0; }
  .btn:disabled { opacity:.5; cursor:not-allowed; }

  /* ランキングモーダル */
  .modal { position:fixed; inset:0; display:none; place-items:center; background:rgba(5,7,12,.66); padding:20px; z-index:50; }
  .modal.open { display:grid; }
  .sheet { width:min(560px,100%); background:var(--card); border-radius:16px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.6); }
  .sheet h2 { margin:0 0 8px; }
  .ranklist { margin:12px 0 0; padding:0; list-style:none; max-height:60vh; overflow:auto; }
  .ranklist li { display:flex; justify-content:space-between; align-items:baseline; padding:10px 12px; border-radius:10px; }
  .ranklist li.me { background:rgba(93,214,255,.12); }
  .sheet .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
  a.mode-link { color:var(--accent); text-decoration:none; font-weight:700; }
  .note { color:var(--muted); font-size:12px; margin-top:6px; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>連打ゲーム（通常）</h1>
      <p>スマホ縦＆PC対応。大きい当たり判定でサクサク！</p>
    </header>

    <div class="topbar">
      <div class="namebox">
        <label for="nick">ニックネーム</label>
        <input id="nick" type="text" placeholder="例）しろながす" maxlength="20" />
      </div>
      <div class="note">※ ランキングはオンラインで共有されます</div>
    </div>

    <div class="hud">
      <div class="card"><span class="label">スコア</span><span id="score" class="value" aria-live="polite">0</span></div>
      <div class="card"><span class="label">状態</span><span id="state" class="value" aria-live="polite">待機中</span></div>
    </div>

    <div id="zone" class="bigzone" role="button" aria-label="ここを連打！">
      <div class="tap-btn"><span>ここを連打！</span></div>
    </div>

    <div class="controls">
      <button id="start" class="btn accent">開始</button>
      <button id="stop" class="btn" disabled>終了</button>
      <a href="./10second.html" class="btn">10秒チャレンジへ</a>
    </div>
  </div>

  <!-- ランキング -->
  <div id="modal" class="modal" aria-modal="true" role="dialog">
    <div class="sheet">
      <h2>ランキング（通常）</h2>
      <ol id="rank" class="ranklist"></ol>
      <div class="actions">
        <a class="mode-link" href="./10second.html">10秒チャレンジを見る</a>
        <button id="close" class="btn accent">閉じる</button>
      </div>
    </div>
  </div>

<!-- Firebase + ゲーム本体 -->
<script type="module">
/* ---------------- Firebase 初期化（提供いただいた設定） ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, push, query, orderByChild, limitToLast, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDhQ3DSg_AgZ-sK94usMkh54s0CJ8BFcK0",
  authDomain: "mygame-d583f-e218b.firebaseapp.com",
  databaseURL: "https://mygame-d583f-e218b-default-rtdb.firebaseio.com",
  projectId: "mygame-d583f-e218b",
  storageBucket: "mygame-d583f-e218b.firebasestorage.app",
  messagingSenderId: "112750475090",
  appId: "1:112750475090:web:fd177e17163f6face62c8b",
  measurementId: "G-CJLL8YF042"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getDatabase(app);

// 匿名サインイン（初回だけでもOK）
signInAnonymously(auth).catch(console.error);

/* ---------------- iOS Safari 追加対策 ---------------- */
const isIOS = (() => {
  const ua = navigator.userAgent || '';
  return /iP(ad|hone|od)/.test(ua) || (ua.includes('Mac') && 'ontouchend' in document);
})();
let iosTearDown = null;
function iosScrollZoomGuard(enable) {
  if (!isIOS) return;
  if (!enable && iosTearDown) { iosTearDown(); iosTearDown = null; return; }
  if (!enable) return;
  if (iosTearDown) return;
  const onGestureStart = (e) => { e.preventDefault(); };
  const onTouchMove = (e) => { if (e.touches && e.touches.length < 2) e.preventDefault(); };
  let lastTouchEnd = 0;
  const onTouchEnd = (e) => { const now = Date.now(); if (now - lastTouchEnd < 350) e.preventDefault(); lastTouchEnd = now; };
  const onWheel = (e) => { e.preventDefault(); };
  document.addEventListener('gesturestart', onGestureStart, { passive:false });
  document.addEventListener('touchmove', onTouchMove, { passive:false });
  document.addEventListener('touchend', onTouchEnd, { passive:false });
  document.addEventListener('wheel', onWheel, { passive:false });
  iosTearDown = () => {
    document.removeEventListener('gesturestart', onGestureStart, { passive:false });
    document.removeEventListener('touchmove', onTouchMove, { passive:false });
    document.removeEventListener('touchend', onTouchEnd, { passive:false });
    document.removeEventListener('wheel', onWheel, { passive:false });
  };
}

/* ---------------- DOM ---------------- */
const el = {
  zone:  document.getElementById('zone'),
  score: document.getElementById('score'),
  state: document.getElementById('state'),
  start: document.getElementById('start'),
  stop:  document.getElementById('stop'),
  modal: document.getElementById('modal'),
  rank:  document.getElementById('rank'),
  close: document.getElementById('close'),
  nick:  document.getElementById('nick'),
};

const NICK_KEY = 'nickname';
el.nick.value = localStorage.getItem(NICK_KEY) || '';
el.nick.addEventListener('change', () => {
  localStorage.setItem(NICK_KEY, el.nick.value.trim());
});

/* ---------------- ランキング（オンライン） ---------------- */
const MODE_KEY = 'free'; // DBパス: leaderboard/free
function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

async function submitScoreOnline(mode, v, n) {
  const payload = {
    v, n: (n || '匿名').slice(0,20), t: Date.now(),
    ua: (navigator.userAgent || '').slice(0,80)
  };
  const refPath = ref(db, `leaderboard/${mode}`);
  const res = await push(refPath, payload);
  return { id: res.key, ...payload };
}
async function fetchTopOnline(mode, top=10) {
  const q = query(ref(db, `leaderboard/${mode}`), orderByChild('v'), limitToLast(top));
  const snap = await get(q);
  const arr = [];
  snap.forEach(ch => arr.push({ id: ch.key, ...ch.val() }));
  arr.sort((a,b)=> b.v - a.v);
  return arr;
}
async function renderRank(me) {
  const list = await fetchTopOnline(MODE_KEY, 10);
  el.rank.innerHTML = list.map((r,i)=> {
    const mine = (me && r.id === me.id);
    return `<li class="${mine?'me':''}">
      <div>${i+1}. <strong>${r.v}</strong> 回 <small>（${escapeHtml(r.n||'匿名')}）</small></div>
      <small>${new Date(r.t).toLocaleString()}</small>
    </li>`;
  }).join('');
}
function openModal(me) { renderRank(me); el.modal.classList.add('open'); }

/* ---------------- ゲーム本体 ---------------- */
let status = 'idle'; // idle | playing | ended
let score = 0;
let lastFrame = -1;

function setState(s) {
  status = s;
  if (s === 'playing') { document.body.classList.add('lock'); iosScrollZoomGuard(true); }
  else { document.body.classList.remove('lock'); iosScrollZoomGuard(false); }
  el.state.textContent = (s === 'idle' ? '待機中' : s === 'playing' ? 'プレイ中' : '終了');
  el.start.disabled = (s !== 'idle');
  el.stop.disabled  = (s !== 'playing');
}

function startGame() {
  score = 0; el.score.textContent = '0'; lastFrame = -1;
  const name = (el.nick.value.trim() || '匿名'); localStorage.setItem(NICK_KEY, name);
  setState('playing');
}
async function finishGame() {
  setState('ended');
  const me = await submitScoreOnline(MODE_KEY, score, el.nick.value.trim() || '匿名');
  openModal(me);
}

// 入力（ゾーン全体が当たり判定／1フレーム1カウント）
el.zone.addEventListener('pointerdown', (e) => {
  if (status !== 'playing') return;
  e.preventDefault();
  el.zone.classList.add('active');
  const frame = Math.floor(performance.now() / 16.6667);
  if (frame === lastFrame) return;
  lastFrame = frame;
  score++; el.score.textContent = String(score);
});
['pointerup','pointercancel','pointerleave'].forEach(ev =>
  el.zone.addEventListener(ev, ()=> el.zone.classList.remove('active'))
);

el.start.addEventListener('click', startGame);
el.stop.addEventListener('click', finishGame);
el.close.addEventListener('click', () => el.modal.classList.remove('open'));

// 初期：ログイン状態がついたらランキング初期表示
onAuthStateChanged(auth, async () => { await renderRank(); });
setState('idle');
</script>
</body>
</html>

