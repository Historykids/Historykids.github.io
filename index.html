<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>連打ゲーム</title>
  <style>
    body { text-align: center; font-family: sans-serif; margin: 0; padding: 0; }
    h1 { font-size: 20px; }
    button { font-size: 20px; padding: 10px 20px; margin: 10px; }
    #game, #menu, #result { display: none; }
    #score { font-size: 30px; margin: 20px 0; }
    #timer { font-size: 18px; }
    #leaderboard { margin-top: 20px; font-size: 14px; }
  </style>
</head>
<body>

<!-- メニュー画面 -->
<h1>モード選択</h1>
<div id="menu">
  <button onclick="startGame('normal')">通常モード</button>
  <button onclick="startGame('10sec')">10秒チャレンジ</button>
</div>

<!-- ゲーム画面 -->
<div id="game">
  <h1 id="modeTitle"></h1>
  <input type="text" id="playerName" placeholder="名前を入力">
  <br><br>
  <button id="clickBtn">クリック！</button>
  <div id="score">スコア: 0</div>
  <div id="timer"></div>
  <button onclick="endGame()">終了</button>
</div>

<!-- 結果画面 -->
<div id="result">
  <h2>ランキング</h2>
  <div id="leaderboard">読み込み中...</div>
  <button onclick="backToMenu()">メニューに戻る</button>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  // あなたの Firebase 設定
  const firebaseConfig = {
    apiKey: "AIzaSyDhQ3DSg_AgZ-sK94usMkh54s0CJ8BFcK0",
    authDomain: "mygame-d583f-e218b.firebaseapp.com",
    databaseURL: "https://mygame-d583f-e218b-default-rtdb.firebaseio.com",
    projectId: "mygame-d583f-e218b",
    storageBucket: "mygame-d583f-e218b.firebasestorage.app",
    messagingSenderId: "112750475090",
    appId: "1:112750475090:web:fd177e17163f6face62c8b",
    measurementId: "G-CJLL8YF042"
  };

  // 初期化
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let score = 0;
  let mode = "normal";
  let timer = null;
  let timeLeft = 10;

  document.getElementById("menu").style.display = "block";

  function startGame(selectedMode) {
    mode = selectedMode;
    score = 0;
    timeLeft = 10;

    document.getElementById("menu").style.display = "none";
    document.getElementById("result").style.display = "none";
    document.getElementById("game").style.display = "block";
    document.getElementById("score").textContent = "スコア: 0";
    document.getElementById("modeTitle").textContent =
      mode === "normal" ? "通常モード" : "10秒チャレンジ";

    if (mode === "10sec") {
      document.getElementById("timer").textContent = "残り時間: 10秒";
      timer = setInterval(() => {
        timeLeft--;
        document.getElementById("timer").textContent = "残り時間: " + timeLeft + "秒";
        if (timeLeft <= 0) {
          clearInterval(timer);
          endGame();
        }
      }, 1000);
    } else {
      document.getElementById("timer").textContent = "";
    }
  }

  document.getElementById("clickBtn").addEventListener("click", () => {
    score++;
    document.getElementById("score").textContent = "スコア: " + score;

    if (mode === "normal") {
      saveScore(); // 通常モードはリアルタイム保存
    }
  });

  function endGame() {
    if (mode === "10sec") clearInterval(timer);
    saveScore();
    showResult();
  }

  function saveScore() {
    const name = document.getElementById("playerName").value.trim();
    if (!name) { alert("名前を入力してね！"); return; }

    const key = mode + "_" + name;
    set(ref(db, "scores/" + key), score);
  }

  function showResult() {
    document.getElementById("game").style.display = "none";
    document.getElementById("result").style.display = "block";
    loadLeaderboard();
  }

  function backToMenu() {
    document.getElementById("result").style.display = "none";
    document.getElementById("menu").style.display = "block";
  }

  function loadLeaderboard() {
    get(ref(db, "scores")).then(snapshot => {
      const data = snapshot.val();
      if (!data) { document.getElementById("leaderboard").innerHTML = "まだスコアがありません"; return; }

      let filtered = Object.entries(data)
        .filter(([k,v]) => k.startsWith(mode + "_"))
        .map(([k,v]) => [k.replace(mode + "_", ""), v]);

      const sorted = filtered.sort((a,b) => b[1] - a[1]);
      document.getElementById("leaderboard").innerHTML =
        sorted.map(([n,s]) => `${n}: ${s}`).join("<br>");
    });
  }

  // グローバルに公開
  window.startGame = startGame;
  window.endGame = endGame;
  window.backToMenu = backToMenu;
</script>

</body>
</html>

